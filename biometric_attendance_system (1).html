<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biometric Attendance Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            width: 100%;
            max-width: 800px;
            min-height: 600px;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .login-form, .admin-panel, .employee-panel {
            display: none;
        }

        .login-form.active, .admin-panel.active, .employee-panel.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }

        input, select, button {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #4f46e5;
        }

        button {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            margin-top: 10px;
        }

        .fingerprint-area {
            background: #f3f4f6;
            border: 3px dashed #d1d5db;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s;
        }

        .fingerprint-area.active {
            border-color: #4f46e5;
            background: #eef2ff;
        }

        .fingerprint-icon {
            font-size: 4rem;
            color: #6b7280;
            margin-bottom: 15px;
        }

        .fingerprint-area.active .fingerprint-icon {
            color: #4f46e5;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .employee-list {
            background: #f9fafb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .employee-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .employee-info {
            flex: 1;
        }

        .employee-name {
            font-weight: 600;
            color: #1f2937;
        }

        .employee-id {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .attendance-record {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .attendance-time {
            color: #0369a1;
            font-weight: 600;
        }

        .status-indicator {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-in {
            background: #dcfce7;
            color: #166534;
        }

        .status-out {
            background: #fee2e2;
            color: #991b1b;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .nav-btn {
            flex: 1;
            padding: 10px;
            background: #f3f4f6;
            color: #374151;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .nav-btn.active {
            background: #4f46e5;
            color: white;
        }

        .success-message, .error-message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
        }

        .success-message {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .time-display {
            text-align: center;
            font-size: 1.2rem;
            color: #4f46e5;
            margin: 20px 0;
        }

        @media (max-width: 600px) {
            .container {
                margin: 10px;
                max-width: calc(100% - 20px);
            }
            
            .content {
                padding: 20px;
            }
            
            .nav-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Biometric Attendance System</h1>
            <p>Secure Fingerprint-Based Employee Management</p>
        </div>

        <div class="content">
            <!-- Login Form -->
            <div class="login-form active">
                <h2>Admin Login</h2>
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter password">
                </div>
                <button onclick="adminLogin()">Login to Admin Panel</button>
                <button class="btn-secondary" onclick="showEmployeePanel()">Employee Attendance</button>
            </div>

            <!-- Admin Panel -->
            <div class="admin-panel">
                <div class="nav-buttons">
                    <button class="nav-btn active" onclick="showAddEmployee()">Add Employee</button>
                    <button class="nav-btn" onclick="showEmployeeList()">Employee List</button>
                    <button class="nav-btn" onclick="showAttendanceRecords()">Attendance Records</button>
                    <button class="nav-btn" onclick="logout()">Logout</button>
                </div>

                <!-- Add Employee Section -->
                <div id="add-employee-section">
                    <h3>Add New Employee</h3>
                    <div class="form-group">
                        <label for="emp-name">Employee Name</label>
                        <input type="text" id="emp-name" placeholder="Enter full name">
                    </div>
                    <div class="form-group">
                        <label for="emp-id">Employee ID</label>
                        <input type="text" id="emp-id" placeholder="Enter employee ID">
                    </div>
                    <div class="form-group">
                        <label for="emp-department">Department</label>
                        <select id="emp-department">
                            <option value="">Select Department</option>
                            <option value="HR">Human Resources</option>
                            <option value="IT">Information Technology</option>
                            <option value="Finance">Finance</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Operations">Operations</option>
                        </select>
                    </div>
                    
                    <div class="fingerprint-area" id="fingerprint-register">
                        <div class="fingerprint-icon">üëÜ</div>
                        <h4>Register Fingerprint</h4>
                        <p>Click to scan and register employee's fingerprint</p>
                    </div>
                    
                    <button onclick="registerEmployee()">Register Employee</button>
                </div>

                <!-- Employee List Section -->
                <div id="employee-list-section" style="display: none;">
                    <h3>Employee Directory</h3>
                    <div class="employee-list" id="employee-list">
                        <!-- Employee list will be populated here -->
                    </div>
                </div>

                <!-- Attendance Records Section -->
                <div id="attendance-records-section" style="display: none;">
                    <h3>Attendance Records</h3>
                    <div class="form-group">
                        <label for="date-filter">Filter by Date</label>
                        <input type="date" id="date-filter" onchange="filterAttendance()">
                    </div>
                    <div id="attendance-list">
                        <!-- Attendance records will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Employee Panel -->
            <div class="employee-panel">
                <h2>Employee Attendance</h2>
                <div class="time-display" id="current-time"></div>
                
                <div class="fingerprint-area" id="fingerprint-scan">
                    <div class="fingerprint-icon">üëÜ</div>
                    <h4>Scan Fingerprint</h4>
                    <p>Place your finger on the sensor to mark attendance</p>
                </div>
                
                <div id="attendance-status"></div>
                
                <button class="btn-secondary" onclick="showLoginForm()">Back to Login</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let employees = JSON.parse(localStorage.getItem('employees')) || [];
        let attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
        let currentEmployee = null;

        // WebAuthn support check
        const isWebAuthnSupported = () => {
            return window.PublicKeyCredential && 
                   navigator.credentials && 
                   navigator.credentials.create;
        };

        // Check for biometric support
        const isBiometricSupported = async () => {
            if (!isWebAuthnSupported()) return false;
            
            try {
                const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                return available;
            } catch (error) {
                console.error('Error checking biometric support:', error);
                return false;
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Check biometric support
            const biometricAvailable = await isBiometricSupported();
            if (!biometricAvailable) {
                showMessage('‚ö†Ô∏è Biometric authentication not available. Please ensure you have fingerprint/face unlock enabled on your device and are using HTTPS.', 'error');
            } else {
                console.log('‚úÖ Biometric authentication available');
            }
        });

        // Time display
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString();
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = `Current Time: ${timeString}`;
            }
        }

        // Navigation functions
        function showLoginForm() {
            hideAllPanels();
            document.querySelector('.login-form').classList.add('active');
        }

        function showEmployeePanel() {
            hideAllPanels();
            document.querySelector('.employee-panel').classList.add('active');
        }

        function hideAllPanels() {
            document.querySelectorAll('.login-form, .admin-panel, .employee-panel').forEach(panel => {
                panel.classList.remove('active');
            });
        }

        // Admin login
        function adminLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === 'Siddhant' && password === '102005') {
                hideAllPanels();
                document.querySelector('.admin-panel').classList.add('active');
                showMessage('Login successful! Welcome to Admin Panel.', 'success');
                loadEmployeeList();
            } else {
                showMessage('Invalid credentials. Please try again.', 'error');
            }
        }

        // Logout
        function logout() {
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            showLoginForm();
            showMessage('Logged out successfully.', 'success');
        }

        // Admin panel navigation
        function showAddEmployee() {
            setActiveNavButton(0);
            hideAllSections();
            document.getElementById('add-employee-section').style.display = 'block';
        }

        function showEmployeeList() {
            setActiveNavButton(1);
            hideAllSections();
            document.getElementById('employee-list-section').style.display = 'block';
            loadEmployeeList();
        }

        function showAttendanceRecords() {
            setActiveNavButton(2);
            hideAllSections();
            document.getElementById('attendance-records-section').style.display = 'block';
            loadAttendanceRecords();
        }

        function setActiveNavButton(index) {
            document.querySelectorAll('.nav-btn').forEach((btn, i) => {
                if (i === index) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function hideAllSections() {
            document.querySelectorAll('#add-employee-section, #employee-list-section, #attendance-records-section').forEach(section => {
                section.style.display = 'none';
            });
        }

        // Real WebAuthn biometric registration
        async function registerFingerprint(employeeName, employeeId) {
            const biometricAvailable = await isBiometricSupported();
            if (!biometricAvailable) {
                throw new Error('Biometric authentication not supported on this device');
            }

            try {
                // Generate a unique challenge
                const challenge = new Uint8Array(32);
                crypto.getRandomValues(challenge);

                // Create unique user ID for this employee
                const userId = new TextEncoder().encode(`emp_${employeeId}_${Date.now()}`);

                const publicKeyCredentialCreationOptions = {
                    challenge: challenge,
                    rp: {
                        name: "Biometric Attendance System",
                        id: window.location.hostname || "localhost",
                    },
                    user: {
                        id: userId,
                        name: employeeId,
                        displayName: employeeName,
                    },
                    pubKeyCredParams: [
                        { alg: -7, type: "public-key" },  // ES256
                        { alg: -35, type: "public-key" }, // ES384
                        { alg: -36, type: "public-key" }, // ES512
                        { alg: -257, type: "public-key" } // RS256
                    ],
                    authenticatorSelection: {
                        authenticatorAttachment: "platform", // Use built-in biometric sensors
                        userVerification: "required",        // Require biometric verification
                        requireResidentKey: true,           // Store credential on device
                        residentKey: "required"
                    },
                    timeout: 120000, // 2 minutes timeout
                    attestation: "direct"
                };

                console.log('Creating biometric credential for:', employeeName);
                const credential = await navigator.credentials.create({
                    publicKey: publicKeyCredentialCreationOptions
                });

                if (!credential) {
                    throw new Error('Failed to create biometric credential');
                }

                // Store the credential data
                const credentialData = {
                    id: credential.id,
                    rawId: Array.from(new Uint8Array(credential.rawId)),
                    type: credential.type,
                    employeeId: employeeId,
                    employeeName: employeeName,
                    createdAt: new Date().toISOString(),
                    publicKey: Array.from(new Uint8Array(credential.response.getPublicKey ? credential.response.getPublicKey() : [])),
                    counter: credential.response.getAuthenticatorData ? 
                        new DataView(credential.response.getAuthenticatorData()).getUint32(33, false) : 0
                };

                return credentialData;

            } catch (error) {
                console.error('Biometric registration failed:', error);
                
                if (error.name === 'NotAllowedError') {
                    throw new Error('Biometric access denied. Please allow biometric authentication and try again.');
                } else if (error.name === 'InvalidStateError') {
                    throw new Error('This fingerprint is already registered. Please use a different finger or remove existing registration.');
                } else if (error.name === 'NotSupportedError') {
                    throw new Error('Biometric authentication not supported on this device.');
                } else {
                    throw new Error(`Biometric registration failed: ${error.message}`);
                }
            }
        }

        // Real WebAuthn biometric authentication
        async function authenticateFingerprint() {
            const biometricAvailable = await isBiometricSupported();
            if (!biometricAvailable) {
                throw new Error('Biometric authentication not supported on this device');
            }

            if (employees.length === 0) {
                throw new Error('No employees registered for biometric authentication');
            }

            try {
                // Get all registered credentials
                const allowCredentials = employees
                    .filter(emp => emp.biometricData && emp.biometricData.rawId)
                    .map(emp => ({
                        id: new Uint8Array(emp.biometricData.rawId),
                        type: "public-key",
                        transports: ["internal"] // Platform authenticator
                    }));

                if (allowCredentials.length === 0) {
                    throw new Error('No biometric credentials found. Please register employees first.');
                }

                const challenge = new Uint8Array(32);
                crypto.getRandomValues(challenge);

                const publicKeyCredentialRequestOptions = {
                    challenge: challenge,
                    allowCredentials: allowCredentials,
                    timeout: 60000,
                    userVerification: "required",
                    rpId: window.location.hostname || "localhost"
                };

                console.log('Requesting biometric authentication...');
                const assertion = await navigator.credentials.get({
                    publicKey: publicKeyCredentialRequestOptions
                });

                if (!assertion) {
                    throw new Error('Biometric authentication failed');
                }

                // Find the employee by credential ID
                const credentialIdArray = Array.from(new Uint8Array(assertion.rawId));
                const employee = employees.find(emp => 
                    emp.biometricData && 
                    emp.biometricData.rawId &&
                    arraysEqual(emp.biometricData.rawId, credentialIdArray)
                );

                if (!employee) {
                    throw new Error('Employee not found for this biometric');
                }

                return {
                    employee: employee,
                    credentialId: assertion.id,
                    timestamp: new Date().toISOString(),
                    verified: true
                };

            } catch (error) {
                console.error('Biometric authentication failed:', error);
                
                if (error.name === 'NotAllowedError') {
                    throw new Error('Biometric authentication cancelled or denied.');
                } else if (error.name === 'InvalidStateError') {
                    throw new Error('Invalid biometric state. Please try again.');
                } else {
                    throw new Error(`Authentication failed: ${error.message}`);
                }
            }
        }

        // Helper function to compare arrays
        function arraysEqual(arr1, arr2) {
            if (arr1.length !== arr2.length) return false;
            for (let i = 0; i < arr1.length; i++) {
                if (arr1[i] !== arr2[i]) return false;
            }
            return true;
        }

        // Register employee with real biometric data
        async function registerEmployee() {
            const name = document.getElementById('emp-name').value;
            const empId = document.getElementById('emp-id').value;
            const department = document.getElementById('emp-department').value;

            if (!name || !empId || !department) {
                showMessage('Please fill all fields.', 'error');
                return;
            }

            // Check if employee ID already exists
            if (employees.find(emp => emp.id === empId)) {
                showMessage('Employee ID already exists.', 'error');
                return;
            }

            // Check biometric support before proceeding
            const biometricAvailable = await isBiometricSupported();
            if (!biometricAvailable) {
                showMessage('‚ùå Biometric authentication not available. Please enable fingerprint/face unlock on your device and use HTTPS.', 'error');
                return;
            }

            // Show fingerprint scanning animation
            const fingerprintArea = document.getElementById('fingerprint-register');
            fingerprintArea.classList.add('active');
            fingerprintArea.innerHTML = `
                <div class="fingerprint-icon">üëÜ</div>
                <h4>üîí Registering Real Biometric...</h4>
                <p>Please place your finger on the sensor or authenticate with your device biometric</p>
                <small>This will use your device's actual fingerprint/face sensor</small>
            `;

            try {
                console.log(`Starting biometric registration for ${name} (${empId})`);
                const biometricData = await registerFingerprint(name, empId);
                
                const employee = {
                    id: empId,
                    name: name,
                    department: department,
                    biometricData: biometricData, // Store actual biometric credential data
                    fingerprintId: biometricData.id, // Keep for backward compatibility
                    registeredAt: new Date().toISOString()
                };

                employees.push(employee);
                localStorage.setItem('employees', JSON.stringify(employees));

                // Reset form
                document.getElementById('emp-name').value = '';
                document.getElementById('emp-id').value = '';
                document.getElementById('emp-department').value = '';
                
                fingerprintArea.classList.remove('active');
                fingerprintArea.innerHTML = `
                    <div class="fingerprint-icon">‚úÖ</div>
                    <h4>‚úÖ Biometric Registered Successfully!</h4>
                    <p>Employee ${name} can now use biometric authentication</p>
                `;

                // Reset after 3 seconds
                setTimeout(() => {
                    fingerprintArea.innerHTML = `
                        <div class="fingerprint-icon">üëÜ</div>
                        <h4>Register Fingerprint</h4>
                        <p>Click to scan and register employee's fingerprint</p>
                    `;
                }, 3000);

                showMessage(`‚úÖ Employee ${name} registered successfully with real biometric data!`, 'success');
                
            } catch (error) {
                fingerprintArea.classList.remove('active');
                fingerprintArea.innerHTML = `
                    <div class="fingerprint-icon">‚ùå</div>
                    <h4>Registration Failed</h4>
                    <p>Click to try again</p>
                `;
                
                console.error('Biometric registration error:', error);
                showMessage(`‚ùå ${error.message}`, 'error');
                
                // Reset after 3 seconds
                setTimeout(() => {
                    fingerprintArea.innerHTML = `
                        <div class="fingerprint-icon">üëÜ</div>
                        <h4>Register Fingerprint</h4>
                        <p>Click to scan and register employee's fingerprint</p>
                    `;
                }, 3000);
            }
        }

        // Load employee list with biometric status
        function loadEmployeeList() {
            const listContainer = document.getElementById('employee-list');
            
            if (employees.length === 0) {
                listContainer.innerHTML = '<p>No employees registered yet.</p>';
                return;
            }

            listContainer.innerHTML = employees.map(employee => {
                const biometricStatus = employee.biometricData && employee.biometricData.id ? 
                    'üîí Real Biometric Registered' : '‚ùå No Biometric';
                const statusClass = employee.biometricData && employee.biometricData.id ? 
                    'status-indicator' : 'status-indicator status-out';
                
                return `
                    <div class="employee-item">
                        <div class="employee-info">
                            <div class="employee-name">${employee.name}</div>
                            <div class="employee-id">ID: ${employee.id} | ${employee.department}</div>
                            <div class="employee-id">Registered: ${new Date(employee.registeredAt).toLocaleDateString()}</div>
                        </div>
                        <div class="${statusClass}">${biometricStatus}</div>
                    </div>
                `;
            }).join('');
        }

        // Employee attendance with real biometric authentication
        async function markAttendance() {
            const fingerprintArea = document.getElementById('fingerprint-scan');
            const statusDiv = document.getElementById('attendance-status');

            // Check if any employees are registered
            if (employees.length === 0) {
                statusDiv.innerHTML = `
                    <div class="error-message">
                        No employees registered. Please contact HR to register employees first.
                    </div>
                `;
                return;
            }

            // Check biometric support
            const biometricAvailable = await isBiometricSupported();
            if (!biometricAvailable) {
                statusDiv.innerHTML = `
                    <div class="error-message">
                        ‚ùå Biometric authentication not available on this device. Please enable fingerprint/face unlock and use HTTPS.
                    </div>
                `;
                return;
            }

            fingerprintArea.classList.add('active');
            fingerprintArea.innerHTML = `
                <div class="fingerprint-icon">üëÜ</div>
                <h4>üîí Scanning Real Biometric...</h4>
                <p>Please authenticate with your device biometric sensor</p>
                <small>Using actual fingerprint/face recognition</small>
            `;

            try {
                console.log('Starting biometric authentication for attendance...');
                const authResult = await authenticateFingerprint();
                
                if (!authResult.verified || !authResult.employee) {
                    throw new Error('Biometric authentication failed');
                }

                const employee = authResult.employee;
                const now = new Date();
                const today = now.toDateString();
                const time = now.toLocaleTimeString();

                console.log(`Authenticated employee: ${employee.name} (${employee.id})`);

                // Check if already punched in today
                const todayRecords = attendanceRecords.filter(record => 
                    record.employeeId === employee.id && 
                    new Date(record.date).toDateString() === today
                );

                let action, message;
                
                if (todayRecords.length === 0) {
                    // First punch - Punch In
                    action = 'in';
                    message = `üåÖ Good morning, ${employee.name}! Successfully punched in at ${time}`;
                    
                    const attendanceRecord = {
                        employeeId: employee.id,
                        employeeName: employee.name,
                        department: employee.department,
                        date: now.toISOString(),
                        punchIn: time,
                        punchInTime: now.toISOString(),
                        punchOut: null,
                        punchOutTime: null,
                        biometricVerified: true
                    };
                    attendanceRecords.push(attendanceRecord);
                    
                } else if (todayRecords.length === 1 && todayRecords[0].punchIn && !todayRecords[0].punchOut) {
                    // Second punch - Punch Out
                    action = 'out';
                    message = `üåÜ Good evening, ${employee.name}! Successfully punched out at ${time}`;
                    
                    // Update existing record
                    const existingRecord = attendanceRecords.find(record => 
                        record.employeeId === employee.id && 
                        new Date(record.date).toDateString() === today
                    );
                    existingRecord.punchOut = time;
                    existingRecord.punchOutTime = now.toISOString();
                    
                } else {
                    throw new Error(`${employee.name}, you have already completed attendance for today.`);
                }

                localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));

                // Calculate work hours if punching out
                let workHours = '';
                if (action === 'out') {
                    const punchInTime = new Date(todayRecords[0].punchInTime);
                    const punchOutTime = now;
                    const diffMs = punchOutTime - punchInTime;
                    const hours = Math.floor(diffMs / (1000 * 60 * 60));
                    const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                    workHours = `<br><small>‚è±Ô∏è Total work time: ${hours}h ${minutes}m</small>`;
                }

                statusDiv.innerHTML = `
                    <div class="success-message">
                        ‚úÖ ${message}${workHours}
                        <br><small>üîí Verified with biometric authentication</small>
                    </div>
                `;

            } catch (error) {
                console.error('Attendance marking failed:', error);
                statusDiv.innerHTML = `
                    <div class="error-message">
                        ‚ùå ${error.message}
                    </div>
                `;
            }

            fingerprintArea.classList.remove('active');
            fingerprintArea.innerHTML = `
                <div class="fingerprint-icon">üëÜ</div>
                <h4>Scan Fingerprint</h4>
                <p>Place your finger on the sensor to mark attendance</p>
            `;
        }

        // Load attendance records
        function loadAttendanceRecords() {
            const attendanceList = document.getElementById('attendance-list');
            
            if (attendanceRecords.length === 0) {
                attendanceList.innerHTML = '<p>No attendance records found.</p>';
                return;
            }

            const sortedRecords = [...attendanceRecords].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );

            attendanceList.innerHTML = sortedRecords.map(record => `
                <div class="attendance-record">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="employee-name">${record.employeeName}</div>
                            <div class="employee-id">ID: ${record.employeeId}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="attendance-time">${new Date(record.date).toDateString()}</div>
                            <div>
                                <span class="status-indicator status-in">In: ${record.punchIn || 'N/A'}</span>
                                <span class="status-indicator status-out">Out: ${record.punchOut || 'Pending'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Filter attendance by date
        function filterAttendance() {
            const selectedDate = document.getElementById('date-filter').value;
            if (!selectedDate) {
                loadAttendanceRecords();
                return;
            }

            const filteredRecords = attendanceRecords.filter(record => 
                new Date(record.date).toDateString() === new Date(selectedDate).toDateString()
            );

            const attendanceList = document.getElementById('attendance-list');
            
            if (filteredRecords.length === 0) {
                attendanceList.innerHTML = `<p>No attendance records found for ${selectedDate}.</p>`;
                return;
            }

            attendanceList.innerHTML = filteredRecords.map(record => `
                <div class="attendance-record">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="employee-name">${record.employeeName}</div>
                            <div class="employee-id">ID: ${record.employeeId}</div>
                        </div>
                        <div style="text-align: right;">
                            <div>
                                <span class="status-indicator status-in">In: ${record.punchIn || 'N/A'}</span>
                                <span class="status-indicator status-out">Out: ${record.punchOut || 'Pending'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Utility function to show messages
        function showMessage(message, type) {
            // Remove existing messages
            document.querySelectorAll('.success-message, .error-message').forEach(msg => {
                if (!msg.closest('#attendance-status')) {
                    msg.remove();
                }
            });

            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;

            const activePanel = document.querySelector('.login-form.active, .admin-panel.active, .employee-panel.active');
            if (activePanel) {
                activePanel.insertBefore(messageDiv, activePanel.firstChild);
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    messageDiv.remove();
                }, 5000);
            }
        }

        // Add fingerprint area click handlers
        document.getElementById('fingerprint-register')?.addEventListener('click', function() {
            const name = document.getElementById('emp-name').value;
            const empId = document.getElementById('emp-id').value;
            const department = document.getElementById('emp-department').value;

            if (!name || !empId || !department) {
                showMessage('Please fill all employee details first.', 'error');
                return;
            }
            
            registerEmployee();
        });

        // Employee attendance
        document.getElementById('fingerprint-scan')?.addEventListener('click', markAttendance);

        // Show requirements on page load
        window.addEventListener('load', function() {
            setTimeout(() => {
                showMessage('üì± For real biometric functionality: 1) Enable fingerprint/face unlock on your device, 2) Use HTTPS (not file://), 3) Grant biometric permissions when prompted', 'success');
            }, 2000);
        });
    </script>
</body>
</html>