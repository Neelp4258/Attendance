<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ambivare Solutions - Attendance Management</title>
    
    <!-- External Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* CSS Styles - Corporate Theme */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f9f6f2;
            color: #333;
            line-height: 1.6;
        }

        /* Login Page Styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f9f6f2 0%, #fff 100%);
        }

        .login-card {
            background: white;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            border: 1px solid #e5e5e5;
        }

        .logo {
            text-align: center;
            margin-bottom: 2rem;
        }

        .logo h1 {
            color: #2c3e50;
            font-weight: 700;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .logo p {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .login-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e5e5e5;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #666;
        }

        .tab-btn.active {
            background: #2c3e50;
            color: white;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2c3e50;
            box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: #2c3e50;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .login-btn:hover {
            background: #34495e;
        }

        /* Dashboard Styles */
        .dashboard {
            display: none;
            min-height: 100vh;
        }

        .dashboard-header {
            background: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-header h1 {
            color: #2c3e50;
            font-size: 1.5rem;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: #2c3e50;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .logout-btn {
            padding: 8px 16px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .dashboard-content {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e5e5e5;
            padding: 2rem 0;
        }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-nav li {
            margin-bottom: 0.5rem;
        }

        .sidebar-nav a {
            display: block;
            padding: 12px 2rem;
            color: #666;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .sidebar-nav a:hover,
        .sidebar-nav a.active {
            background: #f8f9fa;
            color: #2c3e50;
            border-left-color: #2c3e50;
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .card {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
            border: 1px solid #e5e5e5;
        }

        .card h2 {
            margin-bottom: 1.5rem;
            color: #2c3e50;
            font-size: 1.4rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #2c3e50;
            color: white;
        }

        .btn-primary:hover {
            background: #34495e;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e5e5;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* QR Code Styles */
        .qr-container {
            text-align: center;
            margin: 2rem 0;
        }

        #qr-reader {
            width: 100%;
            max-width: 400px;
            margin: 1rem auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e5e5e5;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                order: 2;
                padding: 1rem 0;
            }

            .sidebar-nav {
                display: flex;
                overflow-x: auto;
                padding: 0 1rem;
                gap: 0.5rem;
            }

            .sidebar-nav li {
                margin-bottom: 0;
                flex-shrink: 0;
            }

            .sidebar-nav a {
                padding: 8px 16px;
                border-radius: 6px;
                border-left: none;
                white-space: nowrap;
                font-size: 0.9rem;
            }

            .sidebar-nav a:hover,
            .sidebar-nav a.active {
                background: #2c3e50;
                color: white;
                border-left: none;
            }

            .main-content {
                order: 1;
                padding: 1rem;
                width: 100%;
            }

            .form-row {
                flex-direction: column;
                gap: 0.5rem;
            }

            .dashboard-header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .dashboard-header h1 {
                font-size: 1.2rem;
            }

            .user-profile {
                justify-content: center;
            }

            .login-card {
                margin: 1rem;
                padding: 1.5rem;
                max-width: none;
            }

            .logo h1 {
                font-size: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-number {
                font-size: 1.5rem;
            }

            .card {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .card h2 {
                font-size: 1.2rem;
                margin-bottom: 1rem;
            }

            table {
                font-size: 0.8rem;
            }

            th, td {
                padding: 8px 4px;
            }

            .btn {
                padding: 8px 16px;
                font-size: 0.9rem;
            }

            .scan-btn {
                font-size: 1rem;
                padding: 0.8rem 1.5rem;
            }

            #qr-reader {
                max-width: 300px;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .login-card {
                margin: 0.5rem;
                padding: 1rem;
            }

            .dashboard-header {
                padding: 0.5rem;
            }

            .main-content {
                padding: 0.5rem;
            }

            .card {
                padding: 0.8rem;
            }

            table {
                font-size: 0.7rem;
            }

            th, td {
                padding: 6px 2px;
            }

            .form-group input,
            .form-group select {
                padding: 10px;
            }
        }

        /* Loading and Alert Styles */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none !important;
        }

        /* Employee Dashboard Specific */
        .employee-dashboard .sidebar {
            display: none;
        }

        .employee-dashboard .main-content {
            width: 100%;
        }

        .scan-section {
            text-align: center;
            padding: 1.5rem;
        }

        .scan-btn {
            font-size: 1.1rem;
            padding: 1rem 2rem;
            margin: 1rem 0.5rem;
            min-width: 180px;
        }

        #qr-reader {
            margin: 1rem auto;
            max-width: 400px;
            width: 100%;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            min-height: 300px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #qr-reader video {
            width: 100% !important;
            height: auto !important;
            max-width: 400px;
            border-radius: 8px;
            display: block !important;
            background: black;
            object-fit: cover;
        }

        #qr-reader canvas {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            border-radius: 8px;
            z-index: 10 !important;
            pointer-events: none;
        }

        /* Ensure proper stacking of video and canvas */
        #qr-reader > div {
            position: relative !important;
            width: 100% !important;
            height: 100% !important;
        }

        /* Hide file input elements completely */
        #qr-reader input[type="file"],
        #qr-reader .html5-qrcode-element,
        #qr-reader button[style*="file"] {
            display: none !important;
            visibility: hidden !important;
        }

        /* Mobile specific adjustments */
        @media (max-width: 480px) {
            #qr-reader {
                max-width: 320px;
                min-height: 250px;
            }
        }

        #scanResult {
            margin-top: 1rem;
        }

        @media (max-width: 480px) {
            .scan-section {
                padding: 1rem;
            }

            .scan-btn {
                font-size: 1rem;
                padding: 0.8rem 1.5rem;
                margin: 0.5rem 0.25rem;
                min-width: 150px;
                display: block;
                width: 100%;
                max-width: 200px;
                margin: 0.5rem auto;
            }

            #qr-reader {
                max-width: 280px;
            }

            .dashboard-header h1 {
                font-size: 1rem;
            }

            .user-profile {
                flex-direction: column;
                gap: 0.5rem;
            }

            .user-avatar {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="logo">
                <h1>Ambivare Solutions</h1>
                <p>Attendance Management System</p>
            </div>
            
            <div class="login-tabs">
                <button class="tab-btn active" onclick="switchTab('admin')">Admin</button>
                <button class="tab-btn" onclick="switchTab('employee')">Employee</button>
            </div>

            <!-- Admin Login Form -->
            <form id="adminLogin" class="login-form">
                <div class="form-group">
                    <label for="adminUsername">Username</label>
                    <input type="text" id="adminUsername" required>
                </div>
                <div class="form-group">
                    <label for="adminId">Admin ID</label>
                    <input type="text" id="adminId" required>
                </div>
                <button type="submit" class="login-btn">Login as Admin</button>
            </form>

            <!-- Employee Login Form -->
            <form id="employeeLogin" class="login-form hidden">
                <div class="form-group">
                    <label for="employeeId">Employee ID</label>
                    <input type="text" id="employeeId" required>
                </div>
                <button type="submit" class="login-btn">Login as Employee</button>
            </form>

            <div id="loginAlert"></div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="dashboard">
        <header class="dashboard-header">
            <h1>Admin Dashboard - Ambivare Solutions</h1>
            <div class="user-profile">
                <div class="user-avatar" id="adminAvatar">S</div>
                <span id="adminName">Welcome back, Siddhant</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="dashboard-content">
            <aside class="sidebar">
                <nav>
                    <ul class="sidebar-nav">
                        <li><a href="#" class="nav-link active" data-section="dashboard">Dashboard</a></li>
                        <li><a href="#" class="nav-link" data-section="addEmployee">Add Employee</a></li>
                        <li><a href="#" class="nav-link" data-section="generateQR">Generate QR Code</a></li>
                        <li><a href="#" class="nav-link" data-section="viewAttendance">View Attendance</a></li>
                        <li><a href="#" class="nav-link" data-section="reports">Reports & Analytics</a></li>
                    </ul>
                </nav>
            </aside>

            <main class="main-content">
                <!-- Dashboard Overview -->
                <section id="dashboard" class="content-section active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalEmployees">0</div>
                            <div class="stat-label">Total Employees</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="presentToday">0</div>
                            <div class="stat-label">Present Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="absentToday">0</div>
                            <div class="stat-label">Absent Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="attendanceRate">0%</div>
                            <div class="stat-label">Attendance Rate</div>
                        </div>
                    </div>

                    <div class="card">
                        <h2>Recent Activity</h2>
                        <div id="recentActivity" class="loading">Loading recent activity...</div>
                    </div>
                </section>

                <!-- Add Employee -->
                <section id="addEmployee" class="content-section">
                    <div class="card">
                        <h2>Add New Employee</h2>
                        <form id="addEmployeeForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="empName">Employee Name</label>
                                    <input type="text" id="empName" required>
                                </div>
                                <div class="form-group">
                                    <label for="empId">Employee ID</label>
                                    <input type="text" id="empId" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="empEmail">Email</label>
                                    <input type="email" id="empEmail" required>
                                </div>
                                <div class="form-group">
                                    <label for="empDesignation">Designation</label>
                                    <input type="text" id="empDesignation" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Employee</button>
                        </form>
                    </div>

                    <div class="card">
                        <h2>Employee List</h2>
                        <div class="table-container">
                            <table id="employeeTable">
                                <thead>
                                    <tr>
                                        <th>Employee ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Designation</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Employee data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Generate QR Code -->
                <section id="generateQR" class="content-section">
                    <div class="card">
                        <h2>Generate Universal QR Code</h2>
                        <p>Generate a single QR code that can be used by all employees for attendance marking.</p>
                        <button onclick="generateUniversalQR()" class="btn btn-primary">Generate Universal QR Code</button>
                        
                        <div id="qrDisplay" class="qr-container hidden">
                            <h3>Universal Attendance QR Code</h3>
                            <canvas id="qrCanvas"></canvas>
                            <p>This QR code can be used by all employees for check-in/check-out.</p>
                            <p style="color: #e74c3c; font-weight: 500;">⚠️ Keep this QR code secure and display it only in authorized areas.</p>
                            <button onclick="downloadQR()" class="btn btn-success">Download QR Code</button>
                            <button onclick="refreshQR()" class="btn btn-warning">Refresh QR Code</button>
                        </div>
                    </div>

                    <div class="card">
                        <h2>QR Code Management</h2>
                        <div id="qrStatus">
                            <p>Loading QR code status...</p>
                        </div>
                    </div>
                </section>

                <!-- View Attendance -->
                <section id="viewAttendance" class="content-section">
                    <div class="card">
                        <h2>Attendance Records</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="attendanceEmployeeFilter">Filter by Employee</label>
                                <select id="attendanceEmployeeFilter" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="">All Employees</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="attendanceDateFilter">Filter by Date</label>
                                <input type="date" id="attendanceDateFilter" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                        </div>
                        <button onclick="loadAttendanceData()" class="btn btn-primary">Load Attendance</button>
                        
                        <div class="table-container">
                            <table id="attendanceTable">
                                <thead>
                                    <tr>
                                        <th>Employee ID</th>
                                        <th>Employee Name</th>
                                        <th>Date</th>
                                        <th>Check In</th>
                                        <th>Check Out</th>
                                        <th>Total Hours</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Attendance data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Reports & Analytics -->
                <section id="reports" class="content-section">
                    <div class="card">
                        <h2>Reports & Analytics</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="reportEmployeeSelect">Select Employee for Individual Report</label>
                                <select id="reportEmployeeSelect" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="">Select an employee...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="reportDateRange">Date Range</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="date" id="reportStartDate" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                    <input type="date" id="reportEndDate" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <button onclick="generateIndividualReport()" class="btn btn-success">Generate Individual Report</button>
                            <button onclick="generateOverallReport()" class="btn btn-warning">Generate Overall Analytics</button>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Employee Dashboard -->
    <div id="employeeDashboard" class="dashboard employee-dashboard">
        <header class="dashboard-header">
            <h1>Employee Portal - Ambivare Solutions</h1>
            <div class="user-profile">
                <div class="user-avatar" id="employeeAvatar">E</div>
                <span id="employeeName">Welcome back, Employee</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="dashboard-content">
            <main class="main-content">
                <!-- QR Scanner Section -->
                <div class="card">
                    <h2>Attendance Check-In/Out</h2>
                    <div class="scan-section">
                        <p><strong>📱 Camera Scanning Required</strong></p>
                        <p>Use your device camera to scan the QR code provided by your admin to mark attendance</p>
                        <button id="startScanBtn" onclick="startQRScanner()" class="btn btn-primary scan-btn">Start Camera Scanner</button>
                        <button id="stopScanBtn" onclick="stopQRScanner()" class="btn btn-danger scan-btn hidden">Stop Scanner</button>
                        
                        <div id="qr-reader"></div>
                        <div id="scanResult"></div>
                    </div>
                </div>

                <!-- Personal Attendance History -->
                <div class="card">
                    <h2>My Attendance History</h2>
                    <div class="form-group">
                        <label for="employeeHistoryDate">Filter by Date</label>
                        <input type="date" id="employeeHistoryDate" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <button onclick="loadEmployeeAttendance()" class="btn btn-primary">Load My Attendance</button>
                    
                    <div class="table-container">
                        <table id="employeeAttendanceTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Check In</th>
                                    <th>Check Out</th>
                                    <th>Total Hours</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Employee attendance data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Firebase Configuration and Initialization
        const firebaseConfig = {
            apiKey: "AIzaSyDY2PWQvaoOB9wV7SN3bT5qjgxQvlU3bQw",
            authDomain: "attendance-f96fe.firebaseapp.com",
            projectId: "attendance-f96fe",
            storageBucket: "attendance-f96fe.firebasestorage.app",
            messagingSenderId: "98412865321",
            appId: "1:98412865321:web:5a4a1fc7000045dcbe3938",
            measurementId: "G-LC120JM5S9"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Global Variables
        let currentUser = null;
        let currentUserType = null;
        let qrScanner = null;

        // Check for existing session on page load
        window.addEventListener('DOMContentLoaded', function() {
            checkExistingSession();
            setupEventListeners();
        });

        // Session Management
        function checkExistingSession() {
            const savedSession = localStorage.getItem('attendanceSession');
            if (savedSession) {
                const session = JSON.parse(savedSession);
                if (session.userType === 'admin' && session.username === 'Siddhant' && session.id === '102005') {
                    loginAsAdmin(session.username, session.id);
                } else if (session.userType === 'employee' && session.employeeId) {
                    loginAsEmployee(session.employeeId);
                }
            }
        }

        function saveSession(userType, userData) {
            localStorage.setItem('attendanceSession', JSON.stringify({
                userType: userType,
                ...userData,
                timestamp: Date.now()
            }));
        }

        function clearSession() {
            localStorage.removeItem('attendanceSession');
        }

        // Event Listeners Setup
        function setupEventListeners() {
            // Login form handlers
            document.getElementById('adminLogin').addEventListener('submit', handleAdminLogin);
            document.getElementById('employeeLogin').addEventListener('submit', handleEmployeeLogin);
            
            // Employee form handler
            document.getElementById('addEmployeeForm').addEventListener('submit', handleAddEmployee);
            
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    showSection(section);
                    
                    // Update active nav
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        // Login Tab Switching
        function switchTab(tab) {
            const adminForm = document.getElementById('adminLogin');
            const employeeForm = document.getElementById('employeeLogin');
            const tabBtns = document.querySelectorAll('.tab-btn');
            
            tabBtns.forEach(btn => btn.classList.remove('active'));
            
            if (tab === 'admin') {
                adminForm.classList.remove('hidden');
                employeeForm.classList.add('hidden');
                tabBtns[0].classList.add('active');
            } else {
                employeeForm.classList.remove('hidden');
                adminForm.classList.add('hidden');
                tabBtns[1].classList.add('active');
            }
        }

        // Login Handlers
        function handleAdminLogin(e) {
            e.preventDefault();
            const username = document.getElementById('adminUsername').value;
            const adminId = document.getElementById('adminId').value;
            
            // Hardcoded admin credentials
            if (username === 'Siddhant' && adminId === '102005') {
                loginAsAdmin(username, adminId);
            } else {
                showAlert('Invalid admin credentials!', 'error');
            }
        }

        function handleEmployeeLogin(e) {
            e.preventDefault();
            const employeeId = document.getElementById('employeeId').value;
            
            // Check if employee exists in database
            db.collection('employees').doc(employeeId).get()
                .then(doc => {
                    if (doc.exists) {
                        loginAsEmployee(employeeId);
                    } else {
                        showAlert('Employee ID not found!', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error checking employee data!', 'error');
                });
        }

        function loginAsAdmin(username, adminId) {
            currentUser = { username, id: adminId };
            currentUserType = 'admin';
            
            saveSession('admin', { username, id: adminId });
            
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            document.getElementById('adminName').textContent = `Welcome back, ${username}`;
            document.getElementById('adminAvatar').textContent = username.charAt(0).toUpperCase();
            
            loadDashboardData();
        }

        function loginAsEmployee(employeeId) {
            db.collection('employees').doc(employeeId).get()
                .then(doc => {
                    if (doc.exists) {
                        const employeeData = doc.data();
                        currentUser = { 
                            id: employeeId, 
                            name: employeeData.name,
                            email: employeeData.email,
                            designation: employeeData.designation
                        };
                        currentUserType = 'employee';
                        
                        saveSession('employee', { employeeId });
                        
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('employeeDashboard').style.display = 'block';
                        document.getElementById('employeeName').textContent = `Welcome back, ${employeeData.name}`;
                        document.getElementById('employeeAvatar').textContent = employeeData.name.charAt(0).toUpperCase();
                        
                        // Load employee attendance after a short delay to ensure UI is ready
                        setTimeout(() => {
                            loadEmployeeAttendance();
                        }, 500);
                    }
                })
                .catch(error => {
                    console.error('Error during employee login:', error);
                    showAlert('Error during login!', 'error');
                });
        }

        function logout() {
            clearSession();
            currentUser = null;
            currentUserType = null;
            
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('employeeDashboard').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            
            // Reset forms
            document.getElementById('adminLogin').reset();
            document.getElementById('employeeLogin').reset();
            
            // Stop QR scanner if running
            if (qrScanner) {
                qrScanner.stop();
                qrScanner = null;
            }
        }

        // Section Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            // Load section-specific data
            if (sectionId === 'dashboard') {
                loadDashboardData();
            } else if (sectionId === 'addEmployee') {
                loadEmployeeList();
            } else if (sectionId === 'generateQR') {
                loadQRStatus();
            } else if (sectionId === 'viewAttendance') {
                loadEmployeeDropdown('attendanceEmployeeFilter');
                loadAttendanceData();
            } else if (sectionId === 'reports') {
                loadEmployeeDropdown('reportEmployeeSelect');
            }
        }

        // Employee Management
        function handleAddEmployee(e) {
            e.preventDefault();
            
            const employeeData = {
                name: document.getElementById('empName').value,
                id: document.getElementById('empId').value,
                email: document.getElementById('empEmail').value,
                designation: document.getElementById('empDesignation').value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                qrCode: null
            };
            
            db.collection('employees').doc(employeeData.id).set(employeeData)
                .then(() => {
                    showAlert('Employee added successfully!', 'success');
                    document.getElementById('addEmployeeForm').reset();
                    loadEmployeeList();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error adding employee!', 'error');
                });
        }

        function loadEmployeeList() {
            const tbody = document.querySelector('#employeeTable tbody');
            tbody.innerHTML = '<tr><td colspan="5" class="loading">Loading employees...</td></tr>';
            
            db.collection('employees').get()
                .then(snapshot => {
                    tbody.innerHTML = '';
                    if (snapshot.empty) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No employees found</td></tr>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const emp = doc.data();
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${emp.id}</td>
                            <td>${emp.name}</td>
                            <td>${emp.email}</td>
                            <td>${emp.designation}</td>
                            <td>
                                <button onclick="deleteEmployee('${emp.id}')" class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8rem;">Delete</button>
                            </td>
                        `;
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">Error loading employees</td></tr>';
                });
        }

        function deleteEmployee(employeeId) {
            if (confirm('Are you sure you want to delete this employee?')) {
                db.collection('employees').doc(employeeId).delete()
                    .then(() => {
                        showAlert('Employee deleted successfully!', 'success');
                        loadEmployeeList();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showAlert('Error deleting employee!', 'error');
                    });
            }
        }

        function loadEmployeeDropdown(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Loading...</option>';
            
            db.collection('employees').get()
                .then(snapshot => {
                    select.innerHTML = selectId === 'attendanceEmployeeFilter' ? '<option value="">All Employees</option>' : '<option value="">Select an employee...</option>';
                    
                    snapshot.forEach(doc => {
                        const emp = doc.data();
                        const option = document.createElement('option');
                        option.value = emp.id;
                        option.textContent = `${emp.name} (${emp.id})`;
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    select.innerHTML = '<option value="">Error loading employees</option>';
                });
        }

        // QR Code Generation - Universal QR Code
        function generateUniversalQR() {
            // Generate universal QR code data that works for all employees
            const qrData = JSON.stringify({
                company: 'ambivare-solutions',
                type: 'universal-attendance',
                location: 'office',
                timestamp: Date.now()
            });
            
            const qr = new QRious({
                element: document.getElementById('qrCanvas'),
                value: qrData,
                size: 300,
                level: 'H'
            });
            
            // Save universal QR code data to Firebase
            db.collection('settings').doc('universal-qr').set({
                qrCode: qrData,
                generated: firebase.firestore.FieldValue.serverTimestamp(),
                active: true
            }).then(() => {
                document.getElementById('qrDisplay').classList.remove('hidden');
                loadQRStatus();
                showAlert('Universal QR code generated successfully!', 'success');
            }).catch(error => {
                console.error('Error:', error);
                showAlert('Error generating QR code!', 'error');
            });
        }

        function refreshQR() {
            if (confirm('Are you sure you want to refresh the QR code? The old QR code will become invalid.')) {
                generateUniversalQR();
            }
        }

        function loadQRStatus() {
            db.collection('settings').doc('universal-qr').get()
                .then(doc => {
                    const statusDiv = document.getElementById('qrStatus');
                    if (doc.exists) {
                        const data = doc.data();
                        const generatedDate = data.generated ? data.generated.toDate().toLocaleString() : 'Unknown';
                        statusDiv.innerHTML = `
                            <div style="padding: 1rem; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 6px;">
                                <p><strong>Status:</strong> <span style="color: green;">Active QR Code Available</span></p>
                                <p><strong>Generated:</strong> ${generatedDate}</p>
                                <p><strong>Usage:</strong> All employees can use this QR code</p>
                            </div>
                        `;
                    } else {
                        statusDiv.innerHTML = `
                            <div style="padding: 1rem; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 6px;">
                                <p><strong>Status:</strong> <span style="color: red;">No QR Code Generated</span></p>
                                <p>Generate a universal QR code to enable attendance marking.</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('qrStatus').innerHTML = '<p style="color: red;">Error loading QR status</p>';
                });
        }

        function downloadQR() {
            const canvas = document.getElementById('qrCanvas');
            const link = document.createElement('a');
            link.download = 'employee-qr-code.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        // QR Scanner for Employees - Fixed Implementation with proper overlay
        function startQRScanner() {
            const qrReader = document.getElementById('qr-reader');
            const startBtn = document.getElementById('startScanBtn');
            const stopBtn = document.getElementById('stopScanBtn');
            const scanResult = document.getElementById('scanResult');
            
            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            scanResult.innerHTML = '<div class="alert alert-success">Starting camera...</div>';
            
            // Clear previous content
            qrReader.innerHTML = '';
            
            // Use Html5Qrcode for direct camera access
            qrScanner = new Html5Qrcode("qr-reader");
            
            const config = {
                fps: 10,
                qrbox: function(viewfinderWidth, viewfinderHeight) {
                    // Square QR box that's 70% of the smaller dimension
                    let minEdgePercentage = 0.7;
                    let minEdgeSize = Math.min(viewfinderWidth, viewfinderHeight);
                    let qrboxSize = Math.floor(minEdgeSize * minEdgePercentage);
                    return {
                        width: qrboxSize,
                        height: qrboxSize
                    };
                },
                aspectRatio: 1.0,
                videoConstraints: {
                    width: { ideal: 400 },
                    height: { ideal: 400 }
                }
            };
            
            // Try back camera first, then front camera
            function tryCamera(cameraConfig) {
                return qrScanner.start(
                    cameraConfig,
                    config,
                    (decodedText, decodedResult) => {
                        // Success callback
                        onScanSuccess(decodedText, decodedResult);
                    },
                    (errorMessage) => {
                        // Error callback - ignore frequent "No QR code found" messages
                        if (!errorMessage.includes('No QR code found') && 
                            !errorMessage.includes('QR code parse error') &&
                            !errorMessage.includes('NotFoundException')) {
                            console.log('QR Scan error:', errorMessage);
                        }
                    }
                );
            }
            
            // Start with back camera, fallback to front camera, then any available camera
            tryCamera({ facingMode: "environment" })
                .then(() => {
                    scanResult.innerHTML = '<div class="alert alert-success">Camera ready! Point your camera at the QR code to scan.</div>';
                    // Fix scanner styling after initialization
                    setTimeout(fixScannerStyles, 500);
                })
                .catch(() => {
                    // Try front camera
                    return tryCamera({ facingMode: "user" });
                })
                .then(() => {
                    if (scanResult.innerHTML.includes('Starting camera')) {
                        scanResult.innerHTML = '<div class="alert alert-success">Camera ready! Point your camera at the QR code to scan.</div>';
                        setTimeout(fixScannerStyles, 500);
                    }
                })
                .catch(() => {
                    // Try any available camera
                    return tryCamera({});
                })
                .then(() => {
                    if (scanResult.innerHTML.includes('Starting camera')) {
                        scanResult.innerHTML = '<div class="alert alert-success">Camera ready! Point your camera at the QR code to scan.</div>';
                        setTimeout(fixScannerStyles, 500);
                    }
                })
                .catch(err => {
                    console.error('Camera start error:', err);
                    scanResult.innerHTML = '<div class="alert alert-error">Camera access denied or not available. Please allow camera access and try again.</div>';
                    startBtn.classList.remove('hidden');
                    stopBtn.classList.add('hidden');
                    qrReader.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">Camera not accessible</div>';
                });
        }

        function fixScannerStyles() {
            const qrReader = document.getElementById('qr-reader');
            if (!qrReader) return;
            
            // Ensure video is properly styled
            const video = qrReader.querySelector('video');
            if (video) {
                video.style.width = '100%';
                video.style.height = 'auto';
                video.style.maxWidth = '400px';
                video.style.borderRadius = '8px';
                video.style.display = 'block';
            }
            
            // Style the canvas overlay
            const canvas = qrReader.querySelector('canvas');
            if (canvas) {
                canvas.style.position = 'absolute';
                canvas.style.top = '0';
                canvas.style.left = '0';
                canvas.style.zIndex = '10';
                canvas.style.borderRadius = '8px';
            }
            
            // Hide any file input elements
            const fileInputs = qrReader.querySelectorAll('input[type="file"]');
            fileInputs.forEach(input => {
                input.style.display = 'none';
            });
        }

        function stopQRScanner() {
            const startBtn = document.getElementById('startScanBtn');
            const stopBtn = document.getElementById('stopScanBtn');
            const scanResult = document.getElementById('scanResult');
            const qrReader = document.getElementById('qr-reader');
            
            if (qrScanner) {
                qrScanner.stop().then(() => {
                    qrScanner.clear();
                    qrScanner = null;
                    startBtn.classList.remove('hidden');
                    stopBtn.classList.add('hidden');
                    qrReader.innerHTML = '';
                    scanResult.innerHTML = '';
                }).catch((error) => {
                    console.error('Error stopping scanner:', error);
                    qrScanner = null;
                    startBtn.classList.remove('hidden');
                    stopBtn.classList.add('hidden');
                    qrReader.innerHTML = '';
                    scanResult.innerHTML = '';
                });
            } else {
                startBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                qrReader.innerHTML = '';
                scanResult.innerHTML = '';
            }
        }

        function hideUploadElements() {
            // Not needed with Html5Qrcode direct implementation
        }

        function onScanSuccess(decodedText, decodedResult) {
            try {
                const qrData = JSON.parse(decodedText);
                
                if (qrData.company === 'ambivare-solutions' && qrData.type === 'universal-attendance') {
                    // Valid universal QR code - mark attendance for current employee
                    document.getElementById('scanResult').innerHTML = '<div class="alert alert-success">QR Code detected! Processing attendance...</div>';
                    markAttendance();
                    stopQRScanner();
                } else if (qrData.company === 'ambivare-solutions') {
                    document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">This QR code format is not supported. Please use the universal QR code from admin.</div>';
                } else {
                    document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">Invalid QR code! Please scan the official attendance QR code.</div>';
                }
            } catch (error) {
                document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">Invalid QR code format! Please scan the official attendance QR code.</div>';
            }
        }

        function onScanFailure(error) {
            // Handle scan failure silently - this is called frequently during scanning
            // Only log actual errors, not "No QR code found" messages
            if (!error.includes('No QR code found')) {
                console.log('QR Scan error:', error);
            }
        }

        // Attendance Management
        function markAttendance() {
            const today = new Date().toISOString().split('T')[0];
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            const attendanceRef = db.collection('attendance').doc(`${currentUser.id}_${today}`);
            
            attendanceRef.get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    if (!data.checkOut) {
                        // Mark check-out
                        const totalHours = calculateHours(data.checkIn, timeString);
                        attendanceRef.update({
                            checkOut: timeString,
                            checkOutTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            totalHours: totalHours
                        }).then(() => {
                            document.getElementById('scanResult').innerHTML = '<div class="alert alert-success">Check-out recorded successfully at ' + timeString + '!</div>';
                            setTimeout(() => {
                                loadEmployeeAttendance();
                            }, 1000);
                        }).catch(error => {
                            console.error('Error updating check-out:', error);
                            document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">Error recording check-out!</div>';
                        });
                    } else {
                        document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">You have already checked out today!</div>';
                    }
                } else {
                    // Mark check-in
                    attendanceRef.set({
                        employeeId: currentUser.id,
                        employeeName: currentUser.name,
                        date: today,
                        checkIn: timeString,
                        checkInTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        checkOut: null,
                        totalHours: null,
                        status: 'Present'
                    }).then(() => {
                        document.getElementById('scanResult').innerHTML = '<div class="alert alert-success">Check-in recorded successfully at ' + timeString + '!</div>';
                        setTimeout(() => {
                            loadEmployeeAttendance();
                        }, 1000);
                    }).catch(error => {
                        console.error('Error creating check-in:', error);
                        document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">Error recording check-in!</div>';
                    });
                }
            }).catch(error => {
                console.error('Error checking attendance:', error);
                document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">Error checking attendance record!</div>';
            });
        }

        function calculateHours(checkIn, checkOut) {
            const inTime = new Date(`1970-01-01T${checkIn}`);
            const outTime = new Date(`1970-01-01T${checkOut}`);
            const diffMs = outTime - inTime;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            return `${diffHours}h ${diffMinutes}m`;
        }

        // Dashboard Data Loading
        function loadDashboardData() {
            // Load total employees
            db.collection('employees').get().then(snapshot => {
                document.getElementById('totalEmployees').textContent = snapshot.size;
            });
            
            // Load today's attendance stats
            const today = new Date().toISOString().split('T')[0];
            db.collection('attendance').where('date', '==', today).get().then(snapshot => {
                let present = 0;
                let absent = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'Present') {
                        present++;
                    } else {
                        absent++;
                    }
                });
                
                document.getElementById('presentToday').textContent = present;
                document.getElementById('absentToday').textContent = absent;
                
                const total = present + absent;
                const rate = total > 0 ? Math.round((present / total) * 100) : 0;
                document.getElementById('attendanceRate').textContent = `${rate}%`;
            });
            
            // Load recent activity
            loadRecentActivity();
        }

        function loadRecentActivity() {
            const activityDiv = document.getElementById('recentActivity');
            
            db.collection('attendance').get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        activityDiv.innerHTML = '<p>No recent activity</p>';
                        return;
                    }
                    
                    // Convert to array and sort client-side
                    const activities = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.checkInTimestamp || data.checkIn) {
                            activities.push(data);
                        }
                    });
                    
                    // Sort by date and time
                    activities.sort((a, b) => {
                        const dateA = new Date(a.date + ' ' + (a.checkIn || '00:00'));
                        const dateB = new Date(b.date + ' ' + (b.checkIn || '00:00'));
                        return dateB - dateA;
                    });
                    
                    // Take first 5 activities
                    const recentActivities = activities.slice(0, 5);
                    
                    if (recentActivities.length === 0) {
                        activityDiv.innerHTML = '<p>No recent activity</p>';
                        return;
                    }
                    
                    let html = '<ul style="list-style: none; padding: 0;">';
                    recentActivities.forEach(data => {
                        html += `<li style="padding: 10px; border-bottom: 1px solid #eee;">
                            <strong>${data.employeeName}</strong> checked in at ${data.checkIn} on ${data.date}
                        </li>`;
                    });
                    html += '</ul>';
                    activityDiv.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error:', error);
                    activityDiv.innerHTML = '<p style="color: red;">Error loading recent activity</p>';
                });
        }

        // Attendance Data Loading
        function loadAttendanceData() {
            const tbody = document.querySelector('#attendanceTable tbody');
            tbody.innerHTML = '<tr><td colspan="7" class="loading">Loading attendance data...</td></tr>';
            
            const employeeFilter = document.getElementById('attendanceEmployeeFilter').value;
            const dateFilter = document.getElementById('attendanceDateFilter').value;
            
            let query = db.collection('attendance');
            
            if (employeeFilter) {
                query = query.where('employeeId', '==', employeeFilter);
            }
            
            if (dateFilter) {
                query = query.where('date', '==', dateFilter);
            }
            
            query.get()
                .then(snapshot => {
                    tbody.innerHTML = '';
                    if (snapshot.empty) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No attendance records found</td></tr>';
                        return;
                    }
                    
                    // Convert to array and sort client-side
                    const attendanceRecords = [];
                    snapshot.forEach(doc => {
                        attendanceRecords.push(doc.data());
                    });
                    
                    // Sort by date descending
                    attendanceRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    attendanceRecords.forEach(data => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${data.employeeId}</td>
                            <td>${data.employeeName}</td>
                            <td>${data.date}</td>
                            <td>${data.checkIn || '-'}</td>
                            <td>${data.checkOut || '-'}</td>
                            <td>${data.totalHours || '-'}</td>
                            <td><span style="color: ${data.status === 'Present' ? 'green' : 'red'}">${data.status}</span></td>
                        `;
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: red;">Error loading attendance data</td></tr>';
                });
        }

        function loadEmployeeAttendance() {
            if (currentUserType !== 'employee' || !currentUser) {
                console.error('Not an employee or user not logged in');
                return;
            }
            
            const tbody = document.querySelector('#employeeAttendanceTable tbody');
            tbody.innerHTML = '<tr><td colspan="5" class="loading">Loading your attendance...</td></tr>';
            
            // Simple query without orderBy to avoid index issues
            db.collection('attendance').where('employeeId', '==', currentUser.id).get()
                .then(snapshot => {
                    tbody.innerHTML = '';
                    if (snapshot.empty) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No attendance records found. Start marking attendance by scanning QR codes!</td></tr>';
                        return;
                    }
                    
                    // Convert to array and sort client-side
                    const attendanceRecords = [];
                    snapshot.forEach(doc => {
                        attendanceRecords.push(doc.data());
                    });
                    
                    // Sort by date descending
                    attendanceRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    // Apply date filter if set
                    const dateFilter = document.getElementById('employeeHistoryDate').value;
                    const filteredRecords = dateFilter ? 
                        attendanceRecords.filter(record => record.date === dateFilter) : 
                        attendanceRecords;
                    
                    if (filteredRecords.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No records found for the selected date.</td></tr>';
                        return;
                    }
                    
                    filteredRecords.forEach(data => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${data.date}</td>
                            <td>${data.checkIn || '-'}</td>
                            <td>${data.checkOut || '-'}</td>
                            <td>${data.totalHours || '-'}</td>
                            <td><span style="color: ${data.status === 'Present' ? 'green' : 'red'}">${data.status}</span></td>
                        `;
                    });
                })
                .catch(error => {
                    console.error('Error loading employee attendance:', error);
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">Error loading attendance data. Please try refreshing the page.</td></tr>';
                });
        }

        // PDF Report Generation
        function generateIndividualReport() {
            const employeeId = document.getElementById('reportEmployeeSelect').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!employeeId) {
                showAlert('Please select an employee!', 'error');
                return;
            }
            
            showAlert('Generating individual report...', 'success');
            
            // Get employee data
            db.collection('employees').doc(employeeId).get()
                .then(empDoc => {
                    if (!empDoc.exists) {
                        showAlert('Employee not found!', 'error');
                        return;
                    }
                    
                    const empData = empDoc.data();
                    
                    // Get attendance data for specific employee - simple query without orderBy
                    db.collection('attendance').where('employeeId', '==', employeeId).get()
                        .then(snapshot => {
                            const attendanceData = [];
                            let totalDays = 0;
                            let presentDays = 0;
                            let totalHoursWorked = 0;
                            
                            snapshot.forEach(doc => {
                                const data = doc.data();
                                
                                // Apply date filter if specified
                                if (startDate && endDate) {
                                    if (data.date >= startDate && data.date <= endDate) {
                                        attendanceData.push(data);
                                    } else {
                                        return; // Skip this record
                                    }
                                } else {
                                    attendanceData.push(data);
                                }
                                
                                totalDays++;
                                if (data.status === 'Present') {
                                    presentDays++;
                                    if (data.totalHours) {
                                        // Extract hours from "Xh Ym" format
                                        const hours = data.totalHours.match(/(\d+)h/);
                                        if (hours) {
                                            totalHoursWorked += parseInt(hours[1]);
                                        }
                                    }
                                }
                            });
                            
                            // Sort attendance data by date (client-side)
                            attendanceData.sort((a, b) => new Date(b.date) - new Date(a.date));
                            
                            const presentPercentage = totalDays > 0 ? Math.round((presentDays / totalDays) * 100) : 0;
                            
                            if (attendanceData.length === 0) {
                                showAlert('No attendance data found for the selected employee and date range!', 'error');
                                return;
                            }
                            
                            generateIndividualPDF(empData, attendanceData, {
                                totalDays,
                                presentDays,
                                presentPercentage,
                                totalHoursWorked,
                                startDate,
                                endDate
                            });
                        })
                        .catch(error => {
                            console.error('Error fetching attendance data:', error);
                            showAlert('Error fetching attendance data!', 'error');
                        });
                })
                .catch(error => {
                    console.error('Error fetching employee data:', error);
                    showAlert('Error fetching employee data!', 'error');
                });
        }

        function generateOverallReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            // Get all employees
            db.collection('employees').get()
                .then(empSnapshot => {
                    const totalEmployees = empSnapshot.size;
                    
                    // Get attendance data
                    let query = db.collection('attendance');
                    
                    if (startDate && endDate) {
                        query = query.where('date', '>=', startDate).where('date', '<=', endDate);
                    }
                    
                    query.get().then(attSnapshot => {
                        let totalRecords = 0;
                        let presentRecords = 0;
                        const employeeStats = {};
                        
                        attSnapshot.forEach(doc => {
                            const data = doc.data();
                            totalRecords++;
                            
                            if (!employeeStats[data.employeeId]) {
                                employeeStats[data.employeeId] = {
                                    name: data.employeeName,
                                    total: 0,
                                    present: 0
                                };
                            }
                            
                            employeeStats[data.employeeId].total++;
                            
                            if (data.status === 'Present') {
                                presentRecords++;
                                employeeStats[data.employeeId].present++;
                            }
                        });
                        
                        const overallPercentage = totalRecords > 0 ? Math.round((presentRecords / totalRecords) * 100) : 0;
                        
                        generateOverallPDF({
                            totalEmployees,
                            totalRecords,
                            presentRecords,
                            overallPercentage,
                            employeeStats,
                            startDate,
                            endDate
                        });
                    });
                });
        }

        function generateIndividualPDF(employeeData, attendanceData, stats) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Corporate colors
            const primaryColor = [44, 62, 80];
            const secondaryColor = [249, 246, 242];
            
            // Header
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, 210, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('AMBIVARE SOLUTIONS', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('Individual Attendance Report', 105, 30, { align: 'center' });
            
            // Employee Info
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Employee Information', 20, 60);
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Name: ${employeeData.name}`, 20, 75);
            doc.text(`Employee ID: ${employeeData.id}`, 20, 85);
            doc.text(`Designation: ${employeeData.designation}`, 20, 95);
            doc.text(`Email: ${employeeData.email}`, 20, 105);
            
            // Statistics
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Summary Statistics', 20, 125);
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Total Working Days: ${stats.totalDays}`, 20, 140);
            doc.text(`Days Present: ${stats.presentDays}`, 20, 150);
            doc.text(`Attendance Rate: ${stats.presentPercentage}%`, 20, 160);
            doc.text(`Total Hours Worked: ${stats.totalHoursWorked}h`, 20, 170);
            
            if (stats.startDate && stats.endDate) {
                doc.text(`Report Period: ${stats.startDate} to ${stats.endDate}`, 20, 180);
            }
            
            // Attendance Table
            const tableData = attendanceData.map(record => [
                record.date,
                record.checkIn || '-',
                record.checkOut || '-',
                record.totalHours || '-',
                record.status
            ]);
            
            doc.autoTable({
                head: [['Date', 'Check In', 'Check Out', 'Total Hours', 'Status']],
                body: tableData,
                startY: 195,
                theme: 'grid',
                headStyles: {
                    fillColor: primaryColor,
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [248, 249, 250]
                }
            });
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.setTextColor(128, 128, 128);
                doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 280);
                doc.text(`Page ${i} of ${pageCount}`, 190, 280, { align: 'right' });
                doc.text('Ambivare Solutions - Confidential', 105, 290, { align: 'center' });
            }
            
            // Save the PDF
            doc.save(`${employeeData.name}_Individual_Report.pdf`);
            showAlert('Individual report generated successfully!', 'success');
        }

        function generatePDF(employeeData, attendanceData, stats) {
            // This function is kept for backward compatibility
            generateIndividualPDF(employeeData, attendanceData, stats);
        }

        function generateOverallPDF(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Corporate colors
            const primaryColor = [44, 62, 80];
            
            // Header
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, 210, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('AMBIVARE SOLUTIONS', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('Overall Attendance Analytics', 105, 30, { align: 'center' });
            
            // Overall Statistics
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Company Statistics', 20, 60);
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Total Employees: ${data.totalEmployees}`, 20, 75);
            doc.text(`Total Attendance Records: ${data.totalRecords}`, 20, 85);
            doc.text(`Present Records: ${data.presentRecords}`, 20, 95);
            doc.text(`Absent Records: ${data.totalRecords - data.presentRecords}`, 20, 105);
            doc.text(`Overall Attendance Rate: ${data.overallPercentage}%`, 20, 115);
            
            if (data.startDate && data.endDate) {
                doc.text(`Report Period: ${data.startDate} to ${data.endDate}`, 20, 125);
            }
            
            // Employee-wise breakdown
            const tableData = Object.keys(data.employeeStats).map(empId => {
                const stats = data.employeeStats[empId];
                const percentage = stats.total > 0 ? Math.round((stats.present / stats.total) * 100) : 0;
                return [
                    empId,
                    stats.name,
                    stats.total,
                    stats.present,
                    `${percentage}%`
                ];
            });
            
            doc.autoTable({
                head: [['Employee ID', 'Name', 'Total Days', 'Present Days', 'Attendance %']],
                body: tableData,
                startY: 140,
                theme: 'grid',
                headStyles: {
                    fillColor: primaryColor,
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [248, 249, 250]
                }
            });
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.setTextColor(128, 128, 128);
                doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 280);
                doc.text(`Page ${i} of ${pageCount}`, 190, 280, { align: 'right' });
                doc.text('Ambivare Solutions - Confidential', 105, 290, { align: 'center' });
            }
            
            // Save the PDF
            doc.save('Overall_Attendance_Analytics.pdf');
        }

        // Utility Functions
        function showAlert(message, type) {
            const alertDiv = document.getElementById('loginAlert');
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        // Set default dates for reports
        function setDefaultDates() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('reportStartDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
        }

        // Initialize default dates when page loads
        setTimeout(setDefaultDates, 1000);
    </script>
</body>
</html>
