<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ambivare Solutions - Attendance Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #f8f6f0 50%, #f5f3ed 100%);
            min-height: 100vh;
            color: #2d3748;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #ffffff 0%, #f9f7f0 100%);
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-bottom: 4px solid #d4af37;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #d4af37, #f1c40f, #d4af37);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 1.9rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
            letter-spacing: -0.5px;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #d4af37 0%, #f1c40f 50%, #e8c547 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
            position: relative;
        }

        .logo::after {
            content: '';
            position: absolute;
            inset: 2px;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent);
            border-radius: 14px;
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            border: 1px solid rgba(212, 175, 55, 0.1);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #d4af37, #f1c40f);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.12);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(45deg, #d4af37, #f1c40f);
            border-radius: 2px;
        }

        .login-container {
            max-width: 450px;
            margin: 5rem auto;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.8rem;
            color: #4a5568;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            color: #2d3748;
        }

        .form-group input:focus, 
        .form-group select:focus, 
        .form-group textarea:focus {
            outline: none;
            border-color: #d4af37;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
            transform: translateY(-1px);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #d4af37 0%, #f1c40f 50%, #e8c547 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #718096 0%, #a0aec0 100%);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(113, 128, 150, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e53e3e 0%, #fc8181 100%);
        }

        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(229, 62, 62, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #38a169 0%, #68d391 100%);
        }

        .btn-success:hover {
            box-shadow: 0 8px 25px rgba(56, 161, 105, 0.4);
        }

        .btn-lg {
            padding: 16px 32px;
            font-size: 1.1rem;
        }

        .btn-sm {
            padding: 10px 20px;
            font-size: 0.9rem;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .nav-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 2rem;
            background: #f7fafc;
            border-radius: 12px;
            padding: 4px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        .nav-tab {
            flex: 1;
            padding: 14px 24px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #718096;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-tab:hover {
            color: #4a5568;
            background: rgba(212, 175, 55, 0.1);
        }

        .nav-tab.active {
            color: white;
            background: linear-gradient(135deg, #d4af37, #f1c40f);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f9f7f0 100%);
            padding: 1.8rem;
            border-radius: 16px;
            border: 1px solid rgba(212, 175, 55, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #d4af37;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #718096;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .employee-list {
            display: grid;
            gap: 1.5rem;
        }

        .employee-item {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 1.8rem;
            border-radius: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid #d4af37;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .employee-item:hover {
            transform: translateX(5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .employee-info {
            flex: 1;
        }

        .employee-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .employee-details {
            color: #718096;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .employee-meta {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }

        .meta-item {
            background: rgba(212, 175, 55, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            color: #d4af37;
            font-weight: 500;
        }

        .video-container {
            position: relative;
            margin: 1.5rem 0;
            text-align: center;
            background: #f8f9fa;
            border-radius: 16px;
            padding: 1.5rem;
        }

        #video {
            width: 100%;
            max-width: 450px;
            border-radius: 12px;
            border: 3px solid #d4af37;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .capture-btn {
            margin-top: 1.5rem;
            width: 100%;
            max-width: 450px;
        }

        .attendance-status {
            text-align: center;
            padding: 2.5rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 20px;
            margin: 1.5rem 0;
        }

        .status-indicator {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: white;
            position: relative;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }

        .status-indicator::before {
            content: '';
            position: absolute;
            inset: 4px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255,255,255,0.3), transparent);
        }

        .status-in {
            background: linear-gradient(135deg, #38a169 0%, #68d391 100%);
        }

        .status-out {
            background: linear-gradient(135deg, #e53e3e 0%, #fc8181 100%);
        }

        .status-ready {
            background: linear-gradient(135deg, #3182ce 0%, #63b3ed 100%);
        }

        .reports-container {
            margin-top: 2rem;
        }

        .report-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 16px;
        }

        .filter-actions {
            grid-column: 1 / -1;
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .attendance-table th,
        .attendance-table td {
            padding: 16px 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.95rem;
        }

        .attendance-table th {
            background: linear-gradient(135deg, #d4af37 0%, #f1c40f 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .attendance-table tr:hover {
            background: #f8f9fa;
        }

        .attendance-table tbody tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-complete {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-incomplete {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-partial {
            background: #feebc8;
            color: #7b341e;
        }

        .logout-btn {
            position: absolute;
            top: 1.5rem;
            right: 2rem;
        }

        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            font-weight: 500;
            border: 1px solid;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border-color: #9ae6b4;
        }

        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border-color: #feb2b2;
        }

        .alert-info {
            background: #bee3f8;
            color: #2a4365;
            border-color: #90cdf4;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #d4af37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced Mobile Responsiveness */
        @media (max-width: 1024px) {
            .container {
                max-width: 100%;
                padding: 0 1rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 1.4rem;
            }
            
            .logo {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .card {
                padding: 1.5rem;
                border-radius: 16px;
            }
            
            .logout-btn {
                position: relative;
                top: auto;
                right: auto;
                margin-top: 1rem;
            }
            
            .nav-tabs {
                flex-direction: column;
                gap: 0;
            }
            
            .report-filters {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .filter-actions {
                grid-column: 1;
            }
            
            .attendance-table {
                font-size: 0.85rem;
            }
            
            .attendance-table th,
            .attendance-table td {
                padding: 12px 8px;
            }
            
            .employee-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .employee-meta {
                margin-top: 1rem;
            }
            
            .status-indicator {
                width: 100px;
                height: 100px;
                font-size: 2rem;
            }
            
            .video-container {
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 0.5rem;
            }
            
            .card {
                padding: 1rem;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .attendance-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>
            <div class="logo">A</div>
            Ambivare Solutions - Attendance Manager
        </h1>
        <button class="btn btn-danger logout-btn hidden" id="logoutBtn" onclick="logout()">Logout</button>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="card">
            <h2 style="text-align: center; margin-bottom: 2rem; color: #2c3e50;">Login</h2>
            <div id="loginAlert"></div>
            
            <div class="form-group">
                <label for="loginType">Login As:</label>
                <select id="loginType" onchange="toggleLoginFields()">
                    <option value="admin">Admin</option>
                    <option value="employee">Employee</option>
                </select>
            </div>

            <div class="form-group">
                <label for="username">Username/Employee ID:</label>
                <input type="text" id="username" required>
            </div>

            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" required>
            </div>

            <button class="btn" onclick="login()" style="width: 100%;">Login</button>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="container hidden">
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('employees')">Employees</button>
            <button class="nav-tab" onclick="showTab('reports')">Reports</button>
        </div>

        <!-- Employees Tab -->
        <div id="employeesTab" class="tab-content active">
            <!-- Analytics Dashboard -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalEmployees">0</div>
                    <div class="stat-label">Total Employees</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="presentToday">0</div>
                    <div class="stat-label">Present Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="absentToday">0</div>
                    <div class="stat-label">Absent Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lateToday">0</div>
                    <div class="stat-label">Late Arrivals</div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">üìù Add New Employee</h3>
                <div id="employeeAlert"></div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="empName">Full Name *</label>
                        <input type="text" id="empName" required placeholder="Enter full name">
                    </div>
                    
                    <div class="form-group">
                        <label for="empId">Employee ID *</label>
                        <input type="text" id="empId" required placeholder="e.g., EMP001">
                    </div>
                    
                    <div class="form-group">
                        <label for="empEmail">Email Address *</label>
                        <input type="email" id="empEmail" required placeholder="employee@company.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="empPhone">Phone Number *</label>
                        <input type="tel" id="empPhone" required placeholder="+91 9876543210">
                    </div>
                    
                    <div class="form-group">
                        <label for="empPassword">Password *</label>
                        <input type="password" id="empPassword" required placeholder="Create password">
                    </div>
                    
                    <div class="form-group">
                        <label for="empDepartment">Department *</label>
                        <select id="empDepartment" required>
                            <option value="">Select Department</option>
                            <option value="Human Resources">Human Resources</option>
                            <option value="Information Technology">Information Technology</option>
                            <option value="Finance & Accounting">Finance & Accounting</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Sales">Sales</option>
                            <option value="Operations">Operations</option>
                            <option value="Customer Service">Customer Service</option>
                            <option value="Research & Development">Research & Development</option>
                            <option value="Quality Assurance">Quality Assurance</option>
                            <option value="Administration">Administration</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="empDesignation">Designation *</label>
                        <input type="text" id="empDesignation" required placeholder="e.g., Software Developer">
                    </div>
                    
                    <div class="form-group">
                        <label for="empSalary">Monthly Salary</label>
                        <input type="number" id="empSalary" placeholder="50000">
                    </div>
                    
                    <div class="form-group">
                        <label for="empJoinDate">Joining Date *</label>
                        <input type="date" id="empJoinDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="empManager">Reporting Manager</label>
                        <input type="text" id="empManager" placeholder="Manager Name">
                    </div>
                    
                    <div class="form-group">
                        <label for="empShift">Work Shift *</label>
                        <select id="empShift" required>
                            <option value="">Select Shift</option>
                            <option value="Day Shift (9 AM - 6 PM)">Day Shift (9 AM - 6 PM)</option>
                            <option value="Evening Shift (2 PM - 11 PM)">Evening Shift (2 PM - 11 PM)</option>
                            <option value="Night Shift (10 PM - 7 AM)">Night Shift (10 PM - 7 AM)</option>
                            <option value="Flexible Hours">Flexible Hours</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="empAddress">Address</label>
                        <textarea id="empAddress" placeholder="Complete address"></textarea>
                    </div>
                </div>
                
                <div class="filter-actions">
                    <button class="btn btn-lg" onclick="addEmployee()">
                        ‚ûï Add Employee
                    </button>
                    <button class="btn btn-secondary" onclick="clearEmployeeForm()">
                        üîÑ Clear Form
                    </button>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">üë• Employee Directory</h3>
                <div style="margin-bottom: 1rem;">
                    <input type="text" id="employeeSearch" placeholder="Search employees..." 
                           style="width: 100%; max-width: 400px;" onkeyup="searchEmployees()">
                </div>
                <div id="employeeList" class="employee-list"></div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reportsTab" class="tab-content">
            <!-- Advanced Analytics Dashboard -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="avgWorkingHours">0</div>
                    <div class="stat-label">Avg. Working Hours</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="attendanceRate">0%</div>
                    <div class="stat-label">Attendance Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="punctualityRate">0%</div>
                    <div class="stat-label">Punctuality Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalWorkingDays">0</div>
                    <div class="stat-label">Working Days</div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">üìä Advanced Attendance Reports</h3>
                
                <div class="report-filters">
                    <div class="form-group">
                        <label for="reportEmployee">Employee</label>
                        <select id="reportEmployee">
                            <option value="">All Employees</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportDepartment">Department</label>
                        <select id="reportDepartment">
                            <option value="">All Departments</option>
                            <option value="Human Resources">Human Resources</option>
                            <option value="Information Technology">Information Technology</option>
                            <option value="Finance & Accounting">Finance & Accounting</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Sales">Sales</option>
                            <option value="Operations">Operations</option>
                            <option value="Customer Service">Customer Service</option>
                            <option value="Research & Development">Research & Development</option>
                            <option value="Quality Assurance">Quality Assurance</option>
                            <option value="Administration">Administration</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportPeriod">Report Period</label>
                        <select id="reportPeriod">
                            <option value="daily">Daily Report</option>
                            <option value="weekly">Weekly Report</option>
                            <option value="monthly">Monthly Report</option>
                            <option value="yearly">Yearly Report</option>
                            <option value="custom">Custom Date Range</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportDate">Start Date</label>
                        <input type="date" id="reportDate">
                    </div>
                    
                    <div class="form-group" id="endDateGroup" style="display: none;">
                        <label for="reportEndDate">End Date</label>
                        <input type="date" id="reportEndDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="reportType">Report Type</label>
                        <select id="reportType">
                            <option value="summary">Summary Report</option>
                            <option value="detailed">Detailed Report</option>
                            <option value="analytics">Analytics Report</option>
                            <option value="late_arrivals">Late Arrivals</option>
                            <option value="overtime">Overtime Report</option>
                        </select>
                    </div>
                    
                    <div class="filter-actions">
                        <button class="btn" onclick="generateReport()">
                            üìà Generate Report
                        </button>
                        <button class="btn btn-secondary" onclick="downloadReport()">
                            üìÑ Download PDF
                        </button>
                        <button class="btn btn-success" onclick="exportToExcel()">
                            üìä Export Excel
                        </button>
                    </div>
                </div>
                
                <div id="reportContainer"></div>
            </div>
        </div>
    </div>

    <!-- Employee Dashboard -->
    <div id="employeeDashboard" class="container hidden">
        <div id="employeeAlerts"></div>
        
        <div class="card">
            <h2 class="card-title">üëã Welcome, <span id="employeeName"></span></h2>
            
            <div class="attendance-status">
                <div id="statusIndicator" class="status-indicator status-ready">
                    <span>üì∑</span>
                </div>
                <h3 id="statusText">Ready to Punch In</h3>
                <p id="lastAction"></p>
                <div style="margin-top: 1rem;">
                    <span id="currentTime" style="font-size: 1.2rem; color: #d4af37; font-weight: 600;"></span>
                </div>
            </div>

            <div class="video-container">
                <video id="video" autoplay muted playsinline></video>
                <canvas id="canvas" style="display: none;"></canvas>
                <br>
                <button class="btn btn-lg capture-btn" id="captureBtn" onclick="console.log('üîò Capture button clicked!'); captureAttendance();">
                    üì∏ Capture & Punch In
                </button>
                <br><br>
                <button class="btn btn-sm btn-secondary" onclick="testCaptureButton()" style="margin-top: 10px;">
                    üß™ Test Button
                </button>
            </div>
        </div>

        <!-- Employee Analytics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="empTotalDays">0</div>
                <div class="stat-label">Total Days</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="empPresentDays">0</div>
                <div class="stat-label">Present Days</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="empAbsentDays">0</div>
                <div class="stat-label">Absent Days</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="empAvgHours">0</div>
                <div class="stat-label">Avg. Hours/Day</div>
            </div>
        </div>

        <div class="card">
            <h3 class="card-title">üìä My Attendance Reports</h3>
            
            <div class="report-filters">
                <div class="form-group">
                    <label for="empReportPeriod">Report Period</label>
                    <select id="empReportPeriod">
                        <option value="daily">Daily Report</option>
                        <option value="weekly">Weekly Report</option>
                        <option value="monthly">Monthly Report</option>
                        <option value="yearly">Yearly Report</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="empReportDate">Start Date</label>
                    <input type="date" id="empReportDate">
                </div>
                
                <div class="form-group" id="empEndDateGroup" style="display: none;">
                    <label for="empReportEndDate">End Date</label>
                    <input type="date" id="empReportEndDate">
                </div>
                
                <div class="filter-actions">
                    <button class="btn" onclick="generateEmployeeReport()">
                        üìà Generate Report
                    </button>
                    <button class="btn btn-secondary" onclick="downloadEmployeeReport()">
                        üìÑ Download PDF
                    </button>
                </div>
            </div>
            
            <div id="empReportContainer"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDY2PWQvaoOB9wV7SN3bT5qjgxQvlU3bQw",
            authDomain: "attendance-f96fe.firebaseapp.com",
            projectId: "attendance-f96fe",
            storageBucket: "attendance-f96fe.firebasestorage.app",
            messagingSenderId: "98412865321",
            appId: "1:98412865321:web:5a4a1fc7000045dcbe3938",
            measurementId: "G-LC120JM5S9"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Global variables
        let currentUser = null;
        let currentUserType = null;
        let videoStream = null;
        let currentReportData = null;

        // Check for existing session
        window.onload = function() {
            const savedSession = localStorage.getItem('attendanceSession');
            if (savedSession) {
                const session = JSON.parse(savedSession);
                currentUser = session.user;
                currentUserType = session.type;
                showDashboard(session.type);
            } else {
                // Set default date to today
                document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('empReportDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('empJoinDate').value = new Date().toISOString().split('T')[0];
            }

            // Start real-time clock for employee dashboard
            if (currentUserType === 'employee') {
                updateCurrentTime();
                setInterval(updateCurrentTime, 1000);
            }

            // Add event listeners
            setupEventListeners();
        };

        // Setup event listeners
        function setupEventListeners() {
            // Report period change handlers
            document.getElementById('reportPeriod').addEventListener('change', function() {
                toggleCustomDateRange('reportPeriod', 'endDateGroup');
            });

            document.getElementById('empReportPeriod').addEventListener('change', function() {
                toggleCustomDateRange('empReportPeriod', 'empEndDateGroup');
            });
        }

        // Toggle custom date range
        function toggleCustomDateRange(periodId, endDateGroupId) {
            const period = document.getElementById(periodId).value;
            const endDateGroup = document.getElementById(endDateGroupId);
            
            if (period === 'custom') {
                endDateGroup.style.display = 'block';
            } else {
                endDateGroup.style.display = 'none';
            }
        }

        // Update current time
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('en-IN', {
                timeZone: 'Asia/Kolkata',
                hour12: true,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
            
            const timeElement = document.getElementById('currentTime');
            if (timeElement) {
                timeElement.textContent = timeString;
            }
        }

        // Clear employee form
        function clearEmployeeForm() {
            const fields = ['empName', 'empId', 'empEmail', 'empPhone', 'empPassword', 
                          'empDepartment', 'empDesignation', 'empSalary', 'empJoinDate', 
                          'empManager', 'empShift', 'empAddress'];
            
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    element.value = '';
                }
            });
        }

        // Search employees
        function searchEmployees() {
            const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();
            const employeeItems = document.querySelectorAll('.employee-item');
            
            employeeItems.forEach(item => {
                const employeeName = item.querySelector('.employee-name').textContent.toLowerCase();
                const employeeDetails = item.querySelector('.employee-details').textContent.toLowerCase();
                
                if (employeeName.includes(searchTerm) || employeeDetails.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Login function
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginType = document.getElementById('loginType').value;

            if (!username || !password) {
                showAlert('loginAlert', 'Please enter both username and password', 'error');
                return;
            }

            if (loginType === 'admin') {
                if (username === 'Siddhant' && password === '102005') {
                    currentUser = { username: 'Siddhant', type: 'admin' };
                    currentUserType = 'admin';
                    saveSession();
                    showDashboard('admin');
                } else {
                    showAlert('loginAlert', 'Invalid admin credentials', 'error');
                }
            } else {
                try {
                    const employeeRef = db.collection('employees').doc(username);
                    const doc = await employeeRef.get();
                    
                    if (doc.exists && doc.data().password === password) {
                        currentUser = { ...doc.data(), id: username };
                        currentUserType = 'employee';
                        saveSession();
                        showDashboard('employee');
                    } else {
                        showAlert('loginAlert', 'Invalid employee credentials', 'error');
                    }
                } catch (error) {
                    showAlert('loginAlert', 'Login failed: ' + error.message, 'error');
                }
            }
        }

        // Save session
        function saveSession() {
            localStorage.setItem('attendanceSession', JSON.stringify({
                user: currentUser,
                type: currentUserType
            }));
        }

        // Show dashboard based on user type
        function showDashboard(type) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');

            if (type === 'admin') {
                document.getElementById('adminDashboard').classList.remove('hidden');
                loadEmployees();
                loadEmployeesForReport();
                updateDashboardStats();
            } else {
                document.getElementById('employeeDashboard').classList.remove('hidden');
                document.getElementById('employeeName').textContent = currentUser.name;
                
                // Initialize camera first, then check status
                setTimeout(() => {
                    initializeCamera();
                    checkAttendanceStatus();
                    updateEmployeeStats();
                    updateCurrentTime();
                    setInterval(updateCurrentTime, 1000);
                }, 100);
            }
        }

        // Update employee statistics
        async function updateEmployeeStats() {
            try {
                const empId = currentUser.empId;
                const currentYear = new Date().getFullYear();
                const currentMonth = new Date().getMonth();
                
                // Get all attendance records for current employee this year
                const attendanceSnapshot = await db.collection('attendance')
                    .where('empId', '==', empId)
                    .get();
                
                let totalDays = 0;
                let presentDays = 0;
                let totalHours = 0;
                
                attendanceSnapshot.forEach(doc => {
                    const record = doc.data();
                    const recordDate = new Date(record.date);
                    
                    if (recordDate.getFullYear() === currentYear) {
                        totalDays++;
                        if (record.punchIn) {
                            presentDays++;
                            
                            if (record.punchOut) {
                                const punchIn = new Date(record.punchIn.seconds * 1000);
                                const punchOut = new Date(record.punchOut.seconds * 1000);
                                const hours = Math.abs(punchOut - punchIn) / 36e5;
                                totalHours += hours;
                            }
                        }
                    }
                });
                
                const absentDays = totalDays - presentDays;
                const avgHours = presentDays > 0 ? (totalHours / presentDays).toFixed(1) : '0';
                
                // Update UI
                const updateEmpStat = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = value;
                };
                
                updateEmpStat('empTotalDays', totalDays);
                updateEmpStat('empPresentDays', presentDays);
                updateEmpStat('empAbsentDays', absentDays);
                updateEmpStat('empAvgHours', avgHours);
                
            } catch (error) {
                console.error('Error updating employee stats:', error);
            }
        }

        // Logout function
        function logout() {
            localStorage.removeItem('attendanceSession');
            currentUser = null;
            currentUserType = null;
            
            // Stop video stream
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
            
            // Reset UI
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('employeeDashboard').classList.add('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            // Clear form
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Tab navigation
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to clicked nav tab
            event.target.classList.add('active');
        }

        // Add employee function
        async function addEmployee() {
            const name = document.getElementById('empName').value;
            const empId = document.getElementById('empId').value;
            const email = document.getElementById('empEmail').value;
            const phone = document.getElementById('empPhone').value;
            const password = document.getElementById('empPassword').value;
            const department = document.getElementById('empDepartment').value;
            const designation = document.getElementById('empDesignation').value;
            const salary = document.getElementById('empSalary').value;
            const joinDate = document.getElementById('empJoinDate').value;
            const manager = document.getElementById('empManager').value;
            const shift = document.getElementById('empShift').value;
            const address = document.getElementById('empAddress').value;

            // Validation
            if (!name || !empId || !email || !phone || !password || !department || !designation || !joinDate || !shift) {
                showAlert('employeeAlert', 'Please fill all required fields marked with *', 'error');
                return;
            }

            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showAlert('employeeAlert', 'Please enter a valid email address', 'error');
                return;
            }

            // Phone validation
            const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
            if (!phoneRegex.test(phone.replace(/\s/g, ''))) {
                showAlert('employeeAlert', 'Please enter a valid phone number', 'error');
                return;
            }

            try {
                // Check if employee ID already exists
                const existingEmployee = await db.collection('employees').doc(empId).get();
                if (existingEmployee.exists) {
                    showAlert('employeeAlert', 'Employee ID already exists', 'error');
                    return;
                }

                // Check if email already exists
                const emailQuery = await db.collection('employees').where('email', '==', email).get();
                if (!emailQuery.empty) {
                    showAlert('employeeAlert', 'Email address already exists', 'error');
                    return;
                }

                await db.collection('employees').doc(empId).set({
                    name: name,
                    empId: empId,
                    email: email,
                    phone: phone,
                    password: password,
                    department: department,
                    designation: designation,
                    salary: salary ? parseFloat(salary) : null,
                    joinDate: joinDate,
                    manager: manager,
                    shift: shift,
                    address: address,
                    createdAt: new Date(),
                    isActive: true
                });

                showAlert('employeeAlert', '‚úÖ Employee added successfully!', 'success');
                clearEmployeeForm();
                loadEmployees();
                loadEmployeesForReport();
                updateDashboardStats();
            } catch (error) {
                showAlert('employeeAlert', 'Error adding employee: ' + error.message, 'error');
            }
        }

        // Load employees
        async function loadEmployees() {
            try {
                const snapshot = await db.collection('employees').get();
                const employeeList = document.getElementById('employeeList');
                employeeList.innerHTML = '';

                if (snapshot.empty) {
                    employeeList.innerHTML = '<p style="text-align: center; color: #718096; padding: 2rem;">No employees found. Add your first employee above.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const employee = doc.data();
                    const employeeDiv = document.createElement('div');
                    employeeDiv.className = 'employee-item';
                    
                    const joinDate = new Date(employee.joinDate).toLocaleDateString('en-IN');
                    const experience = calculateExperience(employee.joinDate);
                    
                    employeeDiv.innerHTML = `
                        <div class="employee-info">
                            <div class="employee-name">${employee.name}</div>
                            <div class="employee-details">
                                <strong>ID:</strong> ${employee.empId} | 
                                <strong>Email:</strong> ${employee.email || 'N/A'}<br>
                                <strong>Department:</strong> ${employee.department} | 
                                <strong>Designation:</strong> ${employee.designation || 'N/A'}<br>
                                <strong>Phone:</strong> ${employee.phone || 'N/A'} | 
                                <strong>Joined:</strong> ${joinDate}
                            </div>
                            <div class="employee-meta">
                                <span class="meta-item">${employee.shift || 'N/A'}</span>
                                <span class="meta-item">${experience}</span>
                                ${employee.salary ? `<span class="meta-item">‚Çπ${employee.salary.toLocaleString('en-IN')}/month</span>` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-direction: column;">
                            <button class="btn btn-sm" onclick="viewEmployeeDetails('${doc.id}')">üëÅÔ∏è View</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteEmployee('${doc.id}')">üóëÔ∏è Delete</button>
                        </div>
                    `;
                    employeeList.appendChild(employeeDiv);
                });
            } catch (error) {
                console.error('Error loading employees:', error);
            }
        }

        // Calculate experience
        function calculateExperience(joinDate) {
            const join = new Date(joinDate);
            const now = new Date();
            const diffTime = Math.abs(now - join);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 30) {
                return `${diffDays} days`;
            } else if (diffDays < 365) {
                const months = Math.floor(diffDays / 30);
                return `${months} month${months > 1 ? 's' : ''}`;
            } else {
                const years = Math.floor(diffDays / 365);
                const remainingMonths = Math.floor((diffDays % 365) / 30);
                return `${years}y ${remainingMonths}m`;
            }
        }

        // View employee details
        async function viewEmployeeDetails(empId) {
            try {
                const doc = await db.collection('employees').doc(empId).get();
                if (doc.exists) {
                    const employee = doc.data();
                    const details = `
                        <strong>Name:</strong> ${employee.name}<br>
                        <strong>Employee ID:</strong> ${employee.empId}<br>
                        <strong>Email:</strong> ${employee.email || 'N/A'}<br>
                        <strong>Phone:</strong> ${employee.phone || 'N/A'}<br>
                        <strong>Department:</strong> ${employee.department}<br>
                        <strong>Designation:</strong> ${employee.designation || 'N/A'}<br>
                        <strong>Salary:</strong> ${employee.salary ? '‚Çπ' + employee.salary.toLocaleString('en-IN') : 'N/A'}<br>
                        <strong>Joining Date:</strong> ${new Date(employee.joinDate).toLocaleDateString('en-IN')}<br>
                        <strong>Manager:</strong> ${employee.manager || 'N/A'}<br>
                        <strong>Shift:</strong> ${employee.shift || 'N/A'}<br>
                        <strong>Address:</strong> ${employee.address || 'N/A'}
                    `;
                    alert(details); // You can replace this with a modal for better UX
                }
            } catch (error) {
                alert('Error loading employee details: ' + error.message);
            }
        }

        // Update dashboard statistics
        async function updateDashboardStats() {
            try {
                // Get total employees
                const employeesSnapshot = await db.collection('employees').get();
                const totalEmployees = employeesSnapshot.size;
                
                // Get today's attendance
                const today = new Date().toDateString();
                const attendanceSnapshot = await db.collection('attendance')
                    .where('date', '==', today)
                    .get();
                
                let presentToday = 0;
                let lateToday = 0;
                
                attendanceSnapshot.forEach(doc => {
                    const record = doc.data();
                    if (record.punchIn) {
                        presentToday++;
                        
                        // Check if late (assuming 9:30 AM is the standard time)
                        const punchInTime = new Date(record.punchIn.seconds * 1000);
                        const standardTime = new Date(punchInTime);
                        standardTime.setHours(9, 30, 0, 0);
                        
                        if (punchInTime > standardTime) {
                            lateToday++;
                        }
                    }
                });
                
                const absentToday = totalEmployees - presentToday;
                
                // Update UI
                const updateStat = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = value;
                };
                
                updateStat('totalEmployees', totalEmployees);
                updateStat('presentToday', presentToday);
                updateStat('absentToday', absentToday);
                updateStat('lateToday', lateToday);
                
            } catch (error) {
                console.error('Error updating dashboard stats:', error);
            }
        }

        // Load employees for report dropdown
        async function loadEmployeesForReport() {
            try {
                const snapshot = await db.collection('employees').get();
                const select = document.getElementById('reportEmployee');
                select.innerHTML = '<option value="">All Employees</option>';

                snapshot.forEach(doc => {
                    const employee = doc.data();
                    const option = document.createElement('option');
                    option.value = employee.empId;
                    option.textContent = `${employee.name} (${employee.empId})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading employees for report:', error);
            }
        }

        // Delete employee
        async function deleteEmployee(empId) {
            if (confirm('Are you sure you want to delete this employee?')) {
                try {
                    await db.collection('employees').doc(empId).delete();
                    showAlert('employeeAlert', 'Employee deleted successfully', 'success');
                    loadEmployees();
                    loadEmployeesForReport();
                } catch (error) {
                    showAlert('employeeAlert', 'Error deleting employee: ' + error.message, 'error');
                }
            }
        }

        // Initialize camera for employee
        async function initializeCamera() {
            console.log('üé¨ Initializing camera...');
            
            try {
                // Check if browser supports getUserMedia
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    const errorMsg = 'Camera access is not supported in this browser. Please use a modern browser like Chrome, Firefox, or Safari.';
                    console.error(errorMsg);
                    alert(errorMsg);
                    return;
                }

                console.log('üì± Browser supports camera access');

                // Request camera permission with better constraints
                const constraints = {
                    video: {
                        width: { ideal: 640, max: 1280 },
                        height: { ideal: 480, max: 720 },
                        facingMode: 'user',
                        frameRate: { ideal: 15, max: 30 }
                    },
                    audio: false
                };

                console.log('üîß Requesting camera with constraints:', constraints);
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                console.log('‚úÖ Camera stream obtained:', videoStream);
                
                const video = document.getElementById('video');
                
                if (video) {
                    video.srcObject = videoStream;
                    console.log('üì∫ Video source set');
                    
                    // Wait for video to load
                    video.onloadedmetadata = () => {
                        console.log('üìê Video metadata loaded. Dimensions:', video.videoWidth, 'x', video.videoHeight);
                        video.play().then(() => {
                            console.log('‚ñ∂Ô∏è Video playing successfully');
                            
                            // Enable capture button once video is ready
                            const captureBtn = document.getElementById('captureBtn');
                            if (captureBtn) {
                                captureBtn.disabled = false;
                                captureBtn.textContent = 'üì∏ Capture & Punch In';
                                console.log('üîò Capture button enabled');
                            }
                        }).catch(error => {
                            console.error('‚ùå Error playing video:', error);
                        });
                    };

                    video.onerror = (error) => {
                        console.error('‚ùå Video error:', error);
                    };
                } else {
                    console.error('‚ùå Video element not found');
                }
                
                console.log('‚úÖ Camera initialized successfully');
            } catch (error) {
                console.error('‚ùå Error accessing camera:', error);
                let errorMessage = 'Camera access failed. ';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'Please allow camera permission and refresh the page.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'No camera found on this device.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage += 'Camera is being used by another application.';
                } else {
                    errorMessage += error.message;
                }
                
                console.error('üö® Final error message:', errorMessage);
                alert(errorMessage);
                
                // Disable capture button if camera fails
                const captureBtn = document.getElementById('captureBtn');
                if (captureBtn) {
                    captureBtn.disabled = true;
                    captureBtn.textContent = '‚ùå Camera Not Available';
                    captureBtn.style.background = '#e53e3e';
                    console.log('üîò Capture button disabled due to camera error');
                }
            }
        }

        // Test function for debugging
        function testCaptureButton() {
            console.log('üß™ Testing capture button functionality...');
            const captureBtn = document.getElementById('captureBtn');
            console.log('Button element:', captureBtn);
            console.log('Button disabled:', captureBtn?.disabled);
            console.log('Button text:', captureBtn?.textContent);
            console.log('Current user:', currentUser);
            
            if (captureBtn && !captureBtn.disabled) {
                console.log('‚úÖ Button is ready for capture');
            } else {
                console.log('‚ùå Button is not ready');
            }
        }

        // Check attendance status
        async function checkAttendanceStatus() {
            try {
                if (!currentUser || !currentUser.empId) {
                    console.error('Current user not found');
                    return;
                }

                const today = new Date().toDateString();
                console.log('Checking attendance status for:', currentUser.empId, 'on:', today);
                
                const attendanceRef = db.collection('attendance')
                    .where('empId', '==', currentUser.empId)
                    .where('date', '==', today);
                
                const snapshot = await attendanceRef.get();
                console.log('Found', snapshot.size, 'attendance records for today');
                
                const captureBtn = document.getElementById('captureBtn');
                
                if (!snapshot.empty) {
                    const todayAttendance = snapshot.docs[0].data();
                    console.log('Today attendance data:', todayAttendance);
                    
                    if (todayAttendance.punchOut) {
                        // Already punched out
                        console.log('Already punched out');
                        updateAttendanceUI('out', `Punched out at ${new Date(todayAttendance.punchOut.seconds * 1000).toLocaleTimeString('en-IN')}`);
                        captureBtn.disabled = true;
                        captureBtn.textContent = '‚úÖ Completed for Today';
                        captureBtn.style.background = '#38a169';
                    } else if (todayAttendance.punchIn) {
                        // Punched in but not out
                        console.log('Punched in, waiting for punch out');
                        updateAttendanceUI('in', `Punched in at ${new Date(todayAttendance.punchIn.seconds * 1000).toLocaleTimeString('en-IN')}`);
                        captureBtn.textContent = 'üì∏ Capture & Punch Out';
                        captureBtn.disabled = false;
                        captureBtn.style.background = '';
                    }
                } else {
                    // Not punched in yet
                    console.log('Not punched in yet');
                    updateAttendanceUI('ready', 'Ready to punch in for today');
                    captureBtn.textContent = 'üì∏ Capture & Punch In';
                    captureBtn.disabled = false;
                    captureBtn.style.background = '';
                }
            } catch (error) {
                console.error('Error checking attendance status:', error);
                showAlert('', 'Error checking attendance status: ' + error.message, 'error');
            }
        }

        // Update attendance UI
        function updateAttendanceUI(status, message) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const lastAction = document.getElementById('lastAction');

            if (status === 'in') {
                indicator.className = 'status-indicator status-in';
                indicator.innerHTML = '<span>‚úÖ</span>';
                statusText.textContent = 'Punched In';
                statusText.style.color = '#38a169';
            } else if (status === 'out') {
                indicator.className = 'status-indicator status-out';
                indicator.innerHTML = '<span>‚èπÔ∏è</span>';
                statusText.textContent = 'Punched Out';
                statusText.style.color = '#e53e3e';
            } else {
                indicator.className = 'status-indicator status-ready';
                indicator.innerHTML = '<span>üì∑</span>';
                statusText.textContent = 'Ready to Punch In';
                statusText.style.color = '#3182ce';
            }
            
            lastAction.textContent = message;
        }

        // Capture attendance
        async function captureAttendance() {
            console.log('üéØ Capture attendance function called');
            
            try {
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
                const captureBtn = document.getElementById('captureBtn');
                
                console.log('üìπ Video element:', video);
                console.log('üñºÔ∏è Canvas element:', canvas);
                console.log('üîò Button element:', captureBtn);
                
                if (!video || !canvas) {
                    alert('‚ùå Video or canvas element not found');
                    return;
                }

                if (!video.videoWidth || !video.videoHeight) {
                    alert('üì∑ Camera is not ready. Please wait for camera to load and try again.');
                    console.log('Video dimensions:', video.videoWidth, 'x', video.videoHeight);
                    return;
                }

                if (!currentUser || !currentUser.empId) {
                    alert('‚ùå User not logged in properly');
                    return;
                }

                console.log('üë§ Current user:', currentUser);

                // Disable button during processing
                captureBtn.disabled = true;
                captureBtn.innerHTML = '<span class="loading"></span> Processing...';

                const context = canvas.getContext('2d');

                // Set canvas dimensions to match video
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                console.log('üìê Canvas dimensions set to:', canvas.width, 'x', canvas.height);

                // Draw current video frame to canvas
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                console.log('üé® Image drawn to canvas');

                // Convert canvas to blob
                const imageBlob = await new Promise((resolve) => {
                    canvas.toBlob((blob) => {
                        console.log('üì∏ Image blob created:', blob);
                        resolve(blob);
                    }, 'image/jpeg', 0.8);
                });
                
                if (!imageBlob) {
                    throw new Error('Failed to capture image from canvas');
                }

                const now = new Date();
                const today = now.toDateString();
                
                console.log('üìÖ Checking attendance for:', currentUser.empId, 'on:', today);
                
                // Check if already punched in today
                const attendanceQuery = db.collection('attendance')
                    .where('empId', '==', currentUser.empId)
                    .where('date', '==', today);
                
                const snapshot = await attendanceQuery.get();
                console.log('üìä Attendance query result:', snapshot.size, 'records found');
                
                // Upload image to Firebase Storage
                const imageName = `${currentUser.empId}_${now.getTime()}.jpg`;
                const imageRef = storage.ref().child('attendance-photos/' + imageName);
                
                console.log('‚òÅÔ∏è Uploading image:', imageName);
                const uploadTask = await imageRef.put(imageBlob);
                const imageUrl = await uploadTask.ref.getDownloadURL();
                console.log('‚úÖ Image uploaded successfully:', imageUrl);

                if (snapshot.empty) {
                    // First punch in
                    console.log('‚è∞ Creating new attendance record - PUNCH IN');
                    
                    const attendanceData = {
                        empId: currentUser.empId,
                        empName: currentUser.name,
                        date: today,
                        punchIn: now,
                        punchInPhoto: imageUrl,
                        punchOut: null,
                        punchOutPhoto: null,
                        createdAt: now
                    };
                    
                    console.log('üíæ Saving attendance data:', attendanceData);
                    await db.collection('attendance').add(attendanceData);
                    
                    updateAttendanceUI('in', 'Punched in at ' + now.toLocaleTimeString('en-IN'));
                    captureBtn.textContent = 'üì∏ Capture & Punch Out';
                    captureBtn.disabled = false;
                    captureBtn.style.background = '';
                    updateEmployeeStats();
                    
                    alert('‚úÖ Successfully punched in at ' + now.toLocaleTimeString('en-IN'));
                    console.log('üéâ Punch in completed successfully');
                } else {
                    // Punch out
                    console.log('üèÅ Updating existing attendance record - PUNCH OUT');
                    
                    const docId = snapshot.docs[0].id;
                    const updateData = {
                        punchOut: now,
                        punchOutPhoto: imageUrl,
                        updatedAt: now
                    };
                    
                    console.log('üíæ Updating attendance with ID:', docId, 'Data:', updateData);
                    await db.collection('attendance').doc(docId).update(updateData);
                    
                    updateAttendanceUI('out', 'Punched out at ' + now.toLocaleTimeString('en-IN'));
                    captureBtn.disabled = true;
                    captureBtn.textContent = '‚úÖ Completed for Today';
                    captureBtn.style.background = '#38a169';
                    updateEmployeeStats();
                    
                    alert('‚úÖ Successfully punched out at ' + now.toLocaleTimeString('en-IN'));
                    console.log('üéâ Punch out completed successfully');
                }
            } catch (error) {
                console.error('‚ùå Error in captureAttendance:', error);
                console.error('Error stack:', error.stack);
                alert('‚ùå Error recording attendance: ' + error.message + '\n\nPlease check console for details and try again.');
                
                // Re-enable button
                const captureBtn = document.getElementById('captureBtn');
                if (captureBtn) {
                    captureBtn.disabled = false;
                    captureBtn.textContent = 'üîÑ Try Again';
                    captureBtn.style.background = '';
                }
            }
        }

        // Generate report
        async function generateReport() {
            const employeeId = document.getElementById('reportEmployee').value;
            const period = document.getElementById('reportPeriod').value;
            const selectedDate = new Date(document.getElementById('reportDate').value);

            try {
                let startDate, endDate;
                
                switch (period) {
                    case 'daily':
                        startDate = endDate = selectedDate.toDateString();
                        break;
                    case 'weekly':
                        const weekStart = new Date(selectedDate);
                        weekStart.setDate(selectedDate.getDate() - selectedDate.getDay());
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);
                        startDate = weekStart.toDateString();
                        endDate = weekEnd.toDateString();
                        break;
                    case 'monthly':
                        startDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1).toDateString();
                        endDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 0).toDateString();
                        break;
                    case 'yearly':
                        startDate = new Date(selectedDate.getFullYear(), 0, 1).toDateString();
                        endDate = new Date(selectedDate.getFullYear(), 11, 31).toDateString();
                        break;
                }

                let query = db.collection('attendance');
                
                if (employeeId) {
                    query = query.where('empId', '==', employeeId);
                }

                const snapshot = await query.get();
                const attendanceData = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const recordDate = data.date;
                    
                    // Filter by date range
                    if (period === 'daily') {
                        if (recordDate === startDate) {
                            attendanceData.push(data);
                        }
                    } else {
                        const checkDate = new Date(recordDate);
                        const start = new Date(startDate);
                        const end = new Date(endDate);
                        
                        if (checkDate >= start && checkDate <= end) {
                            attendanceData.push(data);
                        }
                    }
                });

                currentReportData = attendanceData;
                displayReport(attendanceData, period);
            } catch (error) {
                alert('Error generating report: ' + error.message);
            }
        }

        // Generate employee report
        async function generateEmployeeReport() {
            const period = document.getElementById('empReportPeriod').value;
            const selectedDate = new Date(document.getElementById('empReportDate').value);

            try {
                let startDate, endDate;
                
                switch (period) {
                    case 'daily':
                        startDate = endDate = selectedDate.toDateString();
                        break;
                    case 'weekly':
                        const weekStart = new Date(selectedDate);
                        weekStart.setDate(selectedDate.getDate() - selectedDate.getDay());
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);
                        startDate = weekStart.toDateString();
                        endDate = weekEnd.toDateString();
                        break;
                    case 'monthly':
                        startDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1).toDateString();
                        endDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 0).toDateString();
                        break;
                    case 'yearly':
                        startDate = new Date(selectedDate.getFullYear(), 0, 1).toDateString();
                        endDate = new Date(selectedDate.getFullYear(), 11, 31).toDateString();
                        break;
                }

                const query = db.collection('attendance').where('empId', '==', currentUser.empId);
                const snapshot = await query.get();
                const attendanceData = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const recordDate = data.date;
                    
                    // Filter by date range
                    if (period === 'daily') {
                        if (recordDate === startDate) {
                            attendanceData.push(data);
                        }
                    } else {
                        const checkDate = new Date(recordDate);
                        const start = new Date(startDate);
                        const end = new Date(endDate);
                        
                        if (checkDate >= start && checkDate <= end) {
                            attendanceData.push(data);
                        }
                    }
                });

                currentReportData = attendanceData;
                displayEmployeeReport(attendanceData, period);
            } catch (error) {
                alert('Error generating report: ' + error.message);
            }
        }

        // Display report
        function displayReport(data, period) {
            const container = document.getElementById('reportContainer');
            
            if (data.length === 0) {
                container.innerHTML = '<div class="alert alert-info">üìä No attendance records found for the selected period.</div>';
                return;
            }

            // Calculate analytics
            let totalHours = 0;
            let completeRecords = 0;
            let lateArrivals = 0;
            
            data.forEach(record => {
                const punchIn = record.punchIn ? new Date(record.punchIn.seconds * 1000) : null;
                const punchOut = record.punchOut ? new Date(record.punchOut.seconds * 1000) : null;
                
                if (punchIn && punchOut) {
                    const hours = Math.abs(punchOut - punchIn) / 36e5;
                    totalHours += hours;
                    completeRecords++;
                }
                
                // Check if late (after 9:30 AM)
                if (punchIn) {
                    const standardTime = new Date(punchIn);
                    standardTime.setHours(9, 30, 0, 0);
                    if (punchIn > standardTime) {
                        lateArrivals++;
                    }
                }
            });

            const avgHours = completeRecords > 0 ? (totalHours / completeRecords).toFixed(1) : '0';
            const attendanceRate = data.length > 0 ? ((completeRecords / data.length) * 100).toFixed(1) : '0';
            const punctualityRate = data.length > 0 ? (((data.length - lateArrivals) / data.length) * 100).toFixed(1) : '0';

            // Update stats
            const updateReportStat = (id, value) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            };
            
            updateReportStat('avgWorkingHours', avgHours + 'h');
            updateReportStat('attendanceRate', attendanceRate + '%');
            updateReportStat('punctualityRate', punctualityRate + '%');
            updateReportStat('totalWorkingDays', data.length);

            let html = `
                <table class="attendance-table">
                    <thead>
                        <tr>
                            <th>Employee ID</th>
                            <th>Employee Name</th>
                            <th>Date</th>
                            <th>Punch In</th>
                            <th>Punch Out</th>
                            <th>Working Hours</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach(record => {
                const punchIn = record.punchIn ? new Date(record.punchIn.seconds * 1000) : null;
                const punchOut = record.punchOut ? new Date(record.punchOut.seconds * 1000) : null;
                
                let workingHours = 'N/A';
                let status = 'Incomplete';
                let statusClass = 'status-incomplete';
                
                if (punchIn && punchOut) {
                    const hours = Math.abs(punchOut - punchIn) / 36e5;
                    workingHours = hours.toFixed(2) + ' hours';
                    status = 'Complete';
                    statusClass = 'status-complete';
                } else if (punchIn) {
                    status = 'Punched In';
                    statusClass = 'status-partial';
                }

                html += `
                    <tr>
                        <td><strong>${record.empId}</strong></td>
                        <td>${record.empName}</td>
                        <td>${new Date(record.date).toLocaleDateString('en-IN')}</td>
                        <td>${punchIn ? punchIn.toLocaleTimeString('en-IN') : 'N/A'}</td>
                        <td>${punchOut ? punchOut.toLocaleTimeString('en-IN') : 'N/A'}</td>
                        <td>${workingHours}</td>
                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Display employee report
        function displayEmployeeReport(data, period) {
            const container = document.getElementById('empReportContainer');
            
            if (data.length === 0) {
                container.innerHTML = '<div class="alert alert-info">üìä No attendance records found for the selected period.</div>';
                return;
            }

            let html = `
                <table class="attendance-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Punch In</th>
                            <th>Punch Out</th>
                            <th>Working Hours</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach(record => {
                const punchIn = record.punchIn ? new Date(record.punchIn.seconds * 1000) : null;
                const punchOut = record.punchOut ? new Date(record.punchOut.seconds * 1000) : null;
                
                let workingHours = 'N/A';
                let status = 'Incomplete';
                let statusClass = 'status-incomplete';
                
                if (punchIn && punchOut) {
                    const hours = Math.abs(punchOut - punchIn) / 36e5;
                    workingHours = hours.toFixed(2) + ' hours';
                    status = 'Complete';
                    statusClass = 'status-complete';
                } else if (punchIn) {
                    status = 'Punched In';
                    statusClass = 'status-partial';
                }

                html += `
                    <tr>
                        <td>${new Date(record.date).toLocaleDateString('en-IN')}</td>
                        <td>${punchIn ? punchIn.toLocaleTimeString('en-IN') : 'N/A'}</td>
                        <td>${punchOut ? punchOut.toLocaleTimeString('en-IN') : 'N/A'}</td>
                        <td>${workingHours}</td>
                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Download report as PDF
        function downloadReport() {
            if (!currentReportData || currentReportData.length === 0) {
                alert('Please generate a report first');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Add company branding
            doc.setFontSize(20);
            doc.setTextColor(212, 175, 55);
            doc.text('Ambivare Solutions', 20, 20);
            
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('Attendance Report', 20, 35);
            
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 45);

            // Prepare table data
            const tableData = currentReportData.map(record => {
                const punchIn = record.punchIn ? new Date(record.punchIn.seconds * 1000) : null;
                const punchOut = record.punchOut ? new Date(record.punchOut.seconds * 1000) : null;
                
                let workingHours = 'N/A';
                if (punchIn && punchOut) {
                    const hours = Math.abs(punchOut - punchIn) / 36e5;
                    workingHours = hours.toFixed(2) + ' hrs';
                }

                return [
                    record.empId,
                    record.empName,
                    record.date,
                    punchIn ? punchIn.toLocaleTimeString() : 'N/A',
                    punchOut ? punchOut.toLocaleTimeString() : 'N/A',
                    workingHours
                ];
            });

            // Add table
            doc.autoTable({
                head: [['Employee ID', 'Name', 'Date', 'Punch In', 'Punch Out', 'Hours']],
                body: tableData,
                startY: 55,
                theme: 'grid',
                headStyles: {
                    fillColor: [212, 175, 55],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [248, 246, 240]
                }
            });

            // Save the PDF
            doc.save('attendance-report.pdf');
        }

        // Download employee report as PDF
        function downloadEmployeeReport() {
            if (!currentReportData || currentReportData.length === 0) {
                alert('Please generate a report first');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Add company branding
            doc.setFontSize(20);
            doc.setTextColor(212, 175, 55);
            doc.text('Ambivare Solutions', 20, 20);
            
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text(`Attendance Report - ${currentUser.name}`, 20, 35);
            
            doc.setFontSize(12);
            doc.text(`Employee ID: ${currentUser.empId}`, 20, 45);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 55);

            // Prepare table data
            const tableData = currentReportData.map(record => {
                const punchIn = record.punchIn ? new Date(record.punchIn.seconds * 1000) : null;
                const punchOut = record.punchOut ? new Date(record.punchOut.seconds * 1000) : null;
                
                let workingHours = 'N/A';
                if (punchIn && punchOut) {
                    const hours = Math.abs(punchOut - punchIn) / 36e5;
                    workingHours = hours.toFixed(2) + ' hrs';
                }

                return [
                    record.date,
                    punchIn ? punchIn.toLocaleTimeString() : 'N/A',
                    punchOut ? punchOut.toLocaleTimeString() : 'N/A',
                    workingHours
                ];
            });

            // Add table
            doc.autoTable({
                head: [['Date', 'Punch In', 'Punch Out', 'Working Hours']],
                body: tableData,
                startY: 65,
                theme: 'grid',
                headStyles: {
                    fillColor: [212, 175, 55],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [248, 246, 240]
                }
            });

            // Save the PDF
            doc.save(`${currentUser.name}-attendance-report.pdf`);
        }

        // Utility function to show alerts
        function showAlert(containerId, message, type) {
            // If no container specified, use a default based on current view
            if (!containerId) {
                if (currentUserType === 'employee') {
                    containerId = 'employeeAlerts';
                } else {
                    containerId = 'employeeAlert'; // fallback
                }
            }
            
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            } else {
                // Fallback to browser alert if container not found
                alert(message);
            }
        }

        // Toggle login fields
        function toggleLoginFields() {
            // This function can be used if you want different fields for admin vs employee
        }

        // Export to Excel
        function exportToExcel() {
            if (!currentReportData || currentReportData.length === 0) {
                alert('Please generate a report first');
                return;
            }

            // Prepare data for Excel
            const excelData = currentReportData.map(record => {
                const punchIn = record.punchIn ? new Date(record.punchIn.seconds * 1000) : null;
                const punchOut = record.punchOut ? new Date(record.punchOut.seconds * 1000) : null;
                
                let workingHours = 'N/A';
                let status = 'Incomplete';
                
                if (punchIn && punchOut) {
                    const hours = Math.abs(punchOut - punchIn) / 36e5;
                    workingHours = hours.toFixed(2);
                    status = 'Complete';
                } else if (punchIn) {
                    status = 'Punched In';
                }

                return {
                    'Employee ID': record.empId,
                    'Employee Name': record.empName,
                    'Date': record.date,
                    'Punch In': punchIn ? punchIn.toLocaleTimeString('en-IN') : 'N/A',
                    'Punch Out': punchOut ? punchOut.toLocaleTimeString('en-IN') : 'N/A',
                    'Working Hours': workingHours,
                    'Status': status
                };
            });

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, "Attendance Report");
            
            // Generate Excel file and download
            XLSX.writeFile(wb, `Ambivare_Attendance_Report_${new Date().toLocaleDateString('en-IN').replace(/\//g, '-')}.xlsx`);
        }
    </script>
</body>
</html>
