<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ambivare Solutions - Attendance Management</title>
    
    <!-- External Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* CSS Styles - Corporate Theme */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f9f6f2;
            color: #333;
            line-height: 1.6;
        }

        /* Login Page Styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f9f6f2 0%, #fff 100%);
        }

        .login-card {
            background: white;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            border: 1px solid #e5e5e5;
        }

        .logo {
            text-align: center;
            margin-bottom: 2rem;
        }

        .logo h1 {
            color: #2c3e50;
            font-weight: 700;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .logo p {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .login-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e5e5e5;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #666;
        }

        .tab-btn.active {
            background: #2c3e50;
            color: white;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2c3e50;
            box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: #2c3e50;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .login-btn:hover {
            background: #34495e;
        }

        /* Dashboard Styles */
        .dashboard {
            display: none;
            min-height: 100vh;
        }

        .dashboard-header {
            background: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-header h1 {
            color: #2c3e50;
            font-size: 1.5rem;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: #2c3e50;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .logout-btn {
            padding: 8px 16px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .dashboard-content {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e5e5e5;
            padding: 2rem 0;
        }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-nav li {
            margin-bottom: 0.5rem;
        }

        .sidebar-nav a {
            display: block;
            padding: 12px 2rem;
            color: #666;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .sidebar-nav a:hover,
        .sidebar-nav a.active {
            background: #f8f9fa;
            color: #2c3e50;
            border-left-color: #2c3e50;
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .card {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
            border: 1px solid #e5e5e5;
        }

        .card h2 {
            margin-bottom: 1.5rem;
            color: #2c3e50;
            font-size: 1.4rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #2c3e50;
            color: white;
        }

        .btn-primary:hover {
            background: #34495e;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e5e5;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* QR Code Styles */
        .qr-container {
            text-align: center;
            margin: 2rem 0;
        }

        #qr-reader {
            width: 100%;
            max-width: 400px;
            margin: 1rem auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e5e5e5;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                order: 2;
                padding: 1rem 0;
            }

            .sidebar-nav {
                display: flex;
                overflow-x: auto;
                padding: 0 1rem;
                gap: 0.5rem;
            }

            .sidebar-nav li {
                margin-bottom: 0;
                flex-shrink: 0;
            }

            .sidebar-nav a {
                padding: 8px 16px;
                border-radius: 6px;
                border-left: none;
                white-space: nowrap;
                font-size: 0.9rem;
            }

            .sidebar-nav a:hover,
            .sidebar-nav a.active {
                background: #2c3e50;
                color: white;
                border-left: none;
            }

            .main-content {
                order: 1;
                padding: 1rem;
                width: 100%;
            }

            .form-row {
                flex-direction: column;
                gap: 0.5rem;
            }

            .dashboard-header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .dashboard-header h1 {
                font-size: 1.2rem;
            }

            .user-profile {
                justify-content: center;
            }

            .login-card {
                margin: 1rem;
                padding: 1.5rem;
                max-width: none;
            }

            .logo h1 {
                font-size: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-number {
                font-size: 1.5rem;
            }

            .card {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .card h2 {
                font-size: 1.2rem;
                margin-bottom: 1rem;
            }

            table {
                font-size: 0.8rem;
            }

            th, td {
                padding: 8px 4px;
            }

            .btn {
                padding: 8px 16px;
                font-size: 0.9rem;
            }

            .scan-btn {
                font-size: 1rem;
                padding: 0.8rem 1.5rem;
            }

            #qr-reader {
                max-width: 300px;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .login-card {
                margin: 0.5rem;
                padding: 1rem;
            }

            .dashboard-header {
                padding: 0.5rem;
            }

            .main-content {
                padding: 0.5rem;
            }

            .card {
                padding: 0.8rem;
            }

            table {
                font-size: 0.7rem;
            }

            th, td {
                padding: 6px 2px;
            }

            .form-group input,
            .form-group select {
                padding: 10px;
            }
        }

        /* Loading and Alert Styles */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none !important;
        }

        /* Employee Dashboard Specific */
        .employee-dashboard .sidebar {
            display: none;
        }

        .employee-dashboard .main-content {
            width: 100%;
        }

        .scan-section {
            text-align: center;
            padding: 1.5rem;
        }

        .scan-btn {
            font-size: 1.1rem;
            padding: 1rem 2rem;
            margin: 1rem 0.5rem;
            min-width: 180px;
        }

        .lunch-out-btn {
            background: #f39c12 !important;
            border-color: #f39c12 !important;
        }

        .lunch-out-btn:hover {
            background: #e67e22 !important;
            border-color: #e67e22 !important;
        }

        .lunch-in-btn {
            background: #27ae60 !important;
            border-color: #27ae60 !important;
        }

        .lunch-in-btn:hover {
            background: #229954 !important;
            border-color: #229954 !important;
        }

        #qr-reader {
            margin: 1rem auto;
            max-width: 400px;
            width: 100%;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            min-height: 300px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #qr-video {
            width: 100% !important;
            height: auto !important;
            max-width: 400px !important;
            border-radius: 8px !important;
            display: block !important;
            background: black !important;
            object-fit: cover !important;
        }

        /* Mobile specific adjustments */
        @media (max-width: 480px) {
            #qr-reader {
                max-width: 320px;
                min-height: 250px;
            }
            
            #qr-video {
                max-width: 320px !important;
            }
        }

        #scanResult {
            margin-top: 1rem;
        }

        @media (max-width: 480px) {
            .scan-section {
                padding: 1rem;
            }

            .scan-btn {
                font-size: 1rem;
                padding: 0.8rem 1.5rem;
                margin: 0.5rem 0.25rem;
                min-width: 150px;
                display: block;
                width: 100%;
                max-width: 200px;
                margin: 0.5rem auto;
            }

            #qr-reader {
                max-width: 280px;
            }

            .dashboard-header h1 {
                font-size: 1rem;
            }

            .user-profile {
                flex-direction: column;
                gap: 0.5rem;
            }

            .user-avatar {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="logo">
                <h1>Ambivare Solutions</h1>
                <p>Attendance Management System</p>
            </div>
            
            <div class="login-tabs">
                <button class="tab-btn active" onclick="switchTab('admin')">Admin</button>
                <button class="tab-btn" onclick="switchTab('employee')">Employee</button>
            </div>

            <!-- Admin Login Form -->
            <form id="adminLogin" class="login-form">
                <div class="form-group">
                    <label for="adminUsername">Username</label>
                    <input type="text" id="adminUsername" required>
                </div>
                <div class="form-group">
                    <label for="adminId">Admin ID</label>
                    <input type="text" id="adminId" required>
                </div>
                <button type="submit" class="login-btn">Login as Admin</button>
            </form>

            <!-- Employee Login Form -->
            <form id="employeeLogin" class="login-form hidden">
                <div class="form-group">
                    <label for="employeeId">Employee ID</label>
                    <input type="text" id="employeeId" required>
                </div>
                <button type="submit" class="login-btn">Login as Employee</button>
            </form>

            <div id="loginAlert"></div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="dashboard">
        <header class="dashboard-header">
            <h1>Admin Dashboard - Ambivare Solutions</h1>
            <div class="user-profile">
                <div class="user-avatar" id="adminAvatar">S</div>
                <span id="adminName">Welcome back, Siddhant</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="dashboard-content">
            <aside class="sidebar">
                <nav>
                    <ul class="sidebar-nav">
                        <li><a href="#" class="nav-link active" data-section="dashboard">Dashboard</a></li>
                        <li><a href="#" class="nav-link" data-section="addEmployee">Add Employee</a></li>
                        <li><a href="#" class="nav-link" data-section="generateQR">Generate QR Code</a></li>
                        <li><a href="#" class="nav-link" data-section="viewAttendance">View Attendance</a></li>
                        <li><a href="#" class="nav-link" data-section="salarySlips">üí∞ Salary Slips</a></li>
                        <li><a href="#" class="nav-link" data-section="reports">Reports & Analytics</a></li>
                    </ul>
                </nav>
            </aside>

            <main class="main-content">
                <!-- Dashboard Overview -->
                <section id="dashboard" class="content-section active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalEmployees">0</div>
                            <div class="stat-label">Total Employees</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="presentToday">0</div>
                            <div class="stat-label">Present Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="absentToday">0</div>
                            <div class="stat-label">Absent Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="attendanceRate">0%</div>
                            <div class="stat-label">Attendance Rate</div>
                        </div>
                    </div>

                    <div class="card">
                        <h2>Recent Activity</h2>
                        <div id="recentActivity" class="loading">Loading recent activity...</div>
                    </div>
                </section>

                <!-- Add Employee -->
                <section id="addEmployee" class="content-section">
                    <div class="card">
                        <h2>Add New Employee</h2>
                        <form id="addEmployeeForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="empName">Employee Name</label>
                                    <input type="text" id="empName" required>
                                </div>
                                <div class="form-group">
                                    <label for="empId">Employee ID</label>
                                    <input type="text" id="empId" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="empEmail">Email</label>
                                    <input type="email" id="empEmail" required>
                                </div>
                                <div class="form-group">
                                    <label for="empDesignation">Designation</label>
                                    <input type="text" id="empDesignation" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Employee</button>
                        </form>
                    </div>

                    <div class="card">
                        <h2>Employee List</h2>
                        <div class="table-container">
                            <table id="employeeTable">
                                <thead>
                                    <tr>
                                        <th>Employee ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Designation</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Employee data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Generate QR Code -->
                <section id="generateQR" class="content-section">
                    <div class="card">
                        <h2>Generate Universal QR Code</h2>
                        <p>Generate a single QR code that can be used by all employees for attendance marking.</p>
                        <button onclick="generateUniversalQR()" class="btn btn-primary">Generate Universal QR Code</button>
                        
                        <div id="qrDisplay" class="qr-container hidden">
                            <h3>Universal Attendance QR Code</h3>
                            <canvas id="qrCanvas"></canvas>
                            <p>This QR code can be used by all employees for check-in/check-out.</p>
                            <p style="color: #e74c3c; font-weight: 500;">‚ö†Ô∏è Keep this QR code secure and display it only in authorized areas.</p>
                            <button onclick="downloadQR()" class="btn btn-success">Download QR Code</button>
                            <button onclick="refreshQR()" class="btn btn-warning">Refresh QR Code</button>
                        </div>
                    </div>

                    <div class="card">
                        <h2>QR Code Management</h2>
                        <div id="qrStatus">
                            <p>Loading QR code status...</p>
                        </div>
                    </div>
                </section>

                <!-- View Attendance -->
                <section id="viewAttendance" class="content-section">
                    <div class="card">
                        <h2>Attendance Records</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="attendanceEmployeeFilter">Filter by Employee</label>
                                <select id="attendanceEmployeeFilter" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="">All Employees</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="attendanceDateFilter">Filter by Date</label>
                                <input type="date" id="attendanceDateFilter" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                        </div>
                        <button onclick="loadAttendanceData()" class="btn btn-primary">Load Attendance</button>
                        
                        <div class="table-container">
                            <table id="attendanceTable">
                                <thead>
                                    <tr>
                                        <th>Employee ID</th>
                                        <th>Employee Name</th>
                                        <th>Date</th>
                                        <th>Check In</th>
                                        <th>Lunch Out</th>
                                        <th>Lunch In</th>
                                        <th>Check Out</th>
                                        <th>Total Hours</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Attendance data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Reports & Analytics -->
                <section id="reports" class="content-section">
                    <div class="card">
                        <h2>Reports & Analytics</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="reportEmployeeSelect">Select Employee for Individual Report</label>
                                <select id="reportEmployeeSelect" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="">Select an employee...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="reportDateRange">Date Range</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="date" id="reportStartDate" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                    <input type="date" id="reportEndDate" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <button onclick="generateIndividualReport()" class="btn btn-success">Generate Individual Report</button>
                            <button onclick="generateOverallReport()" class="btn btn-warning">Generate Overall Analytics</button>
                        </div>
                    </div>
                </section>

                <!-- Salary Slips Section -->
                <section id="salarySlips" class="content-section">
                    <div class="card">
                        <h2>üí∞ Salary Slips Generation</h2>
                        <p style="color: #666; margin-bottom: 2rem;">Generate professional salary slips with automatic PF/ESIC calculations and proper Trivanta Edge branding.</p>
                        
                        <!-- Salary Configuration -->
                        <div class="card" style="margin-bottom: 2rem; background: #f8f9fa;">
                            <h3>Salary Configuration</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="salaryEmployee">Select Employee</label>
                                    <select id="salaryEmployee" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                        <option value="">Select an employee...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="salaryMonth">Select Month</label>
                                    <input type="month" id="salaryMonth" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="grossSalary">Gross Salary (Monthly)</label>
                                    <input type="number" id="grossSalary" placeholder="Enter gross salary" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div class="form-group">
                                    <label for="basicSalaryPercent">Basic Salary % of Gross</label>
                                    <input type="number" id="basicSalaryPercent" value="50" min="30" max="70" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                            
                            <!-- Manual Attendance Input -->
                            <div class="form-row" style="border-top: 1px solid #ddd; padding-top: 1rem; margin-top: 1rem;">
                                <h4 style="color: #2c3e50; margin-bottom: 1rem;">üìÖ Attendance Details (Manual Input)</h4>
                                <button type="button" onclick="setDefaultAttendance()" class="btn btn-secondary" style="margin-bottom: 1rem;">Set Default Values</button>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="totalWorkingDays">Total Working Days</label>
                                    <input type="number" id="totalWorkingDays" value="30" min="28" max="31" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div class="form-group">
                                    <label for="presentDaysInput">Present Days</label>
                                    <input type="number" id="presentDaysInput" placeholder="Enter present days" min="0" max="31" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="paidLeavesAvailable">Paid Leaves Available</label>
                                    <input type="number" id="paidLeavesAvailable" value="2" min="0" max="10" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div class="form-group">
                                    <label for="leavesUsedInput">Leaves Used</label>
                                    <input type="number" id="leavesUsedInput" placeholder="Enter leaves used" min="0" max="10" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                            
                            <!-- PF/ESIC Configuration -->
                            <div class="form-row" style="border-top: 1px solid #ddd; padding-top: 1rem; margin-top: 1rem;">
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="enablePF" checked> Enable PF Deduction (12% of Basic Salary)
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="enableESIC" checked> Enable ESIC Deduction (0.75% of Gross Salary)
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Salary Breakdown within Gross -->
                            <div class="form-row" style="border-top: 1px solid #ddd; padding-top: 1rem; margin-top: 1rem;">
                                <h4 style="color: #2c3e50; margin-bottom: 1rem;">üí∞ Gross Salary Breakdown</h4>
                                <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">
                                    <strong>Note:</strong> All amounts below should add up to the Gross Salary. These are components of the gross, not additions to it.
                                </p>
                                <button type="button" onclick="autoDistributeGross()" class="btn btn-secondary" style="margin-bottom: 1rem;">üéØ Auto Distribute Gross</button>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="hra">HRA Amount (Part of Gross)</label>
                                    <input type="number" id="hra" value="0" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div class="form-group">
                                    <label for="transportAllowance">Transport Allowance</label>
                                    <input type="number" id="transportAllowance" value="0" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="medicalAllowance">Medical Allowance</label>
                                    <input type="number" id="medicalAllowance" value="0" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div class="form-group">
                                    <label for="otherAllowances">Other Allowances</label>
                                    <input type="number" id="otherAllowances" value="0" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                            
                            <!-- Total Check Display -->
                            <div class="form-row">
                                <div class="form-group" style="background: #e8f5e8; padding: 1rem; border-radius: 6px; grid-column: 1 / -1;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span><strong>Breakdown Total:</strong></span>
                                        <span id="breakdownTotal" style="font-size: 1.2rem; font-weight: bold; color: #27ae60;">Rs.0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                                        <span><strong>Gross Salary:</strong></span>
                                        <span id="grossSalaryDisplay" style="font-size: 1.2rem; font-weight: bold; color: #2c3e50;">Rs.0</span>
                                    </div>
                                    <div id="balanceCheck" style="margin-top: 0.5rem; font-weight: bold;"></div>
                                </div>
                            </div>
                            
                            <!-- Additional Earnings (Beyond Gross) -->
                            <div class="form-row" style="border-top: 1px solid #ddd; padding-top: 1rem; margin-top: 1rem;">
                                <h4 style="color: #2c3e50; margin-bottom: 1rem;">üéÅ Additional Earnings (Beyond Gross)</h4>
                                <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">
                                    These amounts will be <strong>added</strong> to the gross salary.
                                </p>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="bonus">Bonus Amount</label>
                                    <input type="number" id="bonus" value="0" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div class="form-group">
                                    <label for="bonusDescription">Bonus Description</label>
                                    <input type="text" id="bonusDescription" placeholder="e.g., Performance Bonus, Festival Bonus" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="incentives">Incentives Amount</label>
                                    <input type="number" id="incentives" value="0" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div class="form-group">
                                    <label for="incentivesDescription">Incentives Description</label>
                                    <input type="text" id="incentivesDescription" placeholder="e.g., Sales Incentive, Project Completion" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                            
                            <!-- Other Deductions -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="otherDeductions">Other Deductions (Optional)</label>
                                    <input type="number" id="otherDeductions" value="0" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div class="form-group">
                                    <label for="deductionDescription">Deduction Description</label>
                                    <input type="text" id="deductionDescription" placeholder="e.g., Advance, Loan EMI" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Attendance Summary -->
                        <div class="card" style="margin-bottom: 2rem; background: #e8f5e8;">
                            <h3>Attendance Summary</h3>
                            <div id="attendanceSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                                <div style="background: white; padding: 1rem; border-radius: 6px; text-align: center;">
                                    <h4>Total Days</h4>
                                    <span id="totalDays" style="font-size: 1.5rem; font-weight: bold; color: #2c3e50;">30</span>
                                </div>
                                <div style="background: white; padding: 1rem; border-radius: 6px; text-align: center;">
                                    <h4>Present Days</h4>
                                    <span id="presentDays" style="font-size: 1.5rem; font-weight: bold; color: #27ae60;">-</span>
                                </div>
                                <div style="background: white; padding: 1rem; border-radius: 6px; text-align: center;">
                                    <h4>Absent Days</h4>
                                    <span id="absentDays" style="font-size: 1.5rem; font-weight: bold; color: #e74c3c;">-</span>
                                </div>
                                <div style="background: white; padding: 1rem; border-radius: 6px; text-align: center;">
                                    <h4>Paid Leaves Used</h4>
                                    <span id="leavesUsed" style="font-size: 1.5rem; font-weight: bold; color: #f39c12;">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Salary Calculation Preview -->
                        <div class="card" style="margin-bottom: 2rem; background: #fff3cd;">
                            <h3>Salary Calculation Preview</h3>
                            <div id="salaryBreakdown" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem;">
                                <div>
                                    <h4 style="color: #27ae60;">Earnings</h4>
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr><td>Gross Salary:</td><td id="grossAmount">Rs.0</td></tr>
                                        <tr><td>Basic Salary:</td><td id="basicAmount">Rs.0</td></tr>
                                        <tr><td>HRA:</td><td id="hraAmount">Rs.0</td></tr>
                                        <tr><td>Transport:</td><td id="transportAmount">Rs.0</td></tr>
                                        <tr><td>Medical:</td><td id="medicalAmount">Rs.0</td></tr>
                                        <tr><td>Other Allowances:</td><td id="otherAllowancesAmount">Rs.0</td></tr>
                                        <tr><td>Bonus:</td><td id="bonusAmount">Rs.0</td></tr>
                                        <tr><td>Incentives:</td><td id="incentivesAmount">Rs.0</td></tr>
                                        <tr style="border-top: 2px solid #27ae60; font-weight: bold;"><td>Total Earnings:</td><td id="totalEarnings">Rs.0</td></tr>
                                    </table>
                                </div>
                                <div>
                                    <h4 style="color: #e74c3c;">Deductions</h4>
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr><td>PF (Employee):</td><td id="pfAmount">Rs.0</td></tr>
                                        <tr><td>ESIC (Employee):</td><td id="esicAmount">Rs.0</td></tr>
                                        <tr><td>Absent Days Cut:</td><td id="absentCut">Rs.0</td></tr>
                                        <tr><td>Other Deductions:</td><td id="otherDeductionsAmount">Rs.0</td></tr>
                                        <tr style="border-top: 2px solid #e74c3c; font-weight: bold;"><td>Total Deductions:</td><td id="totalDeductions">Rs.0</td></tr>
                                    </table>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 1rem; padding: 1rem; background: #2c3e50; color: white; border-radius: 6px;">
                                <h3>Net Salary: <span id="netSalary">Rs.0</span></h3>
                            </div>
                        </div>
                        
                        <!-- Generate Actions -->
                        <div class="form-row">
                            <button onclick="calculateSalary()" class="btn btn-primary">Calculate Salary</button>
                            <button onclick="testPDFGeneration()" class="btn btn-secondary">üß™ Test PDF</button>
                            <button onclick="generateSalarySlip()" class="btn btn-success">Generate Salary Slip PDF</button>
                            <button onclick="generateBulkSalarySlips()" class="btn btn-warning">Generate All Employee Slips</button>
                        </div>
                        
                        <!-- Debug Info -->
                        <div id="debugOutput" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 6px; font-family: monospace; font-size: 12px; display: none;">
                            <strong>Debug Output:</strong><br>
                            <div id="debugText"></div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Employee Dashboard -->
    <div id="employeeDashboard" class="dashboard employee-dashboard">
        <header class="dashboard-header">
            <h1>Employee Portal - Ambivare Solutions</h1>
            <div class="user-profile">
                <div class="user-avatar" id="employeeAvatar">E</div>
                <span id="employeeName">Welcome back, Employee</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="dashboard-content">
            <main class="main-content">
                <!-- QR Scanner Section -->
                <div class="card">
                    <h2>Attendance Check-In/Out</h2>
                    <div class="scan-section">
                        <p><strong>üì± Camera Scanning Required</strong></p>
                        <p>Use your device camera to scan the QR code provided by your admin to mark attendance</p>
                        <button id="startScanBtn" onclick="window.currentScanType = null; startQRScanner();" class="btn btn-primary scan-btn">Start Camera Scanner</button>
                        <button id="stopScanBtn" onclick="stopQRScanner()" class="btn btn-danger scan-btn hidden">Stop Scanner</button>
                        
                        <!-- Lunch Break Buttons -->
                        <div style="margin-top: 1rem; border-top: 1px solid #eee; padding-top: 1rem;">
                            <p><strong>üçΩÔ∏è Lunch Break Options</strong></p>
                            <button id="lunchOutBtn" onclick="startLunchOutScanner()" class="btn lunch-out-btn scan-btn">Lunch Out Scanner</button>
                            <button id="lunchInBtn" onclick="startLunchInScanner()" class="btn lunch-in-btn scan-btn">Lunch In Scanner</button>
                        </div>
                        
                        <div id="qr-reader"></div>
                        <div id="scanResult"></div>
                        
                        <!-- Debug info -->
                        <div id="debugInfo" style="margin-top: 1rem; font-size: 0.8rem; color: #666;"></div>
                    </div>
                </div>

                <!-- Personal Attendance History -->
                <div class="card">
                    <h2>My Attendance History</h2>
                    <div class="form-group">
                        <label for="employeeHistoryDate">Filter by Date</label>
                        <input type="date" id="employeeHistoryDate" class="form-group input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <button onclick="loadEmployeeAttendance()" class="btn btn-primary">Load My Attendance</button>
                    
                    <div class="table-container">
                        <table id="employeeAttendanceTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Check In</th>
                                    <th>Lunch Out</th>
                                    <th>Lunch In</th>
                                    <th>Check Out</th>
                                    <th>Total Hours</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Employee attendance data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Firebase Configuration and Initialization
        const firebaseConfig = {
            apiKey: "AIzaSyDY2PWQvaoOB9wV7SN3bT5qjgxQvlU3bQw",
            authDomain: "attendance-f96fe.firebaseapp.com",
            projectId: "attendance-f96fe",
            storageBucket: "attendance-f96fe.firebasestorage.app",
            messagingSenderId: "98412865321",
            appId: "1:98412865321:web:5a4a1fc7000045dcbe3938",
            measurementId: "G-LC120JM5S9"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Global Variables
        let currentUser = null;
        let currentUserType = null;
        let qrScanner = null;

        // Check for existing session on page load
        window.addEventListener('DOMContentLoaded', function() {
            checkExistingSession();
            setupEventListeners();
        });

        // Session Management
        function checkExistingSession() {
            const savedSession = localStorage.getItem('attendanceSession');
            if (savedSession) {
                const session = JSON.parse(savedSession);
                if (session.userType === 'admin' && session.username === 'Siddhant' && session.id === '102005') {
                    loginAsAdmin(session.username, session.id);
                } else if (session.userType === 'employee' && session.employeeId) {
                    loginAsEmployee(session.employeeId);
                }
            }
        }

        function saveSession(userType, userData) {
            localStorage.setItem('attendanceSession', JSON.stringify({
                userType: userType,
                ...userData,
                timestamp: Date.now()
            }));
        }

        function clearSession() {
            localStorage.removeItem('attendanceSession');
        }

        // Event Listeners Setup
        function setupEventListeners() {
            // Login form handlers
            document.getElementById('adminLogin').addEventListener('submit', handleAdminLogin);
            document.getElementById('employeeLogin').addEventListener('submit', handleEmployeeLogin);
            
            // Employee form handler
            document.getElementById('addEmployeeForm').addEventListener('submit', handleAddEmployee);
            
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    showSection(section);
                    
                    // Update active nav
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        // Login Tab Switching
        function switchTab(tab) {
            const adminForm = document.getElementById('adminLogin');
            const employeeForm = document.getElementById('employeeLogin');
            const tabBtns = document.querySelectorAll('.tab-btn');
            
            tabBtns.forEach(btn => btn.classList.remove('active'));
            
            if (tab === 'admin') {
                adminForm.classList.remove('hidden');
                employeeForm.classList.add('hidden');
                tabBtns[0].classList.add('active');
            } else {
                employeeForm.classList.remove('hidden');
                adminForm.classList.add('hidden');
                tabBtns[1].classList.add('active');
            }
        }

        // Login Handlers
        function handleAdminLogin(e) {
            e.preventDefault();
            const username = document.getElementById('adminUsername').value;
            const adminId = document.getElementById('adminId').value;
            
            // Hardcoded admin credentials
            if (username === 'Siddhant' && adminId === '102005') {
                loginAsAdmin(username, adminId);
            } else {
                showAlert('Invalid admin credentials!', 'error');
            }
        }

        function handleEmployeeLogin(e) {
            e.preventDefault();
            const employeeId = document.getElementById('employeeId').value;
            
            // Check if employee exists in database
            db.collection('employees').doc(employeeId).get()
                .then(doc => {
                    if (doc.exists) {
                        loginAsEmployee(employeeId);
                    } else {
                        showAlert('Employee ID not found!', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error checking employee data!', 'error');
                });
        }

        function loginAsAdmin(username, adminId) {
            currentUser = { username, id: adminId };
            currentUserType = 'admin';
            
            saveSession('admin', { username, id: adminId });
            
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            document.getElementById('adminName').textContent = `Welcome back, ${username}`;
            document.getElementById('adminAvatar').textContent = username.charAt(0).toUpperCase();
            
            loadDashboardData();
        }

        function loginAsEmployee(employeeId) {
            db.collection('employees').doc(employeeId).get()
                .then(doc => {
                    if (doc.exists) {
                        const employeeData = doc.data();
                        currentUser = { 
                            id: employeeId, 
                            name: employeeData.name,
                            email: employeeData.email,
                            designation: employeeData.designation
                        };
                        currentUserType = 'employee';
                        
                        saveSession('employee', { employeeId });
                        
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('employeeDashboard').style.display = 'block';
                        document.getElementById('employeeName').textContent = `Welcome back, ${employeeData.name}`;
                        document.getElementById('employeeAvatar').textContent = employeeData.name.charAt(0).toUpperCase();
                        
                        // Load employee attendance after a short delay to ensure UI is ready
                        setTimeout(() => {
                            loadEmployeeAttendance();
                        }, 500);
                    }
                })
                .catch(error => {
                    console.error('Error during employee login:', error);
                    showAlert('Error during login!', 'error');
                });
        }

        function logout() {
            clearSession();
            currentUser = null;
            currentUserType = null;
            
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('employeeDashboard').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            
            // Reset forms
            document.getElementById('adminLogin').reset();
            document.getElementById('employeeLogin').reset();
            
            // Stop QR scanner if running
            if (qrScanner) {
                qrScanner.stop();
                qrScanner = null;
            }
        }

        // Section Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            // Load section-specific data
            if (sectionId === 'dashboard') {
                loadDashboardData();
            } else if (sectionId === 'addEmployee') {
                loadEmployeeList();
            } else if (sectionId === 'generateQR') {
                loadQRStatus();
            } else if (sectionId === 'viewAttendance') {
                loadEmployeeDropdown('attendanceEmployeeFilter');
                loadAttendanceData();
            } else if (sectionId === 'salarySlips') {
                loadSalaryEmployees();
                setDefaultSalaryMonth();
            } else if (sectionId === 'reports') {
                loadEmployeeDropdown('reportEmployeeSelect');
            }
        }

        // Employee Management
        function handleAddEmployee(e) {
            e.preventDefault();
            
            const employeeData = {
                name: document.getElementById('empName').value,
                id: document.getElementById('empId').value,
                email: document.getElementById('empEmail').value,
                designation: document.getElementById('empDesignation').value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                qrCode: null
            };
            
            db.collection('employees').doc(employeeData.id).set(employeeData)
                .then(() => {
                    showAlert('Employee added successfully!', 'success');
                    document.getElementById('addEmployeeForm').reset();
                    loadEmployeeList();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error adding employee!', 'error');
                });
        }

        function loadEmployeeList() {
            const tbody = document.querySelector('#employeeTable tbody');
            tbody.innerHTML = '<tr><td colspan="5" class="loading">Loading employees...</td></tr>';
            
            db.collection('employees').get()
                .then(snapshot => {
                    tbody.innerHTML = '';
                    if (snapshot.empty) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No employees found</td></tr>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const emp = doc.data();
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${emp.id}</td>
                            <td>${emp.name}</td>
                            <td>${emp.email}</td>
                            <td>${emp.designation}</td>
                            <td>
                                <button onclick="deleteEmployee('${emp.id}')" class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8rem;">Delete</button>
                            </td>
                        `;
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">Error loading employees</td></tr>';
                });
        }

        function deleteEmployee(employeeId) {
            if (confirm('Are you sure you want to delete this employee?')) {
                db.collection('employees').doc(employeeId).delete()
                    .then(() => {
                        showAlert('Employee deleted successfully!', 'success');
                        loadEmployeeList();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showAlert('Error deleting employee!', 'error');
                    });
            }
        }

        function loadEmployeeDropdown(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Loading...</option>';
            
            db.collection('employees').get()
                .then(snapshot => {
                    select.innerHTML = selectId === 'attendanceEmployeeFilter' ? '<option value="">All Employees</option>' : '<option value="">Select an employee...</option>';
                    
                    snapshot.forEach(doc => {
                        const emp = doc.data();
                        const option = document.createElement('option');
                        option.value = emp.id;
                        option.textContent = `${emp.name} (${emp.id})`;
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    select.innerHTML = '<option value="">Error loading employees</option>';
                });
        }

        // QR Code Generation - Universal QR Code
        function generateUniversalQR() {
            // Generate universal QR code data that works for all employees
            const qrData = JSON.stringify({
                company: 'ambivare-solutions',
                type: 'universal-attendance',
                location: 'office',
                timestamp: Date.now()
            });
            
            const qr = new QRious({
                element: document.getElementById('qrCanvas'),
                value: qrData,
                size: 300,
                level: 'H'
            });
            
            // Save universal QR code data to Firebase
            db.collection('settings').doc('universal-qr').set({
                qrCode: qrData,
                generated: firebase.firestore.FieldValue.serverTimestamp(),
                active: true
            }).then(() => {
                document.getElementById('qrDisplay').classList.remove('hidden');
                loadQRStatus();
                showAlert('Universal QR code generated successfully!', 'success');
            }).catch(error => {
                console.error('Error:', error);
                showAlert('Error generating QR code!', 'error');
            });
        }

        function refreshQR() {
            if (confirm('Are you sure you want to refresh the QR code? The old QR code will become invalid.')) {
                generateUniversalQR();
            }
        }

        function loadQRStatus() {
            db.collection('settings').doc('universal-qr').get()
                .then(doc => {
                    const statusDiv = document.getElementById('qrStatus');
                    if (doc.exists) {
                        const data = doc.data();
                        const generatedDate = data.generated ? data.generated.toDate().toLocaleString() : 'Unknown';
                        statusDiv.innerHTML = `
                            <div style="padding: 1rem; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 6px;">
                                <p><strong>Status:</strong> <span style="color: green;">Active QR Code Available</span></p>
                                <p><strong>Generated:</strong> ${generatedDate}</p>
                                <p><strong>Usage:</strong> All employees can use this QR code</p>
                            </div>
                        `;
                    } else {
                        statusDiv.innerHTML = `
                            <div style="padding: 1rem; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 6px;">
                                <p><strong>Status:</strong> <span style="color: red;">No QR Code Generated</span></p>
                                <p>Generate a universal QR code to enable attendance marking.</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('qrStatus').innerHTML = '<p style="color: red;">Error loading QR status</p>';
                });
        }

        function downloadQR() {
            const canvas = document.getElementById('qrCanvas');
            const link = document.createElement('a');
            link.download = 'employee-qr-code.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        // QR Scanner for Employees - Simple Working Implementation with Debugging
        let videoStream = null;
        
        function startQRScanner() {
            const qrReader = document.getElementById('qr-reader');
            const startBtn = document.getElementById('startScanBtn');
            const stopBtn = document.getElementById('stopScanBtn');
            const scanResult = document.getElementById('scanResult');
            const debugInfo = document.getElementById('debugInfo');
            
            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            scanResult.innerHTML = '<div class="alert alert-success">Requesting camera access...</div>';
            debugInfo.innerHTML = 'Checking camera availability...';
            
            // Check if getUserMedia is supported
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                scanResult.innerHTML = '<div class="alert alert-error">Camera not supported on this device/browser.</div>';
                debugInfo.innerHTML = 'Error: getUserMedia not supported';
                startBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                return;
            }
            
            debugInfo.innerHTML = 'Camera API available. Requesting permissions...';
            
            // Create simple HTML structure
            qrReader.innerHTML = `
                <video id="qr-video" autoplay playsinline muted style="width: 100%; height: auto; max-width: 400px; border-radius: 8px; background: black;"></video>
            `;
            
            const video = document.getElementById('qr-video');
            
            // Simple camera constraints - try back camera first
            const constraints = {
                video: {
                    facingMode: "environment",
                    width: { ideal: 640, min: 320 },
                    height: { ideal: 480, min: 240 }
                },
                audio: false
            };
            
            debugInfo.innerHTML = 'Trying back camera...';
            
            navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    console.log('Got back camera stream:', stream);
                    debugInfo.innerHTML = 'Back camera stream received. Setting up video...';
                    
                    videoStream = stream;
                    video.srcObject = stream;
                    
                    video.addEventListener('loadedmetadata', () => {
                        debugInfo.innerHTML = `Video metadata loaded. Dimensions: ${video.videoWidth}x${video.videoHeight}`;
                        
                        video.play().then(() => {
                            scanResult.innerHTML = '<div class="alert alert-success">Back camera active! Point at QR code to scan.</div>';
                            debugInfo.innerHTML = 'Video playing successfully. Starting QR detection...';
                            startQRScanning(video);
                        }).catch(err => {
                            console.error('Video play error:', err);
                            debugInfo.innerHTML = `Video play error: ${err.message}`;
                            scanResult.innerHTML = '<div class="alert alert-error">Error starting video playback.</div>';
                        });
                    });
                    
                    video.addEventListener('error', (e) => {
                        console.error('Video error:', e);
                        debugInfo.innerHTML = `Video error: ${e.message}`;
                    });
                })
                .catch(error => {
                    console.error('Back camera error:', error);
                    debugInfo.innerHTML = `Back camera failed: ${error.message}. Trying front camera...`;
                    
                    // Try front camera
                    const frontConstraints = {
                        video: {
                            facingMode: "user",
                            width: { ideal: 640, min: 320 },
                            height: { ideal: 480, min: 240 }
                        },
                        audio: false
                    };
                    
                    navigator.mediaDevices.getUserMedia(frontConstraints)
                        .then(stream => {
                            console.log('Got front camera stream:', stream);
                            debugInfo.innerHTML = 'Front camera stream received. Setting up video...';
                            
                            videoStream = stream;
                            video.srcObject = stream;
                            
                            video.addEventListener('loadedmetadata', () => {
                                debugInfo.innerHTML = `Front camera metadata loaded. Dimensions: ${video.videoWidth}x${video.videoHeight}`;
                                
                                video.play().then(() => {
                                    scanResult.innerHTML = '<div class="alert alert-success">Front camera active! Point at QR code to scan.</div>';
                                    debugInfo.innerHTML = 'Front camera playing successfully. Starting QR detection...';
                                    startQRScanning(video);
                                }).catch(err => {
                                    console.error('Front video play error:', err);
                                    debugInfo.innerHTML = `Front video play error: ${err.message}`;
                                    scanResult.innerHTML = '<div class="alert alert-error">Error starting video playback.</div>';
                                });
                            });
                        })
                        .catch(err => {
                            console.error('All cameras failed:', err);
                            debugInfo.innerHTML = `All cameras failed: ${err.message}`;
                            scanResult.innerHTML = '<div class="alert alert-error">Camera access denied. Please allow camera permissions in browser settings.</div>';
                            startBtn.classList.remove('hidden');
                            stopBtn.classList.add('hidden');
                        });
                });
        }
        
        function startQRScanning(video) {
            let isScanning = true;
            let scanCount = 0;
            
            function detectQR() {
                if (!isScanning || !video.videoWidth || !video.videoHeight) {
                    if (isScanning) {
                        setTimeout(detectQR, 100);
                    }
                    return;
                }
                
                scanCount++;
                if (scanCount % 20 === 0) { // Update every 20 scans
                    document.getElementById('debugInfo').innerHTML = `Scanning active. Attempts: ${scanCount}`;
                }
                
                try {
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0);
                    
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    
                    if (typeof jsQR !== 'undefined') {
                        const code = jsQR(imageData.data, imageData.width, imageData.height);
                        if (code) {
                            isScanning = false;
                            document.getElementById('debugInfo').innerHTML = `QR Code detected: ${code.data}`;
                            onScanSuccess(code.data);
                            return;
                        }
                    } else {
                        document.getElementById('debugInfo').innerHTML = 'jsQR library not loaded';
                    }
                } catch (error) {
                    console.log('QR detection error:', error);
                    document.getElementById('debugInfo').innerHTML = `QR detection error: ${error.message}`;
                }
                
                if (isScanning) {
                    setTimeout(detectQR, 200);
                }
            }
            
            // Store scanning control
            window.stopScanning = () => { isScanning = false; };
            
            // Start detection
            setTimeout(detectQR, 1000);
        }

        function stopQRScanner() {
            const startBtn = document.getElementById('startScanBtn');
            const stopBtn = document.getElementById('stopScanBtn');
            const scanResult = document.getElementById('scanResult');
            const qrReader = document.getElementById('qr-reader');
            
            // Stop scanning
            if (window.stopScanning) {
                window.stopScanning();
                window.stopScanning = null;
            }
            
            // Stop video stream
            if (videoStream) {
                videoStream.getTracks().forEach(track => {
                    track.stop();
                });
                videoStream = null;
            }
            
            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
            qrReader.innerHTML = '';
            scanResult.innerHTML = '';
        }

        function hideUploadElements() {
            // Not needed with direct implementation
        }

        function stopQRScanner() {
            const startBtn = document.getElementById('startScanBtn');
            const stopBtn = document.getElementById('stopScanBtn');
            const scanResult = document.getElementById('scanResult');
            const qrReader = document.getElementById('qr-reader');
            
            if (qrScanner) {
                qrScanner.stop().then(() => {
                    qrScanner.clear();
                    qrScanner = null;
                    startBtn.classList.remove('hidden');
                    stopBtn.classList.add('hidden');
                    qrReader.innerHTML = '';
                    scanResult.innerHTML = '';
                }).catch((error) => {
                    console.error('Error stopping scanner:', error);
                    qrScanner = null;
                    startBtn.classList.remove('hidden');
                    stopBtn.classList.add('hidden');
                    qrReader.innerHTML = '';
                    scanResult.innerHTML = '';
                });
            } else {
                startBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                qrReader.innerHTML = '';
                scanResult.innerHTML = '';
            }
        }

        function hideUploadElements() {
            // Not needed with Html5Qrcode direct implementation
        }

        // Lunch Break Scanner Functions
        function startLunchOutScanner() {
            window.currentScanType = 'lunchOut';
            startQRScanner();
        }

        function startLunchInScanner() {
            window.currentScanType = 'lunchIn';
            startQRScanner();
        }

        function onScanSuccess(decodedText, decodedResult) {
            try {
                // Handle case where only one parameter is passed (jsQR implementation)
                const qrText = decodedText || decodedResult;
                const qrData = JSON.parse(qrText);
                
                if (qrData.company === 'ambivare-solutions' && qrData.type === 'universal-attendance') {
                    // Valid universal QR code - determine action based on scan type
                    document.getElementById('scanResult').innerHTML = '<div class="alert alert-success">QR Code detected! Processing attendance...</div>';
                    
                    console.log('Current scan type:', window.currentScanType); // Debug log
                    
                    if (window.currentScanType === 'lunchOut') {
                        console.log('Calling markLunchOut'); // Debug log
                        markLunchOut();
                    } else if (window.currentScanType === 'lunchIn') {
                        console.log('Calling markLunchIn'); // Debug log
                        markLunchIn();
                    } else {
                        console.log('Calling markAttendance'); // Debug log
                        markAttendance();
                    }
                    stopQRScanner();
                } else if (qrData.company === 'ambivare-solutions') {
                    document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">This QR code format is not supported. Please use the universal QR code from admin.</div>';
                } else {
                    document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">Invalid QR code! Please scan the official attendance QR code.</div>';
                }
            } catch (error) {
                document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">Invalid QR code format! Please scan the official attendance QR code.</div>';
            }
        }

        function onScanFailure(error) {
            // Handle scan failure silently - this is called frequently during scanning
            // Only log actual errors, not "No QR code found" messages
            if (!error.includes('No QR code found')) {
                console.log('QR Scan error:', error);
            }
        }

        // Attendance Management
        function markAttendance() {
            const today = new Date().toISOString().split('T')[0];
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            const attendanceRef = db.collection('attendance').doc(`${currentUser.id}_${today}`);
            
            attendanceRef.get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    if (!data.checkOut) {
                        // Mark check-out (only if not a lunch operation)
                        let totalHours;
                        if (data.lunchOut && data.lunchIn) {
                            // Calculate total hours excluding lunch break
                            const morningHours = calculateHoursInMinutes(data.checkIn, data.lunchOut);
                            const afternoonHours = calculateHoursInMinutes(data.lunchIn, timeString);
                            const totalMinutes = morningHours + afternoonHours;
                            totalHours = formatMinutesToHours(totalMinutes);
                        } else {
                            // Regular calculation
                            totalHours = calculateHours(data.checkIn, timeString);
                        }
                        
                        attendanceRef.update({
                            checkOut: timeString,
                            checkOutTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            totalHours: totalHours
                        }).then(() => {
                            document.getElementById('scanResult').innerHTML = '<div class="alert alert-success">Check-out recorded successfully at ' + timeString + '!</div>';
                            setTimeout(() => {
                                loadEmployeeAttendance();
                                window.currentScanType = null; // Reset scan type
                            }, 1000);
                        }).catch(error => {
                            console.error('Error updating check-out:', error);
                            document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">Error recording check-out!</div>';
                        });
                    } else {
                        document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">You have already checked out today!</div>';
                    }
                } else {
                    // Mark check-in
                    attendanceRef.set({
                        employeeId: currentUser.id,
                        employeeName: currentUser.name,
                        date: today,
                        checkIn: timeString,
                        checkInTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        checkOut: null,
                        lunchOut: null,
                        lunchIn: null,
                        lunchDuration: null,
                        totalHours: null,
                        status: 'Present'
                    }).then(() => {
                        document.getElementById('scanResult').innerHTML = '<div class="alert alert-success">Check-in recorded successfully at ' + timeString + '!</div>';
                        setTimeout(() => {
                            loadEmployeeAttendance();
                            window.currentScanType = null; // Reset scan type
                        }, 1000);
                    }).catch(error => {
                        console.error('Error creating check-in:', error);
                        document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">Error recording check-in!</div>';
                    });
                }
            }).catch(error => {
                console.error('Error checking attendance:', error);
                document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">Error checking attendance record!</div>';
            });
        }

        // Lunch Break Functions
        function markLunchOut() {
            const today = new Date().toISOString().split('T')[0];
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            const attendanceRef = db.collection('attendance').doc(`${currentUser.id}_${today}`);
            
            attendanceRef.get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data.checkIn && !data.checkOut) {
                        if (!data.lunchOut) {
                            // Mark lunch out
                            attendanceRef.update({
                                lunchOut: timeString,
                                lunchOutTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                            }).then(() => {
                                document.getElementById('scanResult').innerHTML = '<div class="alert alert-success">Lunch out recorded successfully at ' + timeString + '!</div>';
                                setTimeout(() => {
                                    loadEmployeeAttendance();
                                    window.currentScanType = null; // Reset scan type
                                }, 1000);
                            }).catch(error => {
                                console.error('Error recording lunch out:', error);
                                document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">Error recording lunch out!</div>';
                            });
                        } else {
                            document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">You have already marked lunch out today!</div>';
                        }
                    } else if (!data.checkIn) {
                        document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">Please check in first before marking lunch out!</div>';
                    } else {
                        document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">You have already checked out for the day!</div>';
                    }
                } else {
                    document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">Please check in first before marking lunch out!</div>';
                }
            }).catch(error => {
                console.error('Error checking attendance:', error);
                document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">Error checking attendance record!</div>';
            });
        }

        function markLunchIn() {
            console.log('markLunchIn function called'); // Debug log
            const today = new Date().toISOString().split('T')[0];
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            console.log('Attempting to mark lunch in at:', timeString); // Debug log
            
            const attendanceRef = db.collection('attendance').doc(`${currentUser.id}_${today}`);
            
            attendanceRef.get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    console.log('Current attendance data:', data); // Debug log
                    
                    if (data.checkIn && !data.checkOut) {
                        if (data.lunchOut && !data.lunchIn) {
                            // Calculate lunch duration
                            const lunchDuration = calculateHours(data.lunchOut, timeString);
                            
                            console.log('Updating lunch in record'); // Debug log
                            
                            // Mark lunch in
                            attendanceRef.update({
                                lunchIn: timeString,
                                lunchInTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                lunchDuration: lunchDuration
                            }).then(() => {
                                console.log('Lunch in recorded successfully'); // Debug log
                                document.getElementById('scanResult').innerHTML = '<div class="alert alert-success">Lunch in recorded successfully at ' + timeString + '! Lunch duration: ' + lunchDuration + '</div>';
                                setTimeout(() => {
                                    loadEmployeeAttendance();
                                    window.currentScanType = null; // Reset scan type
                                }, 1000);
                            }).catch(error => {
                                console.error('Error recording lunch in:', error);
                                document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">Error recording lunch in!</div>';
                            });
                        } else if (!data.lunchOut) {
                            console.log('Error: No lunch out recorded'); // Debug log
                            document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">Please mark lunch out first!</div>';
                        } else if (data.lunchIn) {
                            console.log('Error: Lunch in already recorded'); // Debug log
                            document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">You have already marked lunch in today!</div>';
                        }
                    } else if (!data.checkIn) {
                        console.log('Error: No check in recorded'); // Debug log
                        document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">Please check in first!</div>';
                    } else {
                        document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">You have already checked out for the day!</div>';
                    }
                } else {
                    document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">Please check in first!</div>';
                }
            }).catch(error => {
                console.error('Error checking attendance:', error);
                document.getElementById('scanResult').innerHTML = '<div class="alert alert-error">Error checking attendance record!</div>';
            });
        }

        function calculateHours(checkIn, checkOut) {
            const inTime = new Date(`1970-01-01T${checkIn}`);
            const outTime = new Date(`1970-01-01T${checkOut}`);
            const diffMs = outTime - inTime;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            return `${diffHours}h ${diffMinutes}m`;
        }

        function calculateHoursInMinutes(startTime, endTime) {
            const start = new Date(`1970-01-01T${startTime}`);
            const end = new Date(`1970-01-01T${endTime}`);
            const diffMs = end - start;
            return Math.floor(diffMs / (1000 * 60)); // Return minutes
        }

        function formatMinutesToHours(totalMinutes) {
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${hours}h ${minutes}m`;
        }

        // Dashboard Data Loading
        function loadDashboardData() {
            // Load total employees and calculate attendance stats
            db.collection('employees').get().then(employeeSnapshot => {
                const totalEmployees = employeeSnapshot.size;
                document.getElementById('totalEmployees').textContent = totalEmployees;
                
                // Get all employee IDs
                const allEmployeeIds = [];
                employeeSnapshot.forEach(doc => {
                    allEmployeeIds.push(doc.data().id);
                });
                
                // Load today's attendance stats
                const today = new Date().toISOString().split('T')[0];
                db.collection('attendance').where('date', '==', today).get().then(attendanceSnapshot => {
                    let present = 0;
                    const presentEmployeeIds = [];
                    
                    // Count present employees
                    attendanceSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.status === 'Present') {
                            present++;
                            presentEmployeeIds.push(data.employeeId);
                        }
                    });
                    
                    // Calculate absent employees (employees with no attendance record or not present)
                    const absent = totalEmployees - present;
                    
                    document.getElementById('presentToday').textContent = present;
                    document.getElementById('absentToday').textContent = absent;
                    
                    const rate = totalEmployees > 0 ? Math.round((present / totalEmployees) * 100) : 0;
                    document.getElementById('attendanceRate').textContent = `${rate}%`;
                });
            });
            
            // Load recent activity
            loadRecentActivity();
        }

        function loadRecentActivity() {
            const activityDiv = document.getElementById('recentActivity');
            
            db.collection('attendance').get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        activityDiv.innerHTML = '<p>No recent activity</p>';
                        return;
                    }
                    
                    // Convert to array and sort client-side
                    const activities = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.checkInTimestamp || data.checkIn) {
                            activities.push(data);
                        }
                    });
                    
                    // Sort by date and time
                    activities.sort((a, b) => {
                        const dateA = new Date(a.date + ' ' + (a.checkIn || '00:00'));
                        const dateB = new Date(b.date + ' ' + (b.checkIn || '00:00'));
                        return dateB - dateA;
                    });
                    
                    // Take first 5 activities
                    const recentActivities = activities.slice(0, 5);
                    
                    if (recentActivities.length === 0) {
                        activityDiv.innerHTML = '<p>No recent activity</p>';
                        return;
                    }
                    
                    let html = '<ul style="list-style: none; padding: 0;">';
                    recentActivities.forEach(data => {
                        html += `<li style="padding: 10px; border-bottom: 1px solid #eee;">
                            <strong>${data.employeeName}</strong> checked in at ${data.checkIn} on ${data.date}
                        </li>`;
                    });
                    html += '</ul>';
                    activityDiv.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error:', error);
                    activityDiv.innerHTML = '<p style="color: red;">Error loading recent activity</p>';
                });
        }

        // Attendance Data Loading
        function loadAttendanceData() {
            const tbody = document.querySelector('#attendanceTable tbody');
            tbody.innerHTML = '<tr><td colspan="9" class="loading">Loading attendance data...</td></tr>';
            
            const employeeFilter = document.getElementById('attendanceEmployeeFilter').value;
            const dateFilter = document.getElementById('attendanceDateFilter').value;
            
            let query = db.collection('attendance');
            
            if (employeeFilter) {
                query = query.where('employeeId', '==', employeeFilter);
            }
            
            if (dateFilter) {
                query = query.where('date', '==', dateFilter);
            }
            
            query.get()
                .then(snapshot => {
                    tbody.innerHTML = '';
                    if (snapshot.empty) {
                        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No attendance records found</td></tr>';
                        return;
                    }
                    
                    // Convert to array and sort client-side
                    const attendanceRecords = [];
                    snapshot.forEach(doc => {
                        attendanceRecords.push(doc.data());
                    });
                    
                    // Sort by date descending
                    attendanceRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    attendanceRecords.forEach(data => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${data.employeeId}</td>
                            <td>${data.employeeName}</td>
                            <td>${data.date}</td>
                            <td>${data.checkIn || '-'}</td>
                            <td>${data.lunchOut || '-'}</td>
                            <td>${data.lunchIn || '-'}</td>
                            <td>${data.checkOut || '-'}</td>
                            <td>${data.totalHours || '-'}</td>
                            <td><span style="color: ${data.status === 'Present' ? 'green' : 'red'}">${data.status}</span></td>
                        `;
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: red;">Error loading attendance data</td></tr>';
                });
        }

        function loadEmployeeAttendance() {
            if (currentUserType !== 'employee' || !currentUser) {
                console.error('Not an employee or user not logged in');
                return;
            }
            
            const tbody = document.querySelector('#employeeAttendanceTable tbody');
            tbody.innerHTML = '<tr><td colspan="7" class="loading">Loading your attendance...</td></tr>';
            
            // Simple query without orderBy to avoid index issues
            db.collection('attendance').where('employeeId', '==', currentUser.id).get()
                .then(snapshot => {
                    tbody.innerHTML = '';
                    if (snapshot.empty) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No attendance records found. Start marking attendance by scanning QR codes!</td></tr>';
                        return;
                    }
                    
                    // Convert to array and sort client-side
                    const attendanceRecords = [];
                    snapshot.forEach(doc => {
                        attendanceRecords.push(doc.data());
                    });
                    
                    // Sort by date descending
                    attendanceRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    // Apply date filter if set
                    const dateFilter = document.getElementById('employeeHistoryDate').value;
                    const filteredRecords = dateFilter ? 
                        attendanceRecords.filter(record => record.date === dateFilter) : 
                        attendanceRecords;
                    
                    if (filteredRecords.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No records found for the selected date.</td></tr>';
                        return;
                    }
                    
                    filteredRecords.forEach(data => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${data.date}</td>
                            <td>${data.checkIn || '-'}</td>
                            <td>${data.lunchOut || '-'}</td>
                            <td>${data.lunchIn || '-'}</td>
                            <td>${data.checkOut || '-'}</td>
                            <td>${data.totalHours || '-'}</td>
                            <td><span style="color: ${data.status === 'Present' ? 'green' : 'red'}">${data.status}</span></td>
                        `;
                    });
                })
                .catch(error => {
                    console.error('Error loading employee attendance:', error);
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">Error loading attendance data. Please try refreshing the page.</td></tr>';
                });
        }

        // PDF Report Generation
        function generateIndividualReport() {
            const employeeId = document.getElementById('reportEmployeeSelect').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!employeeId) {
                showAlert('Please select an employee!', 'error');
                return;
            }
            
            showAlert('Generating individual report...', 'success');
            
            // Get employee data
            db.collection('employees').doc(employeeId).get()
                .then(empDoc => {
                    if (!empDoc.exists) {
                        showAlert('Employee not found!', 'error');
                        return;
                    }
                    
                    const empData = empDoc.data();
                    
                    // Get attendance data for specific employee - simple query without orderBy
                    db.collection('attendance').where('employeeId', '==', employeeId).get()
                        .then(snapshot => {
                            const attendanceData = [];
                            let totalDays = 0;
                            let presentDays = 0;
                            let totalHoursWorked = 0;
                            
                            snapshot.forEach(doc => {
                                const data = doc.data();
                                
                                // Apply date filter if specified
                                if (startDate && endDate) {
                                    if (data.date >= startDate && data.date <= endDate) {
                                        attendanceData.push(data);
                                    } else {
                                        return; // Skip this record
                                    }
                                } else {
                                    attendanceData.push(data);
                                }
                                
                                totalDays++;
                                if (data.status === 'Present') {
                                    presentDays++;
                                    if (data.totalHours) {
                                        // Extract hours from "Xh Ym" format
                                        const hours = data.totalHours.match(/(\d+)h/);
                                        if (hours) {
                                            totalHoursWorked += parseInt(hours[1]);
                                        }
                                    }
                                }
                            });
                            
                            // Sort attendance data by date (client-side)
                            attendanceData.sort((a, b) => new Date(b.date) - new Date(a.date));
                            
                            const presentPercentage = totalDays > 0 ? Math.round((presentDays / totalDays) * 100) : 0;
                            
                            if (attendanceData.length === 0) {
                                showAlert('No attendance data found for the selected employee and date range!', 'error');
                                return;
                            }
                            
                            generateIndividualPDF(empData, attendanceData, {
                                totalDays,
                                presentDays,
                                presentPercentage,
                                totalHoursWorked,
                                startDate,
                                endDate
                            });
                        })
                        .catch(error => {
                            console.error('Error fetching attendance data:', error);
                            showAlert('Error fetching attendance data!', 'error');
                        });
                })
                .catch(error => {
                    console.error('Error fetching employee data:', error);
                    showAlert('Error fetching employee data!', 'error');
                });
        }

        function generateOverallReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            // Get all employees
            db.collection('employees').get()
                .then(empSnapshot => {
                    const totalEmployees = empSnapshot.size;
                    
                    // Get attendance data
                    let query = db.collection('attendance');
                    
                    if (startDate && endDate) {
                        query = query.where('date', '>=', startDate).where('date', '<=', endDate);
                    }
                    
                    query.get().then(attSnapshot => {
                        let totalRecords = 0;
                        let presentRecords = 0;
                        const employeeStats = {};
                        
                        attSnapshot.forEach(doc => {
                            const data = doc.data();
                            totalRecords++;
                            
                            if (!employeeStats[data.employeeId]) {
                                employeeStats[data.employeeId] = {
                                    name: data.employeeName,
                                    total: 0,
                                    present: 0
                                };
                            }
                            
                            employeeStats[data.employeeId].total++;
                            
                            if (data.status === 'Present') {
                                presentRecords++;
                                employeeStats[data.employeeId].present++;
                            }
                        });
                        
                        const overallPercentage = totalRecords > 0 ? Math.round((presentRecords / totalRecords) * 100) : 0;
                        
                        generateOverallPDF({
                            totalEmployees,
                            totalRecords,
                            presentRecords,
                            overallPercentage,
                            employeeStats,
                            startDate,
                            endDate
                        });
                    });
                });
        }

        function generateIndividualPDF(employeeData, attendanceData, stats) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Corporate colors
            const primaryColor = [44, 62, 80];
            const secondaryColor = [249, 246, 242];
            
            // Header
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, 210, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('AMBIVARE SOLUTIONS', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('Individual Attendance Report', 105, 30, { align: 'center' });
            
            // Employee Info
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Employee Information', 20, 60);
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Name: ${employeeData.name}`, 20, 75);
            doc.text(`Employee ID: ${employeeData.id}`, 20, 85);
            doc.text(`Designation: ${employeeData.designation}`, 20, 95);
            doc.text(`Email: ${employeeData.email}`, 20, 105);
            
            // Statistics
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Summary Statistics', 20, 125);
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Total Working Days: ${stats.totalDays}`, 20, 140);
            doc.text(`Days Present: ${stats.presentDays}`, 20, 150);
            doc.text(`Attendance Rate: ${stats.presentPercentage}%`, 20, 160);
            doc.text(`Total Hours Worked: ${stats.totalHoursWorked}h`, 20, 170);
            
            if (stats.startDate && stats.endDate) {
                doc.text(`Report Period: ${stats.startDate} to ${stats.endDate}`, 20, 180);
            }
            
            // Attendance Table
            const tableData = attendanceData.map(record => [
                record.date,
                record.checkIn || '-',
                record.lunchOut || '-',
                record.lunchIn || '-',
                record.checkOut || '-',
                record.totalHours || '-',
                record.status
            ]);
            
            doc.autoTable({
                head: [['Date', 'Check In', 'Lunch Out', 'Lunch In', 'Check Out', 'Total Hours', 'Status']],
                body: tableData,
                startY: 195,
                theme: 'grid',
                headStyles: {
                    fillColor: primaryColor,
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [248, 249, 250]
                }
            });
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.setTextColor(128, 128, 128);
                doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 280);
                doc.text(`Page ${i} of ${pageCount}`, 190, 280, { align: 'right' });
                doc.text('Ambivare Solutions - Confidential', 105, 290, { align: 'center' });
            }
            
            // Save the PDF
            doc.save(`${employeeData.name}_Individual_Report.pdf`);
            showAlert('Individual report generated successfully!', 'success');
        }

        function generatePDF(employeeData, attendanceData, stats) {
            // This function is kept for backward compatibility
            generateIndividualPDF(employeeData, attendanceData, stats);
        }

        function generateOverallPDF(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Corporate colors
            const primaryColor = [44, 62, 80];
            
            // Header
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, 210, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('AMBIVARE SOLUTIONS', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('Overall Attendance Analytics', 105, 30, { align: 'center' });
            
            // Overall Statistics
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Company Statistics', 20, 60);
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Total Employees: ${data.totalEmployees}`, 20, 75);
            doc.text(`Total Attendance Records: ${data.totalRecords}`, 20, 85);
            doc.text(`Present Records: ${data.presentRecords}`, 20, 95);
            doc.text(`Absent Records: ${data.totalRecords - data.presentRecords}`, 20, 105);
            doc.text(`Overall Attendance Rate: ${data.overallPercentage}%`, 20, 115);
            
            if (data.startDate && data.endDate) {
                doc.text(`Report Period: ${data.startDate} to ${data.endDate}`, 20, 125);
            }
            
            // Employee-wise breakdown
            const tableData = Object.keys(data.employeeStats).map(empId => {
                const stats = data.employeeStats[empId];
                const percentage = stats.total > 0 ? Math.round((stats.present / stats.total) * 100) : 0;
                return [
                    empId,
                    stats.name,
                    stats.total,
                    stats.present,
                    `${percentage}%`
                ];
            });
            
            doc.autoTable({
                head: [['Employee ID', 'Name', 'Total Days', 'Present Days', 'Attendance %']],
                body: tableData,
                startY: 140,
                theme: 'grid',
                headStyles: {
                    fillColor: primaryColor,
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [248, 249, 250]
                }
            });
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.setTextColor(128, 128, 128);
                doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 280);
                doc.text(`Page ${i} of ${pageCount}`, 190, 280, { align: 'right' });
                doc.text('Ambivare Solutions - Confidential', 105, 290, { align: 'center' });
            }
            
            // Save the PDF
            doc.save('Overall_Attendance_Analytics.pdf');
        }

        // Utility Functions
        function showAlert(message, type) {
            const alertDiv = document.getElementById('loginAlert');
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        // Set default dates for reports
        function setDefaultDates() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('reportStartDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
        }

        // Initialize default dates when page loads
        setTimeout(setDefaultDates, 1000);
        
        // ======================= SALARY SLIP FUNCTIONS =======================
        
        // Load employees for salary slip generation
        function loadSalaryEmployees() {
            const select = document.getElementById('salaryEmployee');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select an employee...</option>';
            
            db.collection('employees').get().then(snapshot => {
                snapshot.forEach(doc => {
                    const employee = doc.data();
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = `${employee.name} (${employee.id})`;
                    option.dataset.employee = JSON.stringify(employee);
                    select.appendChild(option);
                });
            });
        }
        
        // Set default month to current month
        function setDefaultSalaryMonth() {
            const monthInput = document.getElementById('salaryMonth');
            if (monthInput) {
                const today = new Date();
                const currentMonth = today.toISOString().slice(0, 7);
                monthInput.value = currentMonth;
            }
        }
        
        // Calculate salary based on manual attendance inputs
        function calculateSalary() {
            console.log('Calculate salary function called');
            
            // Get all required inputs
            const employeeSelect = document.getElementById('salaryEmployee');
            const monthInput = document.getElementById('salaryMonth');
            const grossSalaryInput = document.getElementById('grossSalary');
            const totalWorkingDaysInput = document.getElementById('totalWorkingDays');
            const presentDaysInput = document.getElementById('presentDaysInput');
            const paidLeavesInput = document.getElementById('paidLeavesAvailable');
            const leavesUsedInput = document.getElementById('leavesUsedInput');
            
            // Validation
            if (!employeeSelect || !employeeSelect.value) {
                showAlert('Please select an employee', 'error');
                return;
            }
            
            if (!monthInput || !monthInput.value) {
                showAlert('Please select a month', 'error');
                return;
            }
            
            if (!grossSalaryInput || !grossSalaryInput.value || parseFloat(grossSalaryInput.value) <= 0) {
                showAlert('Please enter a valid gross salary', 'error');
                return;
            }
            
            if (!totalWorkingDaysInput || !totalWorkingDaysInput.value || parseInt(totalWorkingDaysInput.value) <= 0) {
                showAlert('Please enter total working days', 'error');
                return;
            }
            
            if (!presentDaysInput || presentDaysInput.value === '' || parseInt(presentDaysInput.value) < 0) {
                showAlert('Please enter present days', 'error');
                return;
            }
            
            // Get values
            const grossSalary = parseFloat(grossSalaryInput.value);
            const totalWorkingDays = parseInt(totalWorkingDaysInput.value);
            const presentDays = parseInt(presentDaysInput.value);
            const paidLeavesAvailable = parseInt(paidLeavesInput.value) || 2;
            const leavesUsed = parseInt(leavesUsedInput.value) || 0;
            
            // Calculate attendance
            const absentDays = totalWorkingDays - presentDays;
            const unpaidAbsentDays = Math.max(0, absentDays - leavesUsed);
            
            console.log('Attendance Data:', {
                totalWorkingDays,
                presentDays,
                absentDays,
                paidLeavesAvailable,
                leavesUsed,
                unpaidAbsentDays
            });
            
            // Update attendance summary display
            document.getElementById('totalDays').textContent = totalWorkingDays;
            document.getElementById('presentDays').textContent = presentDays;
            document.getElementById('absentDays').textContent = absentDays;
            document.getElementById('leavesUsed').textContent = leavesUsed;
            
            // Calculate salary breakdown
            calculateSalaryBreakdown(grossSalary, unpaidAbsentDays, totalWorkingDays);
        }
        
        // Calculate monthly attendance
        function calculateMonthlyAttendance(employeeId, month, grossSalary) {
            console.log('calculateMonthlyAttendance called with:', employeeId, month, grossSalary);
            
            const [year, monthNum] = month.split('-');
            console.log('Year:', year, 'Month:', monthNum);
            
            // Create proper date range for the entire month
            const startDate = `${year}-${monthNum.padStart(2, '0')}-01`;
            const endDate = `${year}-${monthNum.padStart(2, '0')}-31`; // Changed to 31 to cover all days
            
            console.log('Date range:', startDate, 'to', endDate);
            
            // Query attendance records for the employee in the selected month
            let query = db.collection('attendance')
                .where('employeeId', '==', employeeId)
                .where('date', '>=', startDate)
                .where('date', '<=', endDate);
            
            query.get().then(snapshot => {
                console.log('Attendance records found:', snapshot.size);
                
                let presentDays = 0;
                let totalWorkingDays = 30; // Fixed as per requirement
                
                // Count present days
                snapshot.forEach(doc => {
                    const data = doc.data();
                    console.log('Attendance record:', data);
                    if (data.status === 'Present') {
                        presentDays++;
                    }
                });
                
                console.log('Present days:', presentDays);
                
                const absentDays = totalWorkingDays - presentDays;
                const leavesUsed = Math.min(absentDays, 2); // Max 2 paid leaves per month
                const unpaidAbsent = Math.max(0, absentDays - 2);
                
                console.log('Absent days:', absentDays, 'Leaves used:', leavesUsed, 'Unpaid absent:', unpaidAbsent);
                
                // Update attendance summary UI
                document.getElementById('totalDays').textContent = totalWorkingDays;
                document.getElementById('presentDays').textContent = presentDays;
                document.getElementById('absentDays').textContent = absentDays;
                document.getElementById('leavesUsed').textContent = leavesUsed;
                
                // Calculate salary breakdown
                calculateSalaryBreakdown(grossSalary, unpaidAbsent, totalWorkingDays);
                
            }).catch(error => {
                console.error('Error fetching attendance:', error);
                showAlert('Error fetching attendance data: ' + error.message, 'error');
                
                // Reset UI on error
                document.getElementById('presentDays').textContent = '-';
                document.getElementById('absentDays').textContent = '-';
            });
        }
        
        // Calculate complete salary breakdown
        function calculateSalaryBreakdown(grossSalary, unpaidAbsentDays, totalDays) {
            console.log('calculateSalaryBreakdown called with:', grossSalary, unpaidAbsentDays, totalDays);
            
            const basicPercent = parseFloat(document.getElementById('basicSalaryPercent').value) || 50;
            const hra = parseFloat(document.getElementById('hra').value) || 0;
            const transportAllowance = parseFloat(document.getElementById('transportAllowance').value) || 0;
            const medicalAllowance = parseFloat(document.getElementById('medicalAllowance').value) || 0;
            const otherAllowancesInput = parseFloat(document.getElementById('otherAllowances').value) || 0;
            const bonus = parseFloat(document.getElementById('bonus').value) || 0;
            const bonusDesc = document.getElementById('bonusDescription').value || '';
            const incentives = parseFloat(document.getElementById('incentives').value) || 0;
            const incentivesDesc = document.getElementById('incentivesDescription').value || '';
            const otherDeductions = parseFloat(document.getElementById('otherDeductions').value) || 0;
            const deductionDesc = document.getElementById('deductionDescription').value || '';
            const enablePF = document.getElementById('enablePF').checked;
            const enableESIC = document.getElementById('enableESIC').checked;
            
            // Calculate basic salary as part of gross
            const basicSalary = Math.round((grossSalary * basicPercent) / 100);
            
            // Verify that breakdown components don't exceed gross salary
            const breakdownTotal = basicSalary + hra + transportAllowance + medicalAllowance + otherAllowancesInput;
            
            console.log('Gross Breakdown Check:', {
                grossSalary,
                basicSalary,
                hra,
                transportAllowance,
                medicalAllowance,
                otherAllowancesInput,
                breakdownTotal
            });
            
            // Warn if breakdown exceeds gross
            if (breakdownTotal > grossSalary) {
                showAlert(`Warning: Breakdown total (Rs.${breakdownTotal.toLocaleString()}) exceeds Gross Salary (Rs.${grossSalary.toLocaleString()})`, 'error');
            }
            
            // Total earnings = Gross salary + Additional earnings (bonus, incentives)
            const totalEarnings = grossSalary + bonus + incentives;
            
            // Calculate deductions
            let pfAmount = 0;
            let esicAmount = 0;
            
            if (enablePF) {
                pfAmount = Math.round((basicSalary * 12) / 100); // 12% of basic
            }
            
            if (enableESIC) {
                esicAmount = Math.round((grossSalary * 0.75) / 100); // 0.75% of gross
            }
            
            // Calculate absent days deduction (based on gross salary)
            const perDayRate = grossSalary / totalDays;
            const absentCut = Math.round(unpaidAbsentDays * perDayRate);
            
            const totalDeductionsAmount = pfAmount + esicAmount + absentCut + otherDeductions;
            const netSalary = totalEarnings - totalDeductionsAmount;
            
            console.log('Final Calculations:', {
                grossSalary,
                totalEarnings,
                pfAmount,
                esicAmount,
                absentCut,
                totalDeductionsAmount,
                netSalary
            });
            
            // Update UI with Rs. prefix
            try {
                document.getElementById('grossAmount').textContent = `Rs.${grossSalary.toLocaleString()}`;
                document.getElementById('basicAmount').textContent = `Rs.${basicSalary.toLocaleString()}`;
                document.getElementById('hraAmount').textContent = `Rs.${hra.toLocaleString()}`;
                document.getElementById('transportAmount').textContent = `Rs.${transportAllowance.toLocaleString()}`;
                document.getElementById('medicalAmount').textContent = `Rs.${medicalAllowance.toLocaleString()}`;
                document.getElementById('otherAllowancesAmount').textContent = `Rs.${otherAllowancesInput.toLocaleString()}`;
                document.getElementById('bonusAmount').textContent = `Rs.${bonus.toLocaleString()}`;
                document.getElementById('incentivesAmount').textContent = `Rs.${incentives.toLocaleString()}`;
                document.getElementById('totalEarnings').textContent = `Rs.${totalEarnings.toLocaleString()}`;
                
                document.getElementById('pfAmount').textContent = `Rs.${pfAmount.toLocaleString()}`;
                document.getElementById('esicAmount').textContent = `Rs.${esicAmount.toLocaleString()}`;
                document.getElementById('absentCut').textContent = `Rs.${absentCut.toLocaleString()}`;
                document.getElementById('otherDeductionsAmount').textContent = `Rs.${otherDeductions.toLocaleString()}`;
                document.getElementById('totalDeductions').textContent = `Rs.${totalDeductionsAmount.toLocaleString()}`;
                document.getElementById('netSalary').textContent = `Rs.${netSalary.toLocaleString()}`;
                
                console.log('UI updated successfully');
            } catch (error) {
                console.error('Error updating UI:', error);
            }
            
            // Store calculation data for PDF generation
            window.salaryData = {
                grossSalary,
                basicSalary,
                hra,
                transportAllowance,
                medicalAllowance,
                otherAllowancesInput,
                bonus,
                bonusDesc,
                incentives,
                incentivesDesc,
                totalEarnings,
                pfAmount,
                esicAmount,
                absentCut,
                otherDeductions,
                deductionDesc,
                totalDeductionsAmount,
                netSalary,
                unpaidAbsentDays,
                totalDays,
                presentDays: totalDays - unpaidAbsentDays,
                enablePF,
                enableESIC,
                breakdownTotal
            };
            
            console.log('Salary calculation completed:', window.salaryData);
            showAlert('Salary calculated successfully!', 'success');
        }
        
        // Generate individual salary slip PDF
        function generateSalarySlip() {
            console.log('Generate salary slip function called');
            
            const employeeSelect = document.getElementById('salaryEmployee');
            const monthInput = document.getElementById('salaryMonth');
            
            console.log('Employee selected:', employeeSelect?.value);
            console.log('Month selected:', monthInput?.value);
            console.log('Salary data available:', !!window.salaryData);
            
            if (!employeeSelect || !employeeSelect.value) {
                showAlert('Please select an employee first', 'error');
                return;
            }
            
            if (!monthInput || !monthInput.value) {
                showAlert('Please select a month first', 'error');
                return;
            }
            
            if (!window.salaryData) {
                showAlert('Please calculate salary first before generating PDF', 'error');
                return;
            }
            
            try {
                // Check if jsPDF is available
                if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
                    showAlert('PDF library not loaded. Please refresh the page and try again.', 'error');
                    console.error('jsPDF not available:', typeof window.jspdf);
                    return;
                }
                
                const employeeData = JSON.parse(employeeSelect.selectedOptions[0].dataset.employee);
                const month = monthInput.value;
                
                console.log('Employee data:', employeeData);
                console.log('Month:', month);
                console.log('jsPDF available:', typeof window.jspdf.jsPDF);
                console.log('Starting PDF generation...');
                
                // Show loading message
                showAlert('Generating PDF... Please wait', 'success');
                
                // Add small delay to show loading message
                setTimeout(() => {
                    try {
                        generateSalarySlipPDF(employeeData, month, window.salaryData);
                    } catch (pdfError) {
                        console.error('PDF generation error:', pdfError);
                        showAlert('PDF generation failed: ' + pdfError.message, 'error');
                    }
                }, 100);
                
            } catch (error) {
                console.error('Error in generateSalarySlip:', error);
                showAlert('Error generating salary slip: ' + error.message, 'error');
            }
        }
        
        // Generate minimal professional salary slip PDF
        function generateSalarySlipPDF(employee, month, salaryData) {
            console.log('Creating minimal professional PDF for:', employee.name);
            
            try {
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('jsPDF library not loaded');
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('portrait', 'mm', 'a4');
                
                // Month formatting
                const monthNames = ["January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"];
                const [year, monthNum] = month.split('-');
                const monthName = monthNames[parseInt(monthNum) - 1];
                
                // ========== MINIMAL HEADER ==========
                // Very light blue header
                doc.setFillColor(240, 248, 255);
                doc.rect(0, 0, 210, 18, 'F');
                
                // Company name (clean)
                doc.setTextColor(70, 100, 130);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('TRIVANTA EDGE', 15, 10);
                
                // Salary slip title
                doc.setFontSize(12);
                doc.text('SALARY SLIP', 150, 7);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text(`${monthName} ${year}`, 150, 12);
                
                // Minimal tagline
                doc.setFontSize(7);
                doc.setTextColor(130, 130, 130);
                doc.text('Technology Solutions & Digital Innovation', 15, 14);
                
                // Contact info
                doc.setFontSize(6);
                doc.text('contact@trivantaedge.com  |  +91-9373015503', 15, 25);
                
                // ========== EMPLOYEE INFO ==========
                let y = 35;
                
                // Clean box
                doc.setDrawColor(220, 220, 220);
                doc.setLineWidth(0.3);
                doc.rect(15, y, 180, 22, 'S');
                
                // Header
                doc.setFillColor(248, 252, 255);
                doc.rect(15, y, 180, 5, 'F');
                doc.setTextColor(70, 100, 130);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.text('EMPLOYEE INFORMATION', 17, y + 3);
                
                // Details (two columns)
                doc.setTextColor(60, 60, 60);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                
                y += 8;
                doc.text(`Name: ${employee.name}`, 17, y);
                doc.text(`Working Days: ${salaryData.totalDays}`, 110, y);
                
                y += 4;
                doc.text(`ID: ${employee.id}`, 17, y);
                doc.text(`Present: ${salaryData.presentDays}`, 110, y);
                
                y += 4;
                doc.text(`Designation: ${employee.designation || 'Employee'}`, 17, y);
                doc.text(`Absent: ${salaryData.totalDays - salaryData.presentDays}`, 110, y);
                
                y += 12;
                
                // ========== EARNINGS ==========
                // Light blue header
                doc.setFillColor(245, 250, 255);
                doc.rect(15, y, 180, 6, 'F');
                doc.setTextColor(70, 100, 130);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('EARNINGS', 17, y + 4);
                
                y += 8;
                
                // Table headers
                doc.setFillColor(252, 252, 252);
                doc.rect(15, y, 180, 4, 'F');
                doc.setTextColor(80, 80, 80);
                doc.setFontSize(7);
                doc.text('COMPONENT', 17, y + 3);
                doc.text('AMOUNT (Rs.)', 160, y + 3);
                
                y += 6;
                
                // Earnings rows
                doc.setTextColor(60, 60, 60);
                doc.setFont('helvetica', 'normal');
                
                const earnings = [
                    ['Basic Salary', salaryData.basicSalary],
                    ...(salaryData.hra > 0 ? [['HRA', salaryData.hra]] : []),
                    ...(salaryData.transportAllowance > 0 ? [['Transport', salaryData.transportAllowance]] : []),
                    ...(salaryData.medicalAllowance > 0 ? [['Medical', salaryData.medicalAllowance]] : []),
                    ...(salaryData.otherAllowancesInput > 0 ? [['Other Allowances', salaryData.otherAllowancesInput]] : []),
                ];
                
                earnings.forEach(([label, amount]) => {
                    doc.text(label, 17, y);
                    doc.text(amount.toLocaleString(), 160, y);
                    y += 4;
                });
                
                // Gross total
                doc.setFillColor(248, 252, 255);
                doc.rect(15, y, 180, 4, 'F');
                doc.setFont('helvetica', 'bold');
                doc.text('GROSS SALARY', 17, y + 3);
                doc.text(salaryData.grossSalary.toLocaleString(), 160, y + 3);
                y += 6;
                
                // Bonus/Incentives
                if (salaryData.bonus > 0 || salaryData.incentives > 0) {
                    doc.setFont('helvetica', 'normal');
                    if (salaryData.bonus > 0) {
                        doc.text('Bonus', 17, y);
                        doc.text(salaryData.bonus.toLocaleString(), 160, y);
                        y += 4;
                    }
                    if (salaryData.incentives > 0) {
                        doc.text('Incentives', 17, y);
                        doc.text(salaryData.incentives.toLocaleString(), 160, y);
                        y += 4;
                    }
                    
                    doc.setFillColor(245, 250, 255);
                    doc.rect(15, y, 180, 4, 'F');
                    doc.setFont('helvetica', 'bold');
                    doc.text('TOTAL EARNINGS', 17, y + 3);
                    doc.text(salaryData.totalEarnings.toLocaleString(), 160, y + 3);
                    y += 6;
                }
                
                y += 3;
                
                // ========== DEDUCTIONS (RED) ==========
                // Light red header
                doc.setFillColor(255, 245, 245);
                doc.rect(15, y, 180, 6, 'F');
                doc.setTextColor(180, 70, 70);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('DEDUCTIONS', 17, y + 4);
                
                y += 8;
                
                // Headers
                doc.setFillColor(252, 252, 252);
                doc.rect(15, y, 180, 4, 'F');
                doc.setTextColor(80, 80, 80);
                doc.setFontSize(7);
                doc.text('COMPONENT', 17, y + 3);
                doc.text('AMOUNT (Rs.)', 160, y + 3);
                
                y += 6;
                
                // Deductions
                doc.setTextColor(60, 60, 60);
                doc.setFont('helvetica', 'normal');
                
                const deductions = [
                    ...(salaryData.enablePF && salaryData.pfAmount > 0 ? [['PF (12%)', salaryData.pfAmount]] : []),
                    ...(salaryData.enableESIC && salaryData.esicAmount > 0 ? [['ESIC (0.75%)', salaryData.esicAmount]] : []),
                    ...(salaryData.unpaidAbsentDays > 0 ? [['Absent Days', salaryData.absentCut]] : []),
                    ...(salaryData.otherDeductions > 0 ? [['Other Deductions', salaryData.otherDeductions]] : []),
                ];
                
                if (deductions.length === 0) {
                    doc.text('No Deductions', 17, y);
                    doc.text('0', 160, y);
                    y += 4;
                } else {
                    deductions.forEach(([label, amount]) => {
                        doc.text(label, 17, y);
                        doc.text(amount.toLocaleString(), 160, y);
                        y += 4;
                    });
                }
                
                // Total deductions
                doc.setFillColor(255, 245, 245);
                doc.rect(15, y, 180, 4, 'F');
                doc.setTextColor(180, 70, 70);
                doc.setFont('helvetica', 'bold');
                doc.text('TOTAL DEDUCTIONS', 17, y + 3);
                doc.text(salaryData.totalDeductionsAmount.toLocaleString(), 160, y + 3);
                
                y += 10;
                
                // ========== NET SALARY ==========
                doc.setFillColor(245, 250, 255);
                doc.rect(15, y, 180, 10, 'F');
                doc.setDrawColor(150, 180, 210);
                doc.rect(15, y, 180, 10, 'S');
                
                doc.setTextColor(70, 100, 130);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('NET SALARY PAYABLE', 17, y + 4);
                doc.text(`Rs. ${salaryData.netSalary.toLocaleString()}`, 17, y + 8);
                
                y += 12;
                
                // Amount in words
                doc.setTextColor(120, 120, 120);
                doc.setFontSize(6);
                doc.setFont('helvetica', 'normal');
                doc.text(`(${numberToWords(salaryData.netSalary)} Rupees Only)`, 17, y);
                
                y += 8;
                
                // ========== FOOTER ==========
                doc.setTextColor(140, 140, 140);
                doc.setFontSize(5);
                doc.text('Computer-generated salary slip. No signature required.', 15, y);
                doc.text(`Generated: ${new Date().toLocaleDateString('en-IN')} | Trivanta Edge`, 15, y + 3);
                
                // Border
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.3);
                doc.rect(12, 3, 186, y + 5);
                
                // Save
                const fileName = `${employee.name}_Salary_${monthName}_${year}.pdf`;
                doc.save(fileName);
                
                showAlert('Minimal professional PDF generated!', 'success');
                
            } catch (error) {
                console.error('PDF Error:', error);
                showAlert('PDF generation failed: ' + error.message, 'error');
            }
        }
        
        // Number to words converter function
        function numberToWords(num) {
            if (num === 0) return 'Zero';
            
            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            
            function convertHundreds(n) {
                let result = '';
                
                if (n >= 100) {
                    result += ones[Math.floor(n / 100)] + ' Hundred ';
                    n %= 100;
                }
                
                if (n >= 20) {
                    result += tens[Math.floor(n / 10)] + ' ';
                    n %= 10;
                } else if (n >= 10) {
                    result += teens[n - 10] + ' ';
                    n = 0;
                }
                
                if (n > 0) {
                    result += ones[n] + ' ';
                }
                
                return result;
            }
            
            function convertIndianNumber(num) {
                if (num === 0) return 'Zero';
                
                let result = '';
                
                // Crores
                if (num >= 10000000) {
                    result += convertHundreds(Math.floor(num / 10000000)) + 'Crore ';
                    num %= 10000000;
                }
                
                // Lakhs
                if (num >= 100000) {
                    result += convertHundreds(Math.floor(num / 100000)) + 'Lakh ';
                    num %= 100000;
                }
                
                // Thousands
                if (num >= 1000) {
                    result += convertHundreds(Math.floor(num / 1000)) + 'Thousand ';
                    num %= 1000;
                }
                
                // Hundreds
                if (num > 0) {
                    result += convertHundreds(num);
                }
                
                return result.trim();
            }
            
            return convertIndianNumber(Math.floor(num));
        }
        
        // Generate salary slip PDF with Trivanta Edge branding
        
        // Generate bulk salary slips for all employees
        function generateBulkSalarySlips() {
            const monthInput = document.getElementById('salaryMonth');
            const grossSalaryInput = document.getElementById('grossSalary');
            
            if (!monthInput.value || !grossSalaryInput.value) {
                showAlert('Please select month and enter default gross salary', 'error');
                return;
            }
            
            showAlert('Generating salary slips for all employees... This may take a moment.', 'success');
            
            // Get all employees and generate slips
            db.collection('employees').get().then(snapshot => {
                snapshot.forEach(doc => {
                    const employee = doc.data();
                    // Use default salary for all employees in bulk generation
                    setTimeout(() => {
                        generateEmployeeSalarySlip(employee, monthInput.value, parseFloat(grossSalaryInput.value));
                    }, 1000); // Add delay to prevent browser freezing
                });
            });
        }
        
        // Generate salary slip for individual employee (used in bulk)
        function generateEmployeeSalarySlip(employee, month, grossSalary) {
            // Calculate attendance and generate slip
            const [year, monthNum] = month.split('-');
            const startDate = `${year}-${monthNum}-01`;
            const endDate = `${year}-${monthNum}-30`;
            
            let query = db.collection('attendance')
                .where('employeeId', '==', employee.id)
                .where('date', '>=', startDate)
                .where('date', '<=', endDate);
            
            query.get().then(snapshot => {
                let presentDays = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'Present') {
                        presentDays++;
                    }
                });
                
                const totalDays = 30;
                const absentDays = totalDays - presentDays;
                const unpaidAbsent = Math.max(0, absentDays - 2); // 2 paid leaves
                
                const basicPercent = parseFloat(document.getElementById('basicSalaryPercent').value) || 50;
                const enablePF = document.getElementById('enablePF').checked;
                const enableESIC = document.getElementById('enableESIC').checked;
                
                // Create salary data object with simplified structure
                const basicSalary = Math.round((grossSalary * basicPercent) / 100);
                const bonus = 0; // Default for bulk
                const incentives = 0; // Default for bulk
                const totalEarnings = grossSalary + bonus + incentives;
                
                let pfAmount = 0;
                let esicAmount = 0;
                
                if (enablePF) {
                    pfAmount = Math.round((basicSalary * 12) / 100);
                }
                
                if (enableESIC) {
                    esicAmount = Math.round((grossSalary * 0.75) / 100);
                }
                
                const absentCut = Math.round(unpaidAbsent * (grossSalary / totalDays));
                const totalDeductionsAmount = pfAmount + esicAmount + absentCut;
                const netSalary = totalEarnings - totalDeductionsAmount;
                
                const salaryData = {
                    grossSalary,
                    basicSalary,
                    bonus,
                    bonusDesc: '',
                    incentives,
                    incentivesDesc: '',
                    totalEarnings,
                    pfAmount,
                    esicAmount,
                    absentCut,
                    otherDeductions: 0,
                    deductionDesc: '',
                    totalDeductionsAmount,
                    netSalary,
                    unpaidAbsentDays: unpaidAbsent,
                    totalDays: totalDays,
                    presentDays: presentDays,
                    enablePF,
                    enableESIC
                };
                
                generateSalarySlipPDF(employee, month, salaryData);
            });
        }
        
        // Initialize salary section when page loads
        setTimeout(() => {
            loadSalaryEmployees();
            setDefaultSalaryMonth();
            
            // Add event listeners for real-time breakdown checking
            const grossSalaryInput = document.getElementById('grossSalary');
            const basicPercentInput = document.getElementById('basicSalaryPercent');
            const hraInput = document.getElementById('hra');
            const transportInput = document.getElementById('transportAllowance');
            const medicalInput = document.getElementById('medicalAllowance');
            const otherAllowancesInput = document.getElementById('otherAllowances');
            
            // Function to update breakdown total
            function updateBreakdownTotal() {
                const grossSalary = parseFloat(grossSalaryInput.value) || 0;
                const basicPercent = parseFloat(basicPercentInput.value) || 50;
                const basicSalary = Math.round((grossSalary * basicPercent) / 100);
                const hra = parseFloat(hraInput.value) || 0;
                const transport = parseFloat(transportInput.value) || 0;
                const medical = parseFloat(medicalInput.value) || 0;
                const otherAllowances = parseFloat(otherAllowancesInput.value) || 0;
                
                const breakdownTotal = basicSalary + hra + transport + medical + otherAllowances;
                
                // Update display
                document.getElementById('breakdownTotal').textContent = `Rs.${breakdownTotal.toLocaleString()}`;
                document.getElementById('grossSalaryDisplay').textContent = `Rs.${grossSalary.toLocaleString()}`;
                
                const balanceCheck = document.getElementById('balanceCheck');
                const difference = grossSalary - breakdownTotal;
                
                if (difference === 0) {
                    balanceCheck.innerHTML = '<span style="color: #27ae60;">‚úÖ Perfect! Breakdown matches gross salary</span>';
                } else if (difference > 0) {
                    balanceCheck.innerHTML = `<span style="color: #f39c12;">‚ö†Ô∏è Remaining: Rs.${difference.toLocaleString()} (Add to allowances)</span>`;
                } else {
                    balanceCheck.innerHTML = `<span style="color: #e74c3c;">‚ùå Excess: Rs.${Math.abs(difference).toLocaleString()} (Reduce allowances)</span>`;
                }
            }
            
            // Add event listeners
            [grossSalaryInput, basicPercentInput, hraInput, transportInput, medicalInput, otherAllowancesInput].forEach(input => {
                if (input) {
                    input.addEventListener('input', updateBreakdownTotal);
                    input.addEventListener('blur', updateBreakdownTotal);
                }
            });
            
            // Auto-calculate when present days change
            const presentDaysInput = document.getElementById('presentDaysInput');
            const totalWorkingDaysInput = document.getElementById('totalWorkingDays');
            const leavesUsedInput = document.getElementById('leavesUsedInput');
            
            if (presentDaysInput && totalWorkingDaysInput) {
                presentDaysInput.addEventListener('input', function() {
                    const totalDays = parseInt(totalWorkingDaysInput.value) || 30;
                    const presentDays = parseInt(this.value) || 0;
                    const absentDays = Math.max(0, totalDays - presentDays);
                    
                    // Auto-fill leaves used (up to 2)
                    if (leavesUsedInput && !leavesUsedInput.value) {
                        const suggestedLeaves = Math.min(absentDays, 2);
                        leavesUsedInput.value = suggestedLeaves;
                    }
                });
            }
            
            // Add event listener as backup for calculate salary button
            const calculateBtn = document.querySelector('button[onclick="calculateSalary()"]');
            if (calculateBtn) {
                console.log('Calculate salary button found, adding event listener');
                calculateBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Calculate salary button clicked via event listener');
                    calculateSalary();
                });
            } else {
                console.error('Calculate salary button not found');
            }
        }, 1500);
        
        // Helper function to set default attendance values
        function setDefaultAttendance() {
            document.getElementById('totalWorkingDays').value = 30;
            document.getElementById('presentDaysInput').value = 28;
            document.getElementById('paidLeavesAvailable').value = 2;
            document.getElementById('leavesUsedInput').value = 2;
            showAlert('Default attendance values set', 'success');
        }
        
        // Helper function to auto-distribute gross salary
        function autoDistributeGross() {
            const grossSalary = parseFloat(document.getElementById('grossSalary').value);
            if (!grossSalary || grossSalary <= 0) {
                showAlert('Please enter gross salary first', 'error');
                return;
            }
            
            const basicPercent = parseFloat(document.getElementById('basicSalaryPercent').value) || 50;
            const basicSalary = Math.round((grossSalary * basicPercent) / 100);
            const remaining = grossSalary - basicSalary;
            
            // Auto-distribute remaining amount
            const hraAmount = Math.round(remaining * 0.5); // 50% of remaining to HRA
            const transportAmount = Math.round(remaining * 0.2); // 20% to transport
            const medicalAmount = Math.round(remaining * 0.15); // 15% to medical
            const otherAmount = remaining - hraAmount - transportAmount - medicalAmount; // Rest to other
            
            document.getElementById('hra').value = hraAmount;
            document.getElementById('transportAllowance').value = transportAmount;
            document.getElementById('medicalAllowance').value = medicalAmount;
            document.getElementById('otherAllowances').value = Math.max(0, otherAmount);
            
            // Trigger update
            const event = new Event('input');
            document.getElementById('hra').dispatchEvent(event);
            
            showAlert('Gross salary auto-distributed successfully!', 'success');
        }
        
        // Test function to verify salary calculation works
        window.testSalaryCalculation = function() {
            console.log('Testing salary calculation...');
            calculateSalaryBreakdown(30000, 2, 30); // Test with dummy data
        };
        
        // Test PDF generation function
        function testPDFGeneration() {
            console.log('Testing PDF generation...');
            
            const debugDiv = document.getElementById('debugOutput');
            const debugText = document.getElementById('debugText');
            debugDiv.style.display = 'block';
            
            let output = 'PDF GENERATION TEST:<br>';
            
            // Check jsPDF availability
            if (typeof window.jspdf === 'undefined') {
                output += 'jsPDF: NOT LOADED ‚ùå<br>';
                output += 'Solution: Check if jsPDF library is properly loaded<br>';
            } else {
                output += 'jsPDF: LOADED ‚úÖ<br>';
                
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Add simple test content
                    doc.setFontSize(16);
                    doc.text('TEST PDF GENERATION', 20, 20);
                    doc.text('This is a test to verify PDF generation works', 20, 40);
                    doc.text('Generated on: ' + new Date().toLocaleString(), 20, 60);
                    
                    // Try to save
                    doc.save('test_pdf_generation.pdf');
                    
                    output += 'Test PDF Generation: SUCCESS ‚úÖ<br>';
                    output += 'Test PDF should have downloaded<br>';
                    
                } catch (error) {
                    output += 'Test PDF Generation: FAILED ‚ùå<br>';
                    output += 'Error: ' + error.message + '<br>';
                }
            }
            
            // Check other requirements
            const employeeSelect = document.getElementById('salaryEmployee');
            const monthInput = document.getElementById('salaryMonth');
            
            output += '<br>SALARY SLIP REQUIREMENTS:<br>';
            output += 'Employee Selected: ' + (employeeSelect?.value ? 'YES ‚úÖ' : 'NO ‚ùå') + '<br>';
            output += 'Month Selected: ' + (monthInput?.value ? 'YES ‚úÖ' : 'NO ‚ùå') + '<br>';
            output += 'Salary Data Available: ' + (window.salaryData ? 'YES ‚úÖ' : 'NO ‚ùå') + '<br>';
            
            if (employeeSelect?.value) {
                try {
                    const empData = JSON.parse(employeeSelect.selectedOptions[0].dataset.employee);
                    output += 'Employee Data: ' + JSON.stringify(empData) + '<br>';
                } catch (e) {
                    output += 'Employee Data: INVALID ‚ùå<br>';
                }
            }
            
            debugText.innerHTML = output;
        }
        
        // Force calculation with dummy data
        function forceCalculateTest() {
            console.log('Force calculate test...');
            
            // Set dummy values
            const empSelect = document.getElementById('salaryEmployee');
            const monthInput = document.getElementById('salaryMonth');
            const grossInput = document.getElementById('grossSalary');
            
            if (monthInput && !monthInput.value) {
                monthInput.value = '2024-11';
            }
            
            if (grossInput && !grossInput.value) {
                grossInput.value = '25000';
            }
            
            // Simulate attendance data
            calculateSalaryBreakdown(25000, 2, 30);
            
            // Update attendance summary manually
            document.getElementById('totalDays').textContent = '30';
            document.getElementById('presentDays').textContent = '28';
            document.getElementById('absentDays').textContent = '2';
            document.getElementById('leavesUsed').textContent = '2';
        }
        
        // Test PDF generation function
        function testPDFGeneration() {
            console.log('Testing PDF generation...');
            
            // Check if jsPDF is loaded
            console.log('jsPDF available:', typeof window.jspdf);
            console.log('jsPDF constructor:', typeof window.jspdf?.jsPDF);
            
            if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
                showAlert('jsPDF library not loaded! Please refresh the page.', 'error');
                return;
            }
            
            try {
                // Create a simple test PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(20);
                doc.text('PDF Generation Test', 20, 20);
                doc.setFontSize(12);
                doc.text('If you can see this PDF, the library is working!', 20, 40);
                doc.text(`Test date: ${new Date().toLocaleString()}`, 20, 60);
                
                doc.save('test_pdf.pdf');
                showAlert('Test PDF generated successfully! jsPDF is working.', 'success');
                
            } catch (error) {
                console.error('PDF test error:', error);
                showAlert('PDF test failed: ' + error.message, 'error');
            }
        }
        
        // ======================= END SALARY SLIP FUNCTIONS =======================
    </script>
</body>
</html>